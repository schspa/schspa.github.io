<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-03-03 Thu 11:48 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux Signal Handle</title>
<meta name="author" content="Schspa" />
<meta name="description" content="security.org" />
<meta name="keywords" content="Security" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">Linux Signal Handle</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#linux-signal-handle">1. Linux signal handle</a></li>
<li><a href="#æçº²">2. æçº²ï¼š</a>
<ul>
<li><a href="#man-pages">2.1. man pages</a></li>
</ul>
</li>
<li><a href="#ä¿¡å·åŸºæœ¬æ¦‚å¿µä»¥åŠå®šä¹‰">3. ä¿¡å·åŸºæœ¬æ¦‚å¿µä»¥åŠå®šä¹‰</a>
<ul>
<li><a href="#signalè®¾è®¡ç›®çš„">3.1. Signalè®¾è®¡ç›®çš„</a></li>
<li><a href="#linux-ä¿¡å·å®šä¹‰">3.2. 1. Linux ä¿¡å·å®šä¹‰</a></li>
</ul>
</li>
<li><a href="#ä¿¡å·å‘é€">4. ä¿¡å·å‘é€</a>
<ul>
<li><a href="#å†…æ ¸ä¸­ä¿¡å·å‘é€æµç¨‹">4.1. å†…æ ¸ä¸­ä¿¡å·å‘é€æµç¨‹</a>
<ul>
<li><a href="#alloc-sigqueue-ç»“æ„é¢˜">4.1.1. alloc sigqueue ç»“æ„é¢˜</a></li>
</ul>
</li>
<li><a href="#ä¿¡å·æ¥æ”¶">4.2. ä¿¡å·æ¥æ”¶</a>
<ul>
<li><a href="#ä¿¡å·å¤„ç†é€”å¾„">4.2.1. ä¿¡å·å¤„ç†é€”å¾„</a></li>
<li><a href="#do_signal_stopæµç¨‹-sigstop">4.2.2. do_signal_stopæµç¨‹ (SIGSTOP)</a></li>
<li><a href="#killæµç¨‹-sigkill">4.2.3. killæµç¨‹ (SIGKILL)</a></li>
<li><a href="#segvæµç¨‹">4.2.4. SEGVæµç¨‹</a></li>
<li><a href="#signalè°ƒè¯•">4.2.5. Signalè°ƒè¯•</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-linux-signal-handle" class="outline-2">
<h2 id="linux-signal-handle"><span class="section-number-2">1.</span> Linux signal handle</h2>
<div class="outline-text-2" id="text-linux-signal-handle">
</div>
</div>

<div id="outline-container-æçº²" class="outline-2">
<h2 id="æçº²"><span class="section-number-2">2.</span> æçº²ï¼š</h2>
<div class="outline-text-2" id="text-æçº²">
<ul class="org-ul">
<li>ä¿¡å·åŸºæœ¬æ¦‚å¿µä»¥åŠå®šä¹‰<br></li>
<li>ä¿¡å·å‘é€<br></li>
<li>ä¿¡å·æ¥æ”¶<br></li>
<li>SIGSTOPæµç¨‹<br></li>
<li>SIGKILLæµç¨‹<br></li>
<li>SIGSEGVæµç¨‹<br></li>
</ul>
</div>

<div id="outline-container-man-pages" class="outline-3">
<h3 id="man-pages"><span class="section-number-3">2.1.</span> <a href="http://man7.org/linux/man-pages/man7/signal.7.html">man pages</a></h3>
<div class="outline-text-3" id="text-man-pages">
</div>
</div>
</div>

<div id="outline-container-ä¿¡å·åŸºæœ¬æ¦‚å¿µä»¥åŠå®šä¹‰" class="outline-2">
<h2 id="ä¿¡å·åŸºæœ¬æ¦‚å¿µä»¥åŠå®šä¹‰"><span class="section-number-2">3.</span> ä¿¡å·åŸºæœ¬æ¦‚å¿µä»¥åŠå®šä¹‰</h2>
<div class="outline-text-2" id="text-ä¿¡å·åŸºæœ¬æ¦‚å¿µä»¥åŠå®šä¹‰">
</div>

<div id="outline-container-signalè®¾è®¡ç›®çš„" class="outline-3">
<h3 id="signalè®¾è®¡ç›®çš„"><span class="section-number-3">3.1.</span> Signalè®¾è®¡ç›®çš„</h3>
<div class="outline-text-3" id="text-signalè®¾è®¡ç›®çš„">
<ul class="org-ul">
<li>siganlæä¾›ä¸€ä¸ªåŸºç¡€çš„å¼‚æ­¥é€šçŸ¥æœºåˆ¶è€Œè®¾è®¡<br></li>
<li>signalæ˜¯ä¸€ç§IPCæ‰‹æ®µ<br></li>
</ul>
<p>
ä¸å…¶ä»–IPCæ‰‹æ®µä¸åŒçš„æ˜¯ï¼Œä¸éœ€è¦ä¸“é—¨çš„çº¿ç¨‹blockä½å»ç­‰å¾…æ¶ˆæ¯<br>
</p>
</div>
</div>

<div id="outline-container-linux-ä¿¡å·å®šä¹‰" class="outline-3">
<h3 id="linux-ä¿¡å·å®šä¹‰"><span class="section-number-3">3.2.</span> 1. Linux ä¿¡å·å®šä¹‰</h3>
<div class="outline-text-3" id="text-linux-ä¿¡å·å®šä¹‰">
<p>
<a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/asm-generic/signal.h">include/uapi/asm-generic/signal.h</a><br>
</p>

<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">_NSIG</span>       64</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">_NSIG_BPW</span>   __BITS_PER_LONG</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">_NSIG_WORDS</span> (_NSIG / _NSIG_BPW)</code>
<code></code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGHUP</span>       1</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGINT</span>       2</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGQUIT</span>      3</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGILL</span>       4</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGTRAP</span>      5</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGABRT</span>      6</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGIOT</span>       6</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGBUS</span>       7</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGFPE</span>       8</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGKILL</span>      9</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGUSR1</span>     10</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGSEGV</span>     11</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGUSR2</span>     12</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGPIPE</span>     13</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGALRM</span>     14</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGTERM</span>     15</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGSTKFLT</span>   16</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGCHLD</span>     17</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGCONT</span>     18</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGSTOP</span>     19</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGTSTP</span>     20</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGTTIN</span>     21</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGTTOU</span>     22</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGURG</span>      23</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGXCPU</span>     24</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGXFSZ</span>     25</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGVTALRM</span>   26</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGPROF</span>     27</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGWINCH</span>    28</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGIO</span>       29</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGPOLL</span>     SIGIO</code>
<code><span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;">#define SIGLOST     29</span></code>
<code><span style="color: #5B6268;">*/</span></code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGPWR</span>      30</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGSYS</span>      31</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGUNUSED</span>   31</code>
<code></code>
<code><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">These should not be considered constants from userland.</span><span style="color: #5B6268;">  */</span></code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGRTMIN</span>    32</code>
<code><span style="color: #51afef; font-weight: bold;">#if</span><span style="color: #51afef; font-weight: bold;">n</span><span style="color: #51afef; font-weight: bold;">def</span> SIGRTMAX</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #dcaeea;">SIGRTMAX</span>    _NSIG</code>
<code><span style="color: #51afef; font-weight: bold;">#endif</span></code>
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="å†…æ ¸ç›¸å…³ç»“æ„ä½“"></a>å†…æ ¸ç›¸å…³ç»“æ„ä½“<br>
<div class="outline-text-5" id="text-å†…æ ¸ç›¸å…³ç»“æ„ä½“">
<p>
Signal å†…éƒ¨æ•°æ®ç»“æ„<br>
</p>

<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">task_struct</span> {</code>
<code>  <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Signal handlers:</span><span style="color: #5B6268;"> */</span></code>
<code>  <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">signal_struct</span>      *<span style="color: #dcaeea;">signal</span>;    <span style="color: #5B6268;">//</span><span style="color: #5B6268;">&#21516;&#19968;&#32447;&#31243;&#32452;&#20849;&#26377;&#30340;sigpending&#38142;&#34920;</span></code>
<code>  <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">sighand_struct</span>     *<span style="color: #dcaeea;">sighand</span>;</code>
<code>  <span style="color: #ECBE7B;">sigset_t</span>          <span style="color: #dcaeea;">blocked</span>;</code>
<code>  <span style="color: #ECBE7B;">sigset_t</span>          <span style="color: #dcaeea;">real_blocked</span>;</code>
<code>  <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Restored if set_restore_sigmask() was used:</span><span style="color: #5B6268;"> */</span></code>
<code>  <span style="color: #ECBE7B;">sigset_t</span>          <span style="color: #dcaeea;">saved_sigmask</span>;</code>
<code>  <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">sigpending</span>     <span style="color: #dcaeea;">pending</span>;        <span style="color: #5B6268;">//</span><span style="color: #5B6268;">&#31169;&#26377;&#30340;sigpending&#38142;&#34920;</span></code>
<code>  <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span>         <span style="color: #dcaeea;">sas_ss_sp</span>;</code>
<code>  <span style="color: #ECBE7B;">size_t</span>                <span style="color: #dcaeea;">sas_ss_size</span>;</code>
<code>  <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">int</span>          <span style="color: #dcaeea;">sas_ss_flags</span>;</code>
<code>}&#65307;</code>
<code></code>
<code><span style="color: #51afef;">struct</span> signal_struct {</code>
<code>    <span style="color: #ECBE7B;">atomic_t</span>        <span style="color: #dcaeea;">sigcnt</span>;</code>
<code>    <span style="color: #ECBE7B;">atomic_t</span>        <span style="color: #dcaeea;">live</span>;</code>
<code>    <span style="color: #ECBE7B;">int</span>         <span style="color: #dcaeea;">nr_threads</span>;</code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">list_head</span>    <span style="color: #dcaeea;">thread_head</span>;</code>
<code></code>
<code>    <span style="color: #ECBE7B;">wait_queue_head_t</span>   <span style="color: #dcaeea;">wait_chldexit</span>;  <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">for wait4()</span><span style="color: #5B6268;"> */</span></code>
<code>  <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">shared signal handling:</span><span style="color: #5B6268;"> */</span></code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">sigpending</span>   <span style="color: #dcaeea;">shared_pending</span>;</code>
<code></code>
<code>    <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">thread group exit support</span><span style="color: #5B6268;"> */</span></code>
<code>    <span style="color: #ECBE7B;">int</span>         <span style="color: #dcaeea;">group_exit_code</span>;</code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">task_struct</span>  *<span style="color: #dcaeea;">group_exit_task</span>;</code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">rlimit</span> <span style="color: #dcaeea;">rlim</span>[RLIM_NLIMITS];</code>
<code>}&#65307;</code>
<code></code>
<code><span style="color: #51afef;">struct</span> sigpending {</code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">list_head</span> <span style="color: #dcaeea;">list</span>;</code>
<code>    <span style="color: #ECBE7B;">sigset_t</span> <span style="color: #dcaeea;">signal</span>;</code>
<code>};</code>
<code></code>
<code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">sigqueue</span> {</code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">list_head</span> <span style="color: #dcaeea;">list</span>;</code>
<code>    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">flags</span>;</code>
<code>    <span style="color: #ECBE7B;">siginfo_t</span> <span style="color: #dcaeea;">info</span>;</code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">user_struct</span> *<span style="color: #dcaeea;">user</span>;</code>
<code>};</code>
<code></code>
<code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">sighand_struct</span> {</code>
<code>    <span style="color: #ECBE7B;">atomic_t</span>        <span style="color: #dcaeea;">count</span>;</code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">k_sigaction</span>  <span style="color: #dcaeea;">action</span>[_NSIG];</code>
<code>    <span style="color: #ECBE7B;">spinlock_t</span>      <span style="color: #dcaeea;">siglock</span>;</code>
<code>    <span style="color: #ECBE7B;">wait_queue_head_t</span>   <span style="color: #dcaeea;">signalfd_wqh</span>;</code>
<code>};</code>
</pre>
</div>

<p>
<img src="http://on-img.com/chart_image/5b50a492e4b0be50eab7a65a.png?_=1532930354799" alt="5b50a492e4b0be50eab7a65a.png?_=1532930354799"><br>
&gt; sigset_t: bitmap for signal state<br>
</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-ä¿¡å·å‘é€" class="outline-2">
<h2 id="ä¿¡å·å‘é€"><span class="section-number-2">4.</span> ä¿¡å·å‘é€</h2>
<div class="outline-text-2" id="text-ä¿¡å·å‘é€">
<ol class="org-ol">
<li><a href="http://man7.org/linux/man-pages/man3/raise.3.html">raise(3)</a><br>
å‘é€ä¿¡å·ç»™å½“å‰çº¿ç¨‹<br></li>

<li><a href="http://man7.org/linux/man-pages/man2/kill.2.html">kill(2)</a><br>
å‘é€ç»™ç‰¹å®šè¿›ç¨‹ï¼Œè¿›ç¨‹ç»„ï¼Œæˆ–å…¨éƒ¨è¿›ç¨‹<br></li>

<li><a href="http://man7.org/linux/man-pages/man3/killpg.3.html">killpg(3)</a><br>
å‘é€ç»™è¿›ç¨‹ç»„<br></li>

<li><a href="http://man7.org/linux/man-pages/man3/pthread_kill.3.html">pthread_kill(3)</a><br>
å‘é€ç»™æŒ‡å®šçº¿ç¨‹<br></li>

<li><a href="http://man7.org/linux/man-pages/man2/tgkill.2.html">tgkill(2)</a><br>
å‘é€ç»™æŒ‡å®šçº¿ç¨‹ï¼Œé€šå¸¸ç”¨æ¥å®ç°pthread_kill<br></li>

<li><a href="http://man7.org/linux/man-pages/man3/sigqueue.3.html">sigqueue(3)</a><br>
å‘é€ä¿¡å·ç»™æŒ‡å®šè¿›ç¨‹ï¼Œå¯ä»¥æºå¸¦ä¸€ä¸ªintï¼Œæˆ–è€…æŒ‡é’ˆç±»å‹æ•°æ®ã€‚<br>
<a href="https://www.cnblogs.com/mickole/p/3191804.html">sigqueueç¼–ç¨‹ç¤ºä¾‹</a><br></li>
</ol>
</div>

<div id="outline-container-å†…æ ¸ä¸­ä¿¡å·å‘é€æµç¨‹" class="outline-3">
<h3 id="å†…æ ¸ä¸­ä¿¡å·å‘é€æµç¨‹"><span class="section-number-3">4.1.</span> å†…æ ¸ä¸­ä¿¡å·å‘é€æµç¨‹</h3>
<div class="outline-text-3" id="text-å†…æ ¸ä¸­ä¿¡å·å‘é€æµç¨‹">

<div id="org6b625ab" class="figure">
<p><img src="assets/linux-send-signal-flow.png" alt="linux-send-signal-flow.png"><br>
</p>
</div>

<p>
ä¸ç®¡ä»å“ªæ¡è·¯å¾„å‘é€ä¿¡å·ï¼Œæœ€ç»ˆå…¥å£éƒ½æ˜¯__send_signal<br>
</p>
</div>

<div id="outline-container-alloc-sigqueue-ç»“æ„é¢˜" class="outline-4">
<h4 id="alloc-sigqueue-ç»“æ„é¢˜"><span class="section-number-4">4.1.1.</span> alloc sigqueue ç»“æ„é¢˜</h4>
<div class="outline-text-4" id="text-alloc-sigqueue-ç»“æ„é¢˜">
<p>
æ³¨ï¼š allocå¤±è´¥æ—¶ï¼Œå†…æ ¸å‘è¿›ç¨‹å‘é€çš„ä¿¡å·å¯ä»¥é¡ºåˆ©å‘é€ ### taské€‰æ‹© ###<br>
complete_signalå‡½æ•° 1. ä¼˜å…ˆç»™ä¸»çº¿ç¨‹ 2. åœ¨æ‰€æœ‰çº¿ç¨‹ä¸­æŸ¥æ‰¾å¯ä»¥æ³¨å†Œçš„çº¿ç¨‹<br>
### åœ¨åŠ å…¥ä¿¡å·é“¾è¡¨ï¼Œè®¾ç½®å¯¹åº”çš„bitmapä¹‹åè¿”å› ###<br>
</p>
</div>
</div>
</div>

<div id="outline-container-ä¿¡å·æ¥æ”¶" class="outline-3">
<h3 id="ä¿¡å·æ¥æ”¶"><span class="section-number-3">4.2.</span> ä¿¡å·æ¥æ”¶</h3>
<div class="outline-text-3" id="text-ä¿¡å·æ¥æ”¶">
<ol class="org-ol">
<li>sig_action è®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°<br></li>
<li>sigwait åŒæ­¥ç­‰å¾…ä¿¡å·<br></li>
<li>sigsuspend åŒæ­¥ç­‰å¾…ä¿¡å·ï¼Œä»…ä¸€æ¬¡<br></li>
<li>sigblock é˜»å¡ä¿¡å·<br></li>
<li>siginterrupt æ›´æ”¹restart_systemcallè¡Œä¸ºï¼Œé»˜è®¤falseï¼ˆ0ï¼‰<br></li>
<li>sigpause åºŸå¼ƒ,ç”¨sigsuspend<br></li>
</ol>
</div>

<div id="outline-container-ä¿¡å·å¤„ç†é€”å¾„" class="outline-4">
<h4 id="ä¿¡å·å¤„ç†é€”å¾„"><span class="section-number-4">4.2.1.</span> ä¿¡å·å¤„ç†é€”å¾„</h4>
<div class="outline-text-4" id="text-ä¿¡å·å¤„ç†é€”å¾„">
<ul class="org-ul">
<li>Kernel handler<br></li>

<li>å¦‚æœè¿›ç¨‹æ²¡æœ‰å®ç°ä¿¡å·å¤„ç†å‡½æ•°ï¼Œåˆ™ç”±å†…æ ¸é»˜è®¤å¤„ç†å‡½æ•°å¤„ç†<br></li>
<li>éƒ¨åˆ†ä¿¡å·ï¼ˆSIGSTOPï¼ŒSIGKILLï¼‰ç”¨æˆ·è¿›ç¨‹æ— æƒè®¾ç½®å¤„ç†å‡½æ•°ï¼Œä¹Ÿä¸èƒ½block<br></li>

<li>Process defined handler<br></li>

<li>å¦‚æœè®¾ç½®äº†ä¿¡å·å¤„ç†å‡½æ•°ï¼Œåˆ™å¯ä»¥è·³è½¬åˆ°è‡ªå·±å¤„ç†å‡½æ•°æ‰§è¡Œ<br></li>

<li>Ignore<br></li>

<li>è¿›ç¨‹è®¾ç½®å¿½ç•¥ä¿¡å·<br></li>
</ul>
</div>

<ul class="org-ul">
<li><a id="kernel-handler"></a>Kernel handler<br>
<div class="outline-text-5" id="text-kernel-handler">
<ul class="org-ul">
<li>Ignore<br></li>
<li>Terminate<br></li>
<li>Coredump<br></li>
<li>Stop<br></li>
</ul>

<pre class="example" id="org5069f8b">
<code>â€œ +--------------------+------------------+</code>
<code> * | POSIX signal     | default action |</code>
<code> * +------------------+------------------+</code>
<code> * | SIGHUP           | terminate</code>
<code> * | SIGINT           | terminate</code>
<code> * | SIGQUIT          | coredump</code>
<code> * | SIGILL           | coredump</code>
<code> * | SIGTRAP          | coredump</code>
<code> * | SIGABRT/SIGIOT   | coredump</code>
<code> * | SIGBUS           | coredump</code>
<code> * | SIGFPE           | coredump</code>
<code> * | SIGKILL          | terminate</code>
<code> * | SIGUSR1          | terminate</code>
<code> * | SIGSEGV          | coredump</code>
<code> * | SIGUSR2          | terminate</code>
<code> * | SIGPIPE          | terminate</code>
<code> * | SIGALRM          | terminate</code>
<code> * | SIGTERM          | terminate</code>
<code> * | SIGCHLD          | ignore</code>
<code> * | SIGCONT          | ignore</code>
<code> * | SIGSTOP          | stop</code>
<code> * | SIGTSTP          | stop</code>
<code> * | SIGTTIN          | stop</code>
<code> * | SIGTTOU          | stop</code>
<code> * | SIGURG           | ignore</code>
<code> * | SIGXCPU          | coredump</code>
<code> * | SIGXFSZ          | coredump</code>
<code> * | SIGVTALRM        | terminate</code>
<code> * | SIGPROF          | terminate</code>
<code> * | SIGPOLL/SIGIO    | terminate</code>
<code> * | SIGSYS/SIGUNUSED | coredump</code>
<code> * | SIGSTKFLT        | terminate</code>
<code> * | SIGWINCH         | ignore</code>
<code> * | SIGPWR           | terminate</code>
<code> * | SIGRTMIN-SIGRTMAX| terminate</code>
<code> * +------------------+------------------+</code>
<code> * | non-POSIX signal | default action |</code>
<code> * +------------------+------------------+</code>
<code> * | SIGEMT           | coredump |</code>
<code> * +--------------------+------------------+â€</code>
</pre>

<blockquote>
<p>
æ‘˜å½•æ¥è‡ª: Raghu Bharadwaj. "Mastering Linux Kernel Development: A<br>
kernel developer's reference manualã€‚" iBooks.<br>
</p>
</blockquote>


<div id="orgbf94ddc" class="figure">
<p><img src="assets/signal-send-process.png" alt="signal-send-process.png"><br>
</p>
</div>
</div>
</li>

<li><a id="process-defined-handler"></a>Process defined handler<br>
<div class="outline-text-5" id="text-process-defined-handler">

<div id="org41f41a0" class="figure">
<p><img src="assets/2020-09-09_16-27-04_screenshot.png" alt="2020-09-09_16-27-04_screenshot.png"><br>
</p>
</div>
<blockquote>
<p>
æ‘˜å½•æ¥è‡ª: Raghu Bharadwaj. "Mastering Linux Kernel Development: A kernel<br>
developer's reference manualã€‚" iBooks.<br>
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-do_signal_stopæµç¨‹-sigstop" class="outline-4">
<h4 id="do_signal_stopæµç¨‹-sigstop"><span class="section-number-4">4.2.2.</span> do_signal_stopæµç¨‹ (SIGSTOP)</h4>
<div class="outline-text-4" id="text-do_signal_stopæµç¨‹-sigstop">
<p>
main with flags:JOBCTL_STOP_PENDING, group_stop_count is threads thread1<br>
wakeup with JOBCTL_STOP_DEQUEUED thread2 wakeup with<br>
JOBCTL_STOP_DEQUEUED do_notify_parent_cldstop //last one send this<br>
signal<br>
</p>


<div id="orge782f3d" class="figure">
<p><img src="assets/do-signal-stop.png" alt="do-signal-stop.png"><br>
</p>
</div>


<div id="org1832f36" class="figure">
<p><img src="assets/do-signal-d-stop.png" alt="do-signal-d-stop.png"><br>
</p>
</div>
</div>
</div>

<div id="outline-container-killæµç¨‹-sigkill" class="outline-4">
<h4 id="killæµç¨‹-sigkill"><span class="section-number-4">4.2.3.</span> killæµç¨‹ (SIGKILL)</h4>
<div class="outline-text-4" id="text-killæµç¨‹-sigkill">

<div id="org828fa82" class="figure">
<p><img src="assets/linux-sigkill-process.png" alt="linux-sigkill-process.png"><br>
</p>
</div>
</div>
</div>

<div id="outline-container-segvæµç¨‹" class="outline-4">
<h4 id="segvæµç¨‹"><span class="section-number-4">4.2.4.</span> SEGVæµç¨‹</h4>
<div class="outline-text-4" id="text-segvæµç¨‹">
</div>

<ul class="org-ul">
<li><a id="å¼‚å¸¸å¤„ç†è¡¨"></a>å¼‚å¸¸å¤„ç†è¡¨<br>
<div class="outline-text-5" id="text-å¼‚å¸¸å¤„ç†è¡¨">
<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #51afef;">static</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">fault_info</span> <span style="color: #dcaeea;">fault_info</span>[] = {</code>
<code>    { do_bad,       SIGKILL, SI_KERNEL, <span style="color: #98be65;">"ttbr address size fault"</span>   },</code>
<code>    { do_bad,       SIGKILL, SI_KERNEL, <span style="color: #98be65;">"level 1 address size fault"</span>    },</code>
<code>    { do_bad,       SIGKILL, SI_KERNEL, <span style="color: #98be65;">"level 2 address size fault"</span>    },</code>
<code>    { do_bad,       SIGKILL, SI_KERNEL, <span style="color: #98be65;">"level 3 address size fault"</span>    },</code>
<code>    { do_translation_fault, SIGSEGV, SEGV_MAPERR,   <span style="color: #98be65;">"level 0 translation fault"</span> },</code>
<code>    { do_translation_fault, SIGSEGV, SEGV_MAPERR,   <span style="color: #98be65;">"level 1 translation fault"</span> },</code>
<code>    { do_translation_fault, SIGSEGV, SEGV_MAPERR,   <span style="color: #98be65;">"level 2 translation fault"</span> },</code>
<code>    { do_translation_fault, SIGSEGV, SEGV_MAPERR,   <span style="color: #98be65;">"level 3 translation fault"</span> },</code>
<code>    { do_bad,       SIGKILL, SI_KERNEL, <span style="color: #98be65;">"unknown 8"</span>         },</code>
<code>    { do_page_fault,    SIGSEGV, SEGV_ACCERR,   <span style="color: #98be65;">"level 1 access flag fault"</span> },</code>
<code>    { do_page_fault,    SIGSEGV, SEGV_ACCERR,   <span style="color: #98be65;">"level 2 access flag fault"</span> },</code>
<code>    { do_page_fault,    SIGSEGV, SEGV_ACCERR,   <span style="color: #98be65;">"level 3 access flag fault"</span> },</code>
<code>    { do_bad,       SIGKILL, SI_KERNEL, <span style="color: #98be65;">"unknown 12"</span>            },</code>
<code>    { do_page_fault,    SIGSEGV, SEGV_ACCERR,   <span style="color: #98be65;">"level 1 permission fault"</span>  },</code>
<code>    { do_page_fault,    SIGSEGV, SEGV_ACCERR,   <span style="color: #98be65;">"level 2 permission fault"</span>  },</code>
<code>    { do_page_fault,    SIGSEGV, SEGV_ACCERR,   <span style="color: #98be65;">"level 3 permission fault"</span>  },</code>
<code>    { do_sea,       SIGBUS,  BUS_OBJERR,    <span style="color: #98be65;">"synchronous external abort"</span>    },</code>
<code>    { do_bad,       SIGKILL, SI_KERNEL, <span style="color: #98be65;">"unknown 17"</span>            },</code>
<code>  ...</code>
<code>};</code>
<code><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">do_bad_area</span>(<span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> <span style="color: #dcaeea;">addr</span>, <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">esr</span>, <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pt_regs</span> *<span style="color: #dcaeea;">regs</span>)</code>
<code>{</code>
<code>    <span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;">     * If we are in kernel mode at this point, we have no context to</span></code>
<code><span style="color: #5B6268;">     * handle this fault with.</span></code>
<code><span style="color: #5B6268;">     */</span></code>
<code>    <span style="color: #51afef;">if</span> (user_mode(regs)) {</code>
<code>        <span style="color: #51afef;">const</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">fault_info</span> *<span style="color: #dcaeea;">inf</span> = esr_to_fault_info(esr);</code>
<code>        <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">siginfo</span> <span style="color: #dcaeea;">si</span> = {</code>
<code>            .si_signo   = inf-&gt;sig,</code>
<code>            .si_code    = inf-&gt;code,</code>
<code>            .si_addr    = (<span style="color: #ECBE7B;">void</span> <span style="color: #dcaeea;">__user</span> *)addr,</code>
<code>        };</code>
<code></code>
<code>        __do_user_fault(&amp;si, esr);</code>
<code>    } <span style="color: #51afef;">else</span> {</code>
<code>        __do_kernel_fault(addr, esr, regs);</code>
<code>    }</code>
<code>}</code>
<code></code>
<code><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">__do_user_fault</span>(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">siginfo</span> *<span style="color: #dcaeea;">info</span>, <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">esr</span>)</code>
<code>{</code>
<code>  ...</code>
<code>  arm64_force_sig_info(info, esr_to_fault_info(esr)-&gt;name, current);</code>
<code>}</code>
</pre>
</div>
</div>
</li>

<li><a id="tomestonedè¿›ç¨‹"></a>tomestonedè¿›ç¨‹<br>
<div class="outline-text-5" id="text-tomestonedè¿›ç¨‹">
<p>
<a href="http://androidxref.com/8.1.0_r33/xref/system/core/debuggerd/tombstoned/tombstoned.rc#1">system/core/debuggerd/tombstoned/tombstoned.rc</a><br>
</p>

<pre class="example" id="org6048a32">
<code>service tombstoned /system/bin/tombstoned</code>
<code>    user tombstoned</code>
<code>    group system</code>
<code></code>
<code>    # Don't start tombstoned until after the real /data is mounted.</code>
<code>    class late_start</code>
<code></code>
<code>    socket tombstoned_crash seqpacket 0666 system system</code>
<code>    socket tombstoned_intercept seqpacket 0666 system system</code>
<code>    socket tombstoned_java_trace seqpacket 0666 system system</code>
<code>    writepid /dev/cpuset/system-background/tasks</code>
</pre>
</div>
</li>

<li><a id="ä¿¡å·å¤„ç†å‡½æ•°"></a>ä¿¡å·å¤„ç†å‡½æ•°<br>
<div class="outline-text-5" id="text-ä¿¡å·å¤„ç†å‡½æ•°">
<p>
for android N<br>
<a href="http://sniffer.site/2017/07/09/Android%E8%BF%9B%E7%A8%8BCrash%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/">Androidè¿›ç¨‹Crashå¤„ç†æµç¨‹</a><br>
for android O<br>
</p>

<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;"> * This code is called after the linker has linked itself and</span></code>
<code><span style="color: #5B6268;"> * fixed it's own GOT. It is safe to make references to externs</span></code>
<code><span style="color: #5B6268;"> * and other non-local data at this point.</span></code>
<code><span style="color: #5B6268;"> */</span></code>
<code><span style="color: #51afef;">static</span> <span style="color: #c678dd;">ElfW</span>(Addr) <span style="color: #c678dd;">__linker_init_post_relocation</span>(KernelArgumentBlock&amp; args) {</code>
<code>  <span style="color: #ECBE7B;">ProtectedDataGuard</span> <span style="color: #dcaeea;">guard</span>;</code>
<code>  ...</code>
<code><span style="color: #51afef; font-weight: bold;">#ifdef</span> __ANDROID__</code>
<code>  debuggerd_callbacks_t callbacks = {</code>
<code>    .get_abort_message = []() {</code>
<code>      <span style="color: #51afef;">return</span> g_abort_message;</code>
<code>    },</code>
<code>    .post_dump = &amp;notify_gdb_of_libraries,</code>
<code>  };</code>
<code>  debuggerd_init(&amp;callbacks);</code>
<code><span style="color: #51afef; font-weight: bold;">#endif</span></code>
<code>  g_linker_logger.ResetState();</code>
<code>  ...</code>
<code>}</code>
<code></code>
<code><span style="color: #5B6268;">// </span><span style="color: #5B6268;">Handler that does crash dumping by forking and doing the processing in the child.</span></code>
<code><span style="color: #5B6268;">// </span><span style="color: #5B6268;">Do this by ptracing the relevant thread, and then execing debuggerd to do the actual dump.</span></code>
<code><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">debuggerd_signal_handler</span>(<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">signal_number</span>, <span style="color: #ECBE7B;">siginfo_t</span>* <span style="color: #dcaeea;">info</span>, <span style="color: #ECBE7B;">void</span>* <span style="color: #dcaeea;">context</span>) {</code>
<code>  ...</code>
<code>  debugger_thread_info thread_info = {</code>
<code>    .crash_dump_started = <span style="color: #a9a1e1;">false</span>,</code>
<code>    .pseudothread_tid = -1,</code>
<code>    .crashing_tid = __gettid(),</code>
<code>    .signal_number = signal_number,</code>
<code>    .info = info</code>
<code>  };</code>
<code></code>
<code>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Set PR_SET_DUMPABLE to 1, so that crash_dump can ptrace us.</span></code>
<code>  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">orig_dumpable</span> = prctl(PR_GET_DUMPABLE);</code>
<code>  <span style="color: #51afef;">if</span> (prctl(PR_SET_DUMPABLE, 1) != 0) {</code>
<code>    fatal_errno(<span style="color: #98be65;">"failed to set dumpable"</span>);</code>
<code>  }</code>
<code></code>
<code>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Essentially pthread_create without CLONE_FILES (see debuggerd_dispatch_pseudothread).</span></code>
<code>  <span style="color: #ECBE7B;">pid_t</span> <span style="color: #dcaeea;">child_pid</span> =</code>
<code>    clone(debuggerd_dispatch_pseudothread, pseudothread_stack,</code>
<code>          CLONE_THREAD | CLONE_SIGHAND | CLONE_VM | CLONE_CHILD_SETTID | CLONE_CHILD_CLEARTID,</code>
<code>          &amp;thread_info, nullptr, nullptr, &amp;thread_info.pseudothread_tid);</code>
<code>  <span style="color: #51afef;">if</span> (child_pid == -1) {</code>
<code>    fatal_errno(<span style="color: #98be65;">"failed to spawn debuggerd dispatch thread"</span>);</code>
<code>  }</code>
<code>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Wait for the child to start...</span></code>
<code>  futex_wait(&amp;thread_info.pseudothread_tid, -1);</code>
<code></code>
<code>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">and then wait for it to finish.</span></code>
<code>  futex_wait(&amp;thread_info.pseudothread_tid, child_pid);</code>
<code>}</code>
<code></code>
<code><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">debuggerd_dispatch_pseudothread</span>(<span style="color: #ECBE7B;">void</span>* <span style="color: #dcaeea;">arg</span>) {</code>
<code>  <span style="color: #ECBE7B;">debugger_thread_info</span>* <span style="color: #dcaeea;">thread_info</span> = static_cast&lt;debugger_thread_info*&gt;(arg);</code>
<code></code>
<code>  <span style="color: #51afef;">for</span> (<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = 0; i &lt; 1024; ++i) {</code>
<code>    close(i);</code>
<code>  }</code>
<code></code>
<code>  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">devnull</span> = TEMP_FAILURE_RETRY(open(<span style="color: #98be65;">"/dev/null"</span>, O_RDWR));</code>
<code></code>
<code>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">devnull will be 0.</span></code>
<code>  TEMP_FAILURE_RETRY(dup2(devnull, STDOUT_FILENO));</code>
<code>  TEMP_FAILURE_RETRY(dup2(devnull, STDERR_FILENO));</code>
<code></code>
<code>  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">pipefds</span>[2];</code>
<code>  <span style="color: #51afef;">if</span> (pipe(pipefds) != 0) {</code>
<code>    fatal_errno(<span style="color: #98be65;">"failed to create pipe"</span>);</code>
<code>  }</code>
<code></code>
<code>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Don't use fork(2) to avoid calling pthread_atfork handlers.</span></code>
<code>  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">forkpid</span> = clone(nullptr, nullptr, 0, nullptr);</code>
<code>  <span style="color: #51afef;">if</span> (forkpid == -1) {</code>
<code>    async_safe_format_log(ANDROID_LOG_FATAL, <span style="color: #98be65;">"libc"</span>,</code>
<code>                          <span style="color: #98be65;">"failed to fork in debuggerd signal handler: %s"</span>, strerror(errno));</code>
<code>  } <span style="color: #51afef;">else</span> <span style="color: #51afef;">if</span> (forkpid == 0) {</code>
<code>    TEMP_FAILURE_RETRY(dup2(pipefds[1], STDOUT_FILENO));</code>
<code>    close(pipefds[0]);</code>
<code>    close(pipefds[1]);</code>
<code></code>
<code>    raise_caps();</code>
<code></code>
<code>    <span style="color: #ECBE7B;">char</span> <span style="color: #dcaeea;">main_tid</span>[10];</code>
<code>    <span style="color: #ECBE7B;">char</span> <span style="color: #dcaeea;">pseudothread_tid</span>[10];</code>
<code>    <span style="color: #ECBE7B;">char</span> <span style="color: #dcaeea;">debuggerd_dump_type</span>[10];</code>
<code>    async_safe_format_buffer(main_tid, <span style="color: #51afef;">sizeof</span>(main_tid), <span style="color: #98be65;">"%d"</span>, thread_info-&gt;crashing_tid);</code>
<code>    async_safe_format_buffer(pseudothread_tid, <span style="color: #51afef;">sizeof</span>(pseudothread_tid), <span style="color: #98be65;">"%d"</span>,</code>
<code>                             thread_info-&gt;pseudothread_tid);</code>
<code>    async_safe_format_buffer(debuggerd_dump_type, <span style="color: #51afef;">sizeof</span>(debuggerd_dump_type), <span style="color: #98be65;">"%d"</span>,</code>
<code>                             get_dump_type(thread_info));</code>
<code></code>
<code>    execl(CRASH_DUMP_PATH, CRASH_DUMP_NAME, main_tid, pseudothread_tid, debuggerd_dump_type,</code>
<code>          nullptr);</code>
<code></code>
<code>    fatal_errno(<span style="color: #98be65;">"exec failed"</span>);</code>
<code>  } <span style="color: #51afef;">else</span> {</code>
<code>    close(pipefds[1]);</code>
<code>    <span style="color: #ECBE7B;">char</span> <span style="color: #dcaeea;">buf</span>[4];</code>
<code>    <span style="color: #ECBE7B;">ssize_t</span> <span style="color: #dcaeea;">rc</span> = TEMP_FAILURE_RETRY(read(pipefds[0], &amp;buf, <span style="color: #51afef;">sizeof</span>(buf)));</code>
<code>    <span style="color: #51afef;">if</span> (rc == -1) {</code>
<code>      async_safe_format_log(ANDROID_LOG_FATAL, <span style="color: #98be65;">"libc"</span>, <span style="color: #98be65;">"read of IPC pipe failed: %s"</span>,</code>
<code>                            strerror(errno));</code>
<code>    } <span style="color: #51afef;">else</span> <span style="color: #51afef;">if</span> (rc == 0) {</code>
<code>      async_safe_format_log(ANDROID_LOG_FATAL, <span style="color: #98be65;">"libc"</span>, <span style="color: #98be65;">"crash_dump helper failed to exec"</span>);</code>
<code>    } <span style="color: #51afef;">else</span> <span style="color: #51afef;">if</span> (rc != 1) {</code>
<code>      async_safe_format_log(ANDROID_LOG_FATAL, <span style="color: #98be65;">"libc"</span>,</code>
<code>                            <span style="color: #98be65;">"read of IPC pipe returned unexpected value: %zd"</span>, rc);</code>
<code>    } <span style="color: #51afef;">else</span> {</code>
<code>      <span style="color: #51afef;">if</span> (buf[0] != <span style="color: #98be65;">'\1'</span>) {</code>
<code>        async_safe_format_log(ANDROID_LOG_FATAL, <span style="color: #98be65;">"libc"</span>, <span style="color: #98be65;">"crash_dump helper reported failure"</span>);</code>
<code>      } <span style="color: #51afef;">else</span> {</code>
<code>        thread_info-&gt;crash_dump_started = <span style="color: #a9a1e1;">true</span>;</code>
<code>      }</code>
<code>    }</code>
<code>    close(pipefds[0]);</code>
<code></code>
<code>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Don't leave a zombie child.</span></code>
<code>    <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">status</span>;</code>
<code>    <span style="color: #51afef;">if</span> (TEMP_FAILURE_RETRY(waitpid(forkpid, &amp;status, 0)) == -1) {</code>
<code>      async_safe_format_log(ANDROID_LOG_FATAL, <span style="color: #98be65;">"libc"</span>, <span style="color: #98be65;">"failed to wait for crash_dump helper: %s"</span>,</code>
<code>                            strerror(errno));</code>
<code>    } <span style="color: #51afef;">else</span> <span style="color: #51afef;">if</span> (WIFSTOPPED(status) || WIFSIGNALED(status)) {</code>
<code>      async_safe_format_log(ANDROID_LOG_FATAL, <span style="color: #98be65;">"libc"</span>, <span style="color: #98be65;">"crash_dump helper crashed or stopped"</span>);</code>
<code>      thread_info-&gt;crash_dump_started = <span style="color: #a9a1e1;">false</span>;</code>
<code>    }</code>
<code>  }</code>
<code></code>
<code>  syscall(__NR_exit, 0);</code>
<code>  <span style="color: #51afef;">return</span> 0;</code>
<code>}</code>
</pre>
</div>

<p>
cloneå‚æ•° clone(debuggerd_dispatch_pseudothread, pseudothread_stack,<br>
CLONE_THREAD | CLONE_SIGHAND | CLONE_VM | CLONE_CHILD_SETTID |<br>
CLONE_CHILD_CLEARTID, &amp;thread_info, nullptr, nullptr,<br>
&amp;thread_info.pseudothread_tid); //<br>
<a href="http://androidxref.com/9.0.0_r3/xref/bionic/libc/bionic/pthread_create.cpp#302">http://androidxref.com/9.0.0_r3/xref/bionic/libc/bionic/pthread_create.cpp#302</a><br>
int flags = CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND |<br>
CLONE_THREAD | CLONE_SYSVSEM | CLONE_SETTLS | CLONE_PARENT_SETTID |<br>
CLONE_CHILD_CLEARTID;<br>
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-signalè°ƒè¯•" class="outline-4">
<h4 id="signalè°ƒè¯•"><span class="section-number-4">4.2.5.</span> Signalè°ƒè¯•</h4>
<div class="outline-text-4" id="text-signalè°ƒè¯•">
</div>

<ul class="org-ul">
<li><a id="tracing-event"></a>tracing event<br>
<div class="outline-text-5" id="text-tracing-event">
<p>
/d/tracing/events/signal/signal_generate<br>
/d/tracing/events/signal/signal_deliver<br>
</p>

<pre class="example" id="org58784a3">
<code>remote_job_disp-24083 [000] d..2  5497.143322: signal_deliver: sig=9 errno=0 code=0 sa_handler=0 sa_flags=0</code>
<code>ActivityManager-7834  [001] d..2  5497.171845: signal_generate: sig=9 errno=0 code=0 comm=id.printspooler pid=25155 grp=1 res=0</code>
<code>   FileObserver-25196 [000] d..3  5497.176538: signal_generate: sig=17 errno=0 code=262146 comm=main pid=7514 grp=1 res=0</code>
<code>           main-7514  [002] d..2  5497.176804: signal_deliver: sig=17 errno=0 code=262146 sa_handler=7f836cfef8 sa_flags=0</code>
<code>ActivityManager-7834  [001] d..2  5497.222412: signal_generate: sig=9 errno=0 code=0 comm=rsonalassistant pid=24800 grp=1 res=0</code>
<code>ActivityManager-7834  [001] d..2  5497.227639: signal_generate: sig=9 errno=0 code=0 comm=rsonalassistant pid=24800 grp=1 res=2</code>
<code>  Profile Saver-24878 [000] d..3  5497.229721: signal_generate: sig=17 errno=0 code=262146 comm=main pid=717 grp=1 res=0</code>
<code>           main-717   [001] d..2  5497.230300: signal_deliver: sig=17 errno=0 code=262146 sa_handler=f31702e1 sa_flags=4000000</code>
<code>remote_job_disp-24083 [000] d..3  5497.285461: signal_generate: sig=17 errno=0 code=262146 comm=main pid=717 grp=1 res=0</code>
<code>           main-717   [001] d..2  5497.285844: signal_deliver: sig=17 errno=0 code=262146 sa_handler=f31702e1 sa_flags=4000000</code>
<code>        SysUiBg-8259  [000] d.h6  5497.365086: signal_generate: sig=32 errno=0 code=131070 comm=POSIX timer 344 pid=15551 grp=0 res=0</code>
<code>      Thread-24-25413 [001] d.h3  5497.751070: signal_generate: sig=32 errno=0 code=131070 comm=POSIX timer 0 pid=8158 grp=0 res=0</code>
<code>      Thread-24-25413 [001] d.h3  5497.868609: signal_generate: sig=32 errno=0 code=131070 comm=POSIX timer 344 pid=15551 grp=0 res=0</code>
<code>  Binder:7518_3-8391  [002] d.h2  5497.958303: signal_generate: sig=14 errno=0 code=128 comm=sensors.qcom pid=614 grp=1 res=0</code>
<code>          perfd-2666  [007] .n.1  5498.123490: tracing_mark_write: B|459|perf_lock_acq: send output handle 10233 to client(pid 7767, tid=8320)</code>
</pre>
</div>
</li>

<li><a id="æŸ¥çœ‹è¿›ç¨‹ä¿¡å·å±è”½å¤„ç†ä¿¡æ¯"></a>æŸ¥çœ‹è¿›ç¨‹ä¿¡å·å±è”½ï¼Œå¤„ç†ä¿¡æ¯<br>
<div class="outline-text-5" id="text-æŸ¥çœ‹è¿›ç¨‹ä¿¡å·å±è”½å¤„ç†ä¿¡æ¯">
<p>
cat /proc/xxx/status<br>
</p>

<pre class="example" id="orgf52faa1">
<code>mido:/ # cat /proc/7767/status                                                                                                                             </code>
<code>Name:   system_server</code>
<code>State:  S (sleeping)</code>
<code>Tgid:   7767</code>
<code>Pid:    7767</code>
<code>PPid:   7514</code>
<code>TracerPid:  0</code>
<code>Uid:    1000    1000    1000    1000</code>
<code>Gid:    1000    1000    1000    1000</code>
<code>Ngid:   0</code>
<code>FDSize: 1024</code>
<code>Groups: 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1018 1021 1032 3001 3002 3003 3006 3007 3009 3010 9801</code>
<code>VmPeak:  2826432 kB</code>
<code>VmSize:  2702540 kB</code>
<code>VmLck:    144456 kB</code>
<code>VmPin:         0 kB</code>
<code>VmHWM:    383340 kB</code>
<code>VmRSS:    325492 kB</code>
<code>VmData:   438872 kB</code>
<code>VmStk:      8196 kB</code>
<code>VmExe:        16 kB</code>
<code>VmLib:    140536 kB</code>
<code>VmPTE:      1824 kB</code>
<code>VmSwap:    24688 kB</code>
<code>Threads:    211</code>
<code>SigQ:   6/10397                         //size/limits</code>
<code>SigPnd: 0000000000000000              //æŒ‚èµ·ï¼Œç­‰å¾…å¤„ç†çš„ä¿¡å·ï¼ˆæœ¬çº¿ç¨‹ä¸“å±ï¼‰</code>
<code>ShdPnd: 0000000000000000              //æŒ‚èµ·ï¼Œç­‰å¾…å¤„ç†çš„ä¿¡å·ï¼ˆçº¿ç¨‹ç»„å…¬ç”¨ï¼‰</code>
<code>SigBlk: 0000000000001204              //è¢«sigwaitæ³¨å†Œå¤„ç†çš„ä¿¡å·ï¼Œ è¿™é‡Œ 3) SIGQUIT, 10) SIGUSR1, 13) SIGPIPEè¢«ä¸Šå±‚é€šè¿‡ç³»ç»Ÿè°ƒç”¨ç­‰å¾…</code>
<code>SigIgn: 0000000000000001              //å¿½ç•¥çš„ä¿¡å·</code>
<code>SigCgt: 20000002000084f8              //è¢«ä¸Šå±‚é€šè¿‡sigactionæ³¨å†Œæ•æ‰çš„ä¿¡å·ï¼Œè¿™ä¸ªåœ°æ–¹SIGABRTï¼Œ SIGBUSï¼Œ SIGSEGVç­‰å¼‚å¸¸ä¿¡å·éƒ½è¢«æ•æ‰ï¼Œç”¨ä»¥è¾“å‡ºtomestone</code>
<code>CapInh: 0000000000000000</code>
<code>CapPrm: 0000001007897c20</code>
<code>CapEff: 0000001007897c20</code>
<code>CapBnd: 0000000000000000</code>
<code>Seccomp:    0</code>
<code>Cpus_allowed:   d7</code>
<code>Cpus_allowed_list:  0-2,4,6-7</code>
<code>Mems_allowed:   1</code>
<code>Mems_allowed_list:  0</code>
<code>voluntary_ctxt_switches:    69902</code>
<code>nonvoluntary_ctxt_switches: 3480</code>
</pre>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
