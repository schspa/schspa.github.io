<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2021-11-04 å›› 11:09 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AARCH64 ERET</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Schspa">
<meta name="description" content="AARCH64 ERET"
>
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content">
<h1 class="title">AARCH64 ERET</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge177650">Exception &amp; ERETçš„ä½¿ç”¨åœºæ™¯</a></li>
<li><a href="#org2a0ee34">ERETè¿”å›åä»£ç ä»ä½•å¤„å¼€å§‹æ‰§è¡Œï¼Ÿ</a>
<ul>
<li><a href="#orgf776a6c">å…ˆçœ‹ERETçš„ä¼ªä»£ç </a></li>
<li><a href="#org214a8a8">å†çœ‹Exceptionäº§ç”Ÿçš„ä¼ªä»£ç </a></li>
</ul>
</li>
<li><a href="#org37ac314">æ€»ç»“</a></li>
</ul>
</div>
</div>

<div id="outline-container-orge177650" class="outline-2">
<h2 id="orge177650">Exception &amp; ERETçš„ä½¿ç”¨åœºæ™¯</h2>
<div class="outline-text-2" id="text-orge177650">
<p>
ERETç”¨æ¥åœ¨ç³»ç»Ÿå¼‚å¸¸å¤„ç†å®Œæˆåè¿”å›åŸæ¥çš„æ‰§è¡Œæµç¨‹å¹¶ç»§ç»­è¿è¡Œä¸‹å»<br>
çœ‹ä¼¼ç®€å•çš„åŠŸèƒ½ï¼Œå®ç°å´å¹¶ä¸ç®€å•ï¼Œéœ€è¦è€ƒè™‘å¾ˆå¤šåœºæ™¯,ä¸åŒåœºæ™¯ä¸‹è¡Œä¸ºä¹Ÿä¼šæœ‰äº›å·®å¼‚<br>
åœ¨ARMv8 TRMä¸­æœ‰ä¼ªä»£ç ï¼Œé€šè¿‡åˆ†æä¼ªä»£ç ï¼Œå¯ä»¥ä»ä¸€ä¸ªè§’åº¦çœ‹æ¸…ERETæŒ‡ä»¤çš„åŠŸèƒ½ã€‚<br>
</p>

<p>
å…¸å‹åœºæ™¯:<br>
</p>
<ol class="org-ol">
<li>SVCï¼ŒHVCï¼ŒSMCç­‰è½¯ä»¶å¼‚å¸¸æŒ‡ä»¤<br></li>
<li>Synchronous Exceptionå¼‚å¸¸<br></li>
<li><p>
IRQ/FIQï¼System Errorè¿”å›<br>
</p>

<p>
ä»ä¸Šé¢çš„åœºæ™¯ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹ï¼Œå¼‚å¸¸å¤„ç†è¿”å›åéœ€è¦ä»ä¸åŒçš„åœ°å€ç»§ç»­æ‰§è¡Œ<br>
</p>
<ul class="org-ul">
<li>Data Abort: éœ€è¦ä»å½“å‰ä½ç½®é‡æ–°æ‰§è¡Œå‡ºé”™çš„æŒ‡ä»¤ï¼Œä»¥ä¾¿è¯»å–åˆ°æ­£ç¡®çš„æ•°æ®<br></li>

<li>SVC, HVC, SMCï¼šéœ€è¦ä»å‡ºé”™æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤å¼€å§‹ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™å°†ä¼šé‡æ–°è¿›å…¥ç‰¹æƒæ¨¡å¼<br></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org2a0ee34" class="outline-2">
<h2 id="org2a0ee34">ERETè¿”å›åä»£ç ä»ä½•å¤„å¼€å§‹æ‰§è¡Œï¼Ÿ</h2>
<div class="outline-text-2" id="text-org2a0ee34">
</div>
<div id="outline-container-orgf776a6c" class="outline-3">
<h3 id="orgf776a6c">å…ˆçœ‹ERETçš„ä¼ªä»£ç </h3>
<div class="outline-text-3" id="text-orgf776a6c">
<p>
ä¼ªä»£ç :<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #5B6268;">// </span><span style="color: #5B6268;">AArch64.ExceptionReturn()</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">=========================</span>
AArch64.ExceptionReturn(bits(64) new_pc, bits(32) spsr)
    <span style="color: #c678dd;">SynchronizeContext</span>();
    sync_errors = HaveIESB() &amp;&amp; SCTLR[].IESB == <span style="color: #98be65;">'1'</span>;
    <span style="color: #51afef;">if</span> HaveDoubleFaultExt() <span style="color: #ECBE7B;">then</span>
        <span style="color: #dcaeea;">sync_errors</span> = sync_errors || (SCR_EL3.EA == <span style="color: #98be65;">'1'</span> &amp;&amp; SCR_EL3.NMEA == <span style="color: #98be65;">'1'</span> &amp;&amp; PSTATE.EL == EL3);
    <span style="color: #51afef;">if</span> sync_errors then
        SynchronizeErrors();
        iesb_req = TRUE;
        <span style="color: #c678dd;">TakeUnmaskedPhysicalSErrorInterrupts</span>(iesb_req);
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Attempts to change to an illegal state will invoke the Illegal Execution state mechanism</span>
    <span style="color: #c678dd;">SetPSTATEFromPSR</span>(spsr);
    <span style="color: #c678dd;">ClearExclusiveLocal</span>(<span style="color: #ECBE7B;">ProcessorID</span>());
    <span style="color: #c678dd;">SendEventLocal</span>();

    <span style="color: #51afef;">if</span> PSTATE.IL == <span style="color: #98be65;">'1'</span> &amp;&amp; spsr&lt;4&gt; == <span style="color: #98be65;">'1'</span> &amp;&amp; spsr&lt;20&gt; == <span style="color: #98be65;">'0'</span> then
        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">If the exception return is illegal, PC[63:32,1:0] are UNKNOWN</span>
        new_pc&lt;63:32&gt; = bits(32) UNKNOWN;
        new_pc&lt;1:0&gt; = bits(2) UNKNOWN;
    <span style="color: #ECBE7B;">elsif</span> <span style="color: #c678dd;">UsingAArch32</span>() then
        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Return to AArch32</span>
        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ELR_ELx[1:0] or ELR_ELx[0] are treated as being 0, depending on the target instruction set state</span>
        <span style="color: #51afef;">if</span> PSTATE.T == <span style="color: #98be65;">'1'</span> then
            new_pc&lt;0&gt; = <span style="color: #98be65;">'0'</span>;      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">T32</span>
        <span style="color: #51afef;">else</span>
            new_pc&lt;1:0&gt; = <span style="color: #ECBE7B;">'</span>00<span style="color: #ECBE7B;">'</span>;   <span style="color: #5B6268;">// </span><span style="color: #5B6268;">A32</span>
    <span style="color: #51afef;">else</span>                                  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Return to AArch64</span>
        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ELR_ELx[63:56] might include a tag</span>
        new_pc = AArch64.BranchAddr(new_pc);
    <span style="color: #51afef;">if</span> UsingAArch32() <span style="color: #ECBE7B;">then</span>
        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">32 most significant bits are ignored.</span>
        <span style="color: #c678dd;">BranchTo</span>(new_pc&lt;31:0&gt;, BranchType_ERET);
    <span style="color: #51afef;">else</span>
        BranchToAddr(new_pc, BranchType_ERET);
</pre>
</div>

<p>
é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥å‘ç°ï¼ŒERETå¹¶æ²¡æœ‰å¯¹è¿”å›çš„åœ°å€åšå–åä¸€æ¡æŒ‡ä»¤åœ°å€çš„æ“ä½œï¼Œä»…ä»…å¯¹å¼‚å¸¸æŒ‡ä»¤çš„ä½ä½è¿›è¡Œäº†ä¿®æ­£.<br>
ç”±æ­¤å¯è§ï¼Œç³»ç»Ÿåœ¨æ‰§è¡ŒESRæŒ‡ä»¤iä¹‹å‰ï¼Œç³»ç»Ÿå°±å·²ç»å°†LRè®¾ç½®ä¸ºäº†éœ€è¦æ­£ç¡®è¿”å›çš„åœ°å€äº†ã€‚<br>
</p>
</div>
</div>




<div id="outline-container-org214a8a8" class="outline-3">
<h3 id="org214a8a8">å†çœ‹Exceptionäº§ç”Ÿçš„ä¼ªä»£ç </h3>
<div class="outline-text-3" id="text-org214a8a8">
<dl class="org-dl">
<dt>DataAbort</dt><dd>da<br></dd>
</dl>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #5B6268;">// </span><span style="color: #5B6268;">AArch64.DataAbort()</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">===================</span>

AArch64.DataAbort(bits(64) vaddress, <span style="color: #ECBE7B;">FaultRecord</span> <span style="color: #dcaeea;">fault</span>)
   route_to_el3 = HaveEL(EL3) &amp;&amp; SCR_EL3.EA == <span style="color: #98be65;">'1'</span> &amp;&amp; IsExternalAbort(fault);
   route_to_el2 = (PSTATE.EL IN {EL0, EL1} &amp;&amp; EL2Enabled() &amp;&amp; (HCR_EL2.TGE == <span style="color: #98be65;">'1'</span> ||
           (HaveRASExt() &amp;&amp; HCR_EL2.TEA == <span style="color: #98be65;">'1'</span> &amp;&amp; IsExternalAbort(fault)) ||
           (HaveNV2Ext() &amp;&amp; fault.acctype == AccType_NV2REGISTER) ||
           IsSecondStage(fault)));

   bits(64) preferred_exception_return = ThisInstrAddr();
   <span style="color: #51afef;">if</span> (HaveDoubleFaultExt() &amp;&amp; (PSTATE.EL == EL3 || route_to_el3) &amp;&amp;
       IsExternalAbort(fault) &amp;&amp; SCR_EL3.EASE == <span style="color: #98be65;">'1'</span>) <span style="color: #ECBE7B;">then</span>
       <span style="color: #dcaeea;">vect_offset</span> = 0x180;
   <span style="color: #51afef;">else</span>
       vect_offset = 0x0;
   <span style="color: #51afef;">if</span> HaveNV2Ext() &amp;&amp; fault.acctype == AccType_NV2REGISTER then
       exception = AArch64.AbortSyndrome(Exception_NV2DataAbort, fault, vaddress);
   <span style="color: #51afef;">else</span>
       exception = AArch64.AbortSyndrome(Exception_DataAbort, fault, vaddress);
   <span style="color: #51afef;">if</span> PSTATE.EL == EL3 || route_to_el3 then
       AArch64.TakeException(EL3, exception, preferred_exception_return, vect_offset);
   <span style="color: #ECBE7B;">elsif</span> <span style="color: #dcaeea;">PSTATE</span>.EL == EL2 || route_to_el2 then
       AArch64.TakeException(EL2, exception, preferred_exception_return, vect_offset);
   <span style="color: #51afef;">else</span>
       AArch64.TakeException(EL1, exception, preferred_exception_return, vect_offset); 
</pre>
</div>

<p>
ä»DataAbortçš„ä¼ªä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œç³»ç»Ÿåœ¨å–preferred_exception_returnæ—¶ï¼Œä½¿ç”¨çš„æ˜¯ThisInstrAddrï¼Œå³ELRçš„å€¼å°†è®¾ç½®ä¸ºå‡ºé”™æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤. AArch64.TakeExceptionè¿‡ç¨‹å°†æŠŠpreferred_exception_returnçš„å€¼è®¾ç½®åˆ°ELRå¯„å­˜å™¨ä¸­<br>
</p>
<dl class="org-dl">
<dt>CallSupervisor</dt><dd><p>
svc<br>
</p>
<div class="org-src-container">
<pre class="src src-C">aarch64/exceptions/syscalls/AArch64.CallSupervisor
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">AArch64.CallSupervisor()</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">========================</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">Calls the Supervisor</span>

AArch64.CallSupervisor(bits(16) immediate)

    <span style="color: #51afef;">if</span> UsingAArch32() <span style="color: #ECBE7B;">then</span> <span style="color: #c678dd;">AArch32</span>.ITAdvance();
    <span style="color: #c678dd;">SSAdvance</span>();
    route_to_el2 = PSTATE.EL == EL0 &amp;&amp; EL2Enabled() &amp;&amp; HCR_EL2.TGE == <span style="color: #98be65;">'1'</span>;

    bits(64) preferred_exception_return = NextInstrAddr();
    vect_offset = 0x0;

    exception = ExceptionSyndrome(Exception_SupervisorCall);
    exception.syndrome&lt;15:0&gt; = immediate;

    <span style="color: #51afef;">if</span> UInt(PSTATE.EL) &gt; UInt(EL1) <span style="color: #ECBE7B;">then</span>
        <span style="color: #c678dd;">AArch64</span>.TakeException(PSTATE.EL, exception, preferred_exception_return, vect_offset);
    elsif route_to_el2 <span style="color: #ECBE7B;">then</span>
        <span style="color: #c678dd;">AArch64</span>.TakeException(EL2, exception, preferred_exception_return, vect_offset);
    <span style="color: #51afef;">else</span>
        AArch64.TakeException(EL1, exception, preferred_exception_return, vect_offset);
</pre>
</div>

<p>
åŒç†ï¼Œä»SVCæŒ‡ä»¤çš„ä¼ªä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œpreferred_exception_returnè¢«è®¾ç½®ä¸ºäº†NextInstrAddr()ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€<br>
</p></dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-org37ac314" class="outline-2">
<h2 id="org37ac314">æ€»ç»“</h2>
<div class="outline-text-2" id="text-org37ac314">
<p>
AARCH64 CPUåœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šæ ¹æ®å¼‚å¸¸çš„Classæ¥å°†ELRè®¾ç½®ä¸ºä¸åŒçš„åœ°å€ï¼Œæ‰€ä»¥ï¼ŒELRå¯„å­˜å™¨å­˜å‚¨çš„æ˜¯å¼‚å¸¸å¤„ç†ä¹‹åéœ€è¦è¿”å›çš„åœ°å€ï¼Œè€Œä¸æ˜¯å‘ç”Ÿå¼‚å¸¸çš„æŒ‡ä»¤åœ°å€.<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
