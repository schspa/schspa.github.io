<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-03-21 Mon 17:28 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Linux Clock Framework</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Schspa">
<meta name="description" content="Linux Clock Framework"
>
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content">
<h1 class="title">Linux Clock Framework</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0bfb67b">Clockå…³ç³»å›¾</a>
<ul>
<li><a href="#org29ba393">struct clk</a></li>
<li><a href="#org5a6d4be">struct clk_core</a></li>
<li><a href="#orgd6dd88f">struct clk_hw</a></li>
</ul>
</li>
<li><a href="#org42c47e3">Clockæ“ä½œæ­¥éª¤</a>
<ul>
<li><a href="#orgadbf4e7">Clock Providerç¼–è¯‘æœŸåˆå§‹åŒ–</a></li>
<li><a href="#orgd363e40">åˆå§‹åŒ–</a>
<ul>
<li><a href="#org84b6a0b">of_clk_init</a></li>
</ul>
</li>
<li><a href="#orgd68517b">Clockç®¡ç†</a>
<ul>
<li><a href="#orgab604d1">provider</a></li>
<li><a href="#orga1d6d51">clks</a></li>
<li><a href="#orged22390">è·å–clock</a></li>
<li><a href="#org9a061d5">clk_prepare</a></li>
<li><a href="#org97da0b8">clk_enable</a></li>
<li><a href="#org01b1d6f">clk_set_rate</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org0bfb67b" class="outline-2">
<h2 id="org0bfb67b">Clockå…³ç³»å›¾</h2>
<div class="outline-text-2" id="text-org0bfb67b">
<p>
åœ¨Linux Clockçš„ä»£ç ä¸­ï¼Œç»å¸¸ä¼šæœ‰ä»¥ä¸‹å‡ ä¸ªç»“æ„ä½“ï¼Œä¸‹é¢çš„å›¾å±•ç¤ºäº†è¿™å‡ ç§ç»“æ„ä½“ä¹‹é—´çš„å…³ç³»<br>
</p>

<p>
<img src="/assets/.Linux-Clock.png"><br>
</p>
</div>

<div id="outline-container-org29ba393" class="outline-3">
<h3 id="org29ba393">struct clk</h3>
<div class="outline-text-3" id="text-org29ba393">
<p>
è¿™ä¸ªç»“æ„ä½“æ˜¯å¯¹å¤–çš„æ¥å£ï¼Œé©±åŠ¨ç¨‹åºéƒ½ä¼šç›´æ¥è·å–è¿™ä¸ªç»“æ„ä½“ï¼Œå¹¶ä½œä¸ºä¸€ä¸ªhandleæ¥å®Œæˆå¯¹clockçš„å„ç§æ“ä½œ.<br>
è¯¥ç»“æ„ä½“å†…å®¹ä»…å¯¹linux clockå…³ç³»ç³»ç»Ÿå†…éƒ¨å¯è§<br>
</p>
</div>
</div>
<div id="outline-container-org5a6d4be" class="outline-3">
<h3 id="org5a6d4be">struct clk_core</h3>
<div class="outline-text-3" id="text-org5a6d4be">
<p>
è¿™ä¸ªç»“æ„ä½“ä½œä¸ºå†…éƒ¨ç®¡ç†clockçš„æ ¸å¿ƒæ•°æ®ï¼Œè´Ÿè´£å¤„ç†Clockä¹‹é—´çš„å…³ç³»ï¼Œchildï¼Œparentéƒ½ä¼šé€šè¿‡æ­¤ç»“æ„ä½“æ¥ç»´æŠ¤ä»–ä»¬ä¹‹é—´çš„è”ç³»ã€‚<br>
è¯¥ç»“æ„ä½“å†…å®¹ä»…å¯¹linux clockå…³ç³»ç³»ç»Ÿå†…éƒ¨å¯è§<br>
</p>
</div>
</div>
<div id="outline-container-orgd6dd88f" class="outline-3">
<h3 id="orgd6dd88f">struct clk_hw</h3>
<div class="outline-text-3" id="text-orgd6dd88f">
<p>
è¿™ä¸ªç»“æ„ä½“ä½œä¸ºClock Providerçš„æ ¸å¿ƒæ•°æ®ï¼ŒClockçš„é©±åŠ¨ç¨‹åºä¸€èˆ¬é€šè¿‡å†…åµŒçš„æ–¹å¼æ¥ä½¿ç”¨ã€‚Clock Frameworkåœ¨è°ƒç”¨å…·ä½“çš„Clockç¡¬ä»¶æ—¶ä¹Ÿä¼šé€šè¿‡è¿™ä¸ªæ•°æ®ç»“æ„æ¥åšå¯¹åº”çš„æ“ä½œã€‚<br>
</p>
</div>
</div>
</div>
<div id="outline-container-org42c47e3" class="outline-2">
<h2 id="org42c47e3">Clockæ“ä½œæ­¥éª¤</h2>
<div class="outline-text-2" id="text-org42c47e3">
</div>
<div id="outline-container-orgadbf4e7" class="outline-3">
<h3 id="orgadbf4e7">Clock Providerç¼–è¯‘æœŸåˆå§‹åŒ–</h3>
<div class="outline-text-3" id="text-orgadbf4e7">
<p>
é€šè¿‡CLK_OF_DECLAREæ¥å®šä¹‰Clockæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ³¨å†Œæ‰‹æ®µï¼Œé€šè¿‡è¿™ä¸ªå®æ¥æ³¨å†Œæ—¶ï¼Œç³»ç»Ÿä¼šé€šè¿‡ç‰¹å®šçš„é“¾æ¥è„šæœ¬æ¥å°†å¯¹åº”çš„æ•°æ®é“¾æ¥åˆ°ç‰¹å®šä½å€ï¼Œå¹¶åœ¨è¿è¡Œæ—¶æ‰¾åˆ°ä»–ä»¬ã€‚<br>
include/asm-generic/vmlinux.lds.h<br>
</p>
<div class="org-src-container">
<pre class="src src-c"><code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">___OF_TABLE</span>(<span style="color: #dcaeea;">cfg</span>, <span style="color: #dcaeea;">name</span>)  _OF_TABLE_##cfg(name)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">__OF_TABLE</span>(<span style="color: #dcaeea;">cfg</span>, <span style="color: #dcaeea;">name</span>)   ___OF_TABLE(cfg, name)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">OF_TABLE</span>(<span style="color: #dcaeea;">cfg</span>, <span style="color: #dcaeea;">name</span>)     __OF_TABLE(IS_ENABLED(cfg), name)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">_OF_TABLE_0</span>(<span style="color: #dcaeea;">name</span>)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">_OF_TABLE_1</span>(<span style="color: #dcaeea;">name</span>)                               \</code>
<code>    . = ALIGN(8);                                       \</code>
<code>    VMLINUX_SYMBOL(__##name##_of_table) = .;    \</code>
<code>    KEEP(*(__##name##_of_table))                        \</code>
<code>        KEEP(*(__##name##_of_table_end))</code>
<code></code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">TIMER_OF_TABLES</span>()       OF_TABLE(CONFIG_TIMER_OF, timer)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">IRQCHIP_OF_MATCH_TABLE</span>() OF_TABLE(CONFIG_IRQCHIP, irqchip)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">CLK_OF_TABLES</span>()         OF_TABLE(CONFIG_COMMON_CLK, clk)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">IOMMU_OF_TABLES</span>()       OF_TABLE(CONFIG_OF_IOMMU, iommu)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">RESERVEDMEM_OF_TABLES</span>() OF_TABLE(CONFIG_OF_RESERVED_MEM, reservedmem)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">CPU_METHOD_OF_TABLES</span>()  OF_TABLE(CONFIG_SMP, cpu_method)</code>
<code><span style="color: #51afef; font-weight: bold;">#define</span> <span style="color: #c678dd;">CPUIDLE_METHOD_OF_TABLES</span>() OF_TABLE(CONFIG_CPU_IDLE, cpuidle_method)</code>
</pre>
</div>
<ol class="org-ol">
<li>CLK_OF_TABLESè¿™ä¸ªå®ä¾èµ–äºCONFIG_COMMON_CLK, å½“è¿™ä¸ªé…ç½®é€‰ä¸Šä¹‹åï¼Œæœ€ç»ˆå°†ä¼šå±•å¼€ä¸º_OF_TABLE_1<br></li>
<li>æœ€ç»ˆä¼šç”Ÿæˆsymbol ,åœ¨å¤´æ–‡ä»¶ä¸­æœ‰å®šä¹‰<br></li>
<li><p>
å¯¹åº”çš„ï¼Œåœ¨ç¼–è¯‘æœŸç”Ÿæˆå¯¹åº”çš„of_device_idæ•°ç»„:<br>
</p>
<div class="org-src-container">
<pre class="src src-c"><code><span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;"> * Struct used for matching a device</span></code>
<code><span style="color: #5B6268;"> */</span></code>
<code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">of_device_id</span> {</code>
<code>    <span style="color: #ECBE7B;">char</span>        <span style="color: #dcaeea;">name</span>[32];</code>
<code>    <span style="color: #ECBE7B;">char</span>        <span style="color: #dcaeea;">type</span>[32];</code>
<code>    <span style="color: #ECBE7B;">char</span>        <span style="color: #dcaeea;">compatible</span>[128];</code>
<code>    <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">void</span> *<span style="color: #dcaeea;">data</span>;</code>
<code>};</code>
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-orgd363e40" class="outline-3">
<h3 id="orgd363e40">åˆå§‹åŒ–</h3>
<div class="outline-text-3" id="text-orgd363e40">
</div>
<div id="outline-container-org84b6a0b" class="outline-4">
<h4 id="org84b6a0b">of_clk_init</h4>
<div class="outline-text-4" id="text-org84b6a0b">
<p>
è°ƒç”¨è·¯å¾„ï¼š start_kernel-&gt;time_init-&gt;of_clk_init<br>
åŠŸèƒ½ï¼š<br>
</p>
</div>
<ul class="org-ul">
<li><a id="org6507464"></a>éå†èŠ‚ç‚¹ï¼Œå‡†å¤‡å¾…åˆå§‹åŒ–çš„æ—¶é’Ÿæ•°æ®<br>
<div class="outline-text-5" id="text-org6507464">
<p>
éå†device-treeä¸­çš„æ‰€ç”±èŠ‚ç‚¹ï¼Œå¹¶å°†ç¬¦åˆcompatibleå±æ€§çš„èŠ‚ç‚¹æ”¾å…¥ç”Ÿæˆclock_providerå¯¹è±¡ï¼Œæœ€åæ”¾å…¥çš„é“¾è¡¨ä¸­ã€‚<br>
</p>
</div>
</li>
<li><a id="org0b69fcd"></a>éå†æ‰€ç”±çš„clk_providerèŠ‚ç‚¹ï¼Œè°ƒç”¨åˆå§‹åŒ–å‡½æ•°ï¼Œ<br>
<div class="outline-text-5" id="text-org0b69fcd">
<dl class="org-dl">
<dt>parent_ready</dt><dd>è¿™ä¸ªå‡½æ•°ç”¨æ¥æ£€æŸ¥å¯¹åº”clockçš„parentsæ˜¯å¦å‡†å¤‡å°±ç»ªã€‚å¦‚æœè·å–clockæ—¶å‡ºç°é”™è¯¯ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè®¤ä¸ºclockå·²ç»å‡†å¤‡å¥½ï¼Œæ‰€ä»¥å¦‚æœdtsé…ç½®é”™è¯¯ï¼Œè·å–é©±åŠ¨è¿”å›é”™è¯¯ç (-EPROBE_DEFERé™¤å¤–)ï¼Œç³»ç»Ÿéƒ½ä¼šè®¤ä¸ºå¯¹åº”çš„clockå·²ç»å‡†å¤‡å¥½<br>
<dl class="org-dl">
<dt>force</dt><dd>è¿™ä¸ªå˜é‡ç”¨æ¥åœ¨åˆå§‹åŒ–æ—¶ä¿è¯ç³»ç»Ÿä¼šè°ƒç”¨åˆ°é‚£äº›parentsæ²¡æœ‰å‡†å¤‡å¥½çš„clockåˆå§‹åŒ–å‡½æ•°ã€‚<br></dd>
</dl></dd>
</dl>
</div>
</li>
<li><a id="org202594b"></a>å¤„ç†Assigned clock parents and rates<br>
<div class="outline-text-5" id="text-org202594b">
<dl class="org-dl">
<dt>assigned-clock</dt><dd>å¯¹è¿™äº›clockè®¾ç½®parentï¼Œå’Œrate<br></dd>
<dt>assigned-clock-parents</dt><dd>è¿™ä¸ªç”¨æ¥å¯¹æŒ‡å®šçš„clocké…ç½®parent<br></dd>
<dt>assigned-clock-rates</dt><dd>å¯¹åº”clockçš„é»˜è®¤é¢‘ç‡<br></dd>
</dl>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgd68517b" class="outline-3">
<h3 id="orgd68517b">Clockç®¡ç†</h3>
<div class="outline-text-3" id="text-orgd68517b">
<p>
Linuxå†…æ ¸ä¸­åŒºåˆ†clock providerä»¥åŠclock<br>
providerç”¨æ¥æä¾›è·å–clockçš„åŠŸèƒ½ï¼Œè·å–clockéƒ½éœ€è¦é€šè¿‡provideræ¥è·å¾—<br>
</p>
</div>
<div id="outline-container-orgab604d1" class="outline-4">
<h4 id="orgab604d1">provider</h4>
<div class="outline-text-4" id="text-orgab604d1">
<p>
Linuxç³»ç»Ÿé€šè¿‡ä¸¤ä¸ªå…¨å±€çš„åˆ—è¡¨æ¥ç®¡ç†clock providerï¼Œæ‰€æœ‰è·å–clockçš„æ“ä½œéƒ½éœ€è¦ä»è¿™ä¸¤ä¸ªé“¾è¡¨ä¸­è·å–ã€‚<br>
<img src="/assets/.Linux-Clock-Manage.png"><br>
</p>
</div>

<ul class="org-ul">
<li><a id="of_clk_providers"></a><a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/clk.c#L4482">of_clk_providersåˆ—è¡¨</a><br>
<div class="outline-text-5" id="text-of_clk_providers">
<p>
è¿™ä¸ªåˆ—è¡¨ä¸€èˆ¬åœ¨clockåˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–ï¼ˆä¹Ÿå¯ä»¥åœ¨ä»»ä½•ä½å€é€šè¿‡of_clk_add_hw_providerï¼Œ of_clk_add_providerï¼‰æ¥æ’å…¥ã€‚<br>
ç”±äºåŒ¹é…æ•°æ®ä¸­åŒ…å«äº†device_nodeèŠ‚ç‚¹ï¼Œæ‰€ä»¥å¯ä»¥ä»device-tree nodeä¸­è¿›è¡Œç²¾å‡†åŒ¹é…ï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šå‚æ•°ï¼Œæ¥è·å–åˆ°ä¸åŒçš„clock.<br>
</p>
</div>
</li>
<li><a id="clocks"></a>clocksåˆ—è¡¨<br>
<div class="outline-text-5" id="text-clocks">
<p>
 <a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/clkdev.c#L24">kernel source for clocks list</a><br>
è¿™ä¸ªåˆ—è¡¨é€šè¿‡<code class="src src-c"><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">clk_lookup</span></code>ç»“æ„ä½“æ¥ç®¡ç†ï¼Œé€šè¿‡clkdev_allocç­‰APIæ¥è¿›è¡Œæ·»åŠ clock<br>
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orga1d6d51" class="outline-4">
<h4 id="orga1d6d51">clks</h4>
<div class="outline-text-4" id="text-orga1d6d51">
<p>
é€šè¿‡clock provideræ—¢å¯è·å¾—clockï¼Œlinuxä¸­å°†clockæ”¾å…¥å…¨å±€çš„åˆ—è¡¨ä¸­è¿›è¡Œç®¡ç†ã€‚<br>
å½“é€šè¿‡debugfsèŠ‚ç‚¹/sys/kernel/debug/clk/clk_summaryå’Œ/sys/kernel/debug/clk/clk_dumpæŸ¥çœ‹clockä¿¡æ¯æ—¶å°±æ˜¯ä»è¿™ä¸ªåœ°æ–¹æ¥è·å–çš„clockä¿¡æ¯ã€‚<br>
</p>
<ul class="org-ul">
<li><a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/clk.c#L36">clk_root_list</a><br></li>
<li><a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/clk.c#L37">clk_orphan_list</a><br></li>
</ul>
</div>
</div>
<div id="outline-container-orged22390" class="outline-4">
<h4 id="orged22390">è·å–clock</h4>
<div class="outline-text-4" id="text-orged22390">
<ul class="org-ul">
<li><p>
deviceå‡½æ•°<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/include/linux/clk.h#L330">clk_get</a><br>
</p>
<div class="org-src-container">
<pre class="src src-c"><code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">clk</span> *<span style="color: #c678dd;">clk_get</span>(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">device</span> *<span style="color: #dcaeea;">dev</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">char</span> *<span style="color: #dcaeea;">id</span>);</code>
<code><span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">__must_check</span> clk_bulk_get(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">device</span> *<span style="color: #dcaeea;">dev</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">num_clks</span>,</code>
<code>            <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">clk_bulk_data</span> *<span style="color: #dcaeea;">clks</span>);</code>
<code><span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">__must_check</span> devm_clk_bulk_get(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">device</span> *<span style="color: #dcaeea;">dev</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">num_clks</span>,</code>
<code>                <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">clk_bulk_data</span> *<span style="color: #dcaeea;">clks</span>);</code>
<code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">clk</span> *<span style="color: #c678dd;">devm_clk_get</span>(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">device</span> *<span style="color: #dcaeea;">dev</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">char</span> *<span style="color: #dcaeea;">id</span>);</code>
<code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">clk</span> *<span style="color: #c678dd;">devm_get_clk_from_child</span>(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">device</span> *<span style="color: #dcaeea;">dev</span>,</code>
<code>                <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">device_node</span> *<span style="color: #dcaeea;">np</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">char</span> *<span style="color: #dcaeea;">con_id</span>);</code>
</pre>
</div>
<p>
ä¸Šè¿°APIçš„å…¥å£éƒ½æ˜¯clk_getï¼Œdevmå’Œbulkéƒ½æ˜¯å¯¹clk_getçš„ç®€å•å°è£…ï¼Œå½“ç³»ç»Ÿè·å–clockæ—¶ï¼Œä¼šä»ä¸¤ä¸ªåœ°æ–¹è·å–æ—¶é’Ÿï¼Œåˆ†åˆ«ä¸ºï¼š<br>
</p>
<ol class="org-ol">
<li>é€šè¿‡ofç³»åˆ—å‡½æ•°ä»<a href="#of_clk_providers">of_clk_providers</a>åˆ—è¡¨è·å–<br>
å½“ç³»ç»Ÿå¯ä»¥ä»of_clk_providersåŒ¹é…åˆ°clockæ—¶ï¼Œå°±ä¸ä¼šå†å°è¯•ä»å…¨å±€çš„clocksåˆ—è¡¨æ¥è·å–clockäº†ã€‚<br></li>
<li>å…¨å±€çš„<a href="#clocks">clocks</a>åˆ—è¡¨ï¼Œé€šè¿‡clockåå­—ä»¥åŠdev_idè¿›è¡ŒåŒ¹é…,å…·ä½“çš„åŒ¹é…é€»è¾‘ç»†èŠ‚å¯ä»¥ä» kernel_src:drivers/clk/clkdev.c#clk_findæ¥æŸ¥çœ‹<br></li>
</ol></li>

<li><p>
ofå‡½æ•°<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/include/linux/clk.h#L1009">of_clk_*</a><br>
</p>
<div class="org-src-container">
<pre class="src src-c"><code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">clk</span> *<span style="color: #c678dd;">of_clk_get</span>(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">device_node</span> *<span style="color: #dcaeea;">np</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">index</span>);</code>
<code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">clk</span> *<span style="color: #c678dd;">of_clk_get_by_name</span>(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">device_node</span> *<span style="color: #dcaeea;">np</span>, <span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">char</span> *<span style="color: #dcaeea;">name</span>);</code>
<code><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">clk</span> *<span style="color: #c678dd;">of_clk_get_from_provider</span>(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">of_phandle_args</span> *<span style="color: #dcaeea;">clkspec</span>);</code>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org9a061d5" class="outline-4">
<h4 id="org9a061d5"><a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/include/linux/clk.h#L250">clk_prepare</a></h4>
<div class="outline-text-4" id="text-org9a061d5">
<p>
æ­¤å‡½æ•°å†…éƒ¨ä¼šè·å–å…¨å±€çš„mutex lock (å¯é‡å…¥)<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/clk.c#L133">kernel source for clk_prepare_lock</a><br>
Clockåœ¨å¼€å¯ï¼Œå…³é—­æ—¶å¯èƒ½ä¼šéœ€è¦ä¸€å®šçš„å‡†å¤‡æ¡ä»¶ï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦ç­‰å¾…ç¡¬ä»¶çŠ¶æ€ç¨³å®šï¼Œä¸èƒ½ç«‹åˆ»ç”Ÿæ•ˆã€‚æ‰€ä»¥Linuxå†…æ ¸ä¸­æä¾›äº†clk_prepareå‡½æ•°æ¥å¤„ç†è¿™ç§çŠ¶å†µã€‚<br>
ä¾‹å¦‚ï¼šPLLåœ¨å¼€å¯ï¼Œåˆ‡æ¢é¢‘ç‡æ—¶ï¼Œéœ€è¦ç­‰å¾…æ—¶é’Ÿé‡æ–°é”å®š<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup> <sup>, </sup><sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œå› æ­¤é©±åŠ¨åœ¨å¿«é€Ÿå¼€å¯æ—¶é’Ÿæ—¶ï¼Œä¸é€‚åˆè¿›è¡Œpllçš„lockæ“ä½œã€‚å› æ­¤pllçš„å¼€å¯æ“ä½œä¸€èˆ¬åœ¨prepareé˜¶æ®µå®Œæˆã€‚<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/imx/clk-frac-pll.c#L65">kernel source for drivers/clk/imx/clk-frac-pll.c</a><br>
å¯¹äºscmiçš„clockï¼Œç³»ç»Ÿä¹Ÿæ˜¯ä¸€æ ·å…·æœ‰ç±»ä¼¼çš„é—®é¢˜ï¼Œç”±äºscmiéœ€è¦å’Œå…¶ä»–çš„å¼‚æ„æ ¸æˆ–è€…firmwareè¿›è¡Œäº¤äº’ï¼Œè€—æ—¶æ¯”è¾ƒé•¿. å› æ­¤å¼€å…³clockçš„æ“ä½œéƒ½åœ¨prepare/unprepareä¸­å®Œæˆï¼Œå¹¶ä¸”æ²¡æœ‰æä¾›enable/disableçš„æ¥å£ã€‚<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/clk-scmi.c#L91">kernel source for scmi_clk_ops</a><br>
å‚è€ƒèµ„æ–™ï¼š <sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup><br>
</p>
</div>
</div>
<div id="outline-container-org97da0b8" class="outline-4">
<h4 id="org97da0b8"><a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/include/linux/clk.h#L531">clk_enable</a></h4>
<div class="outline-text-4" id="text-org97da0b8">
<p>
è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°å®Œæˆå®é™…çš„å¼€å…³æ“ä½œã€‚<br>
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå‡½æ•°åœ¨è°ƒç”¨æ—¶ä¼šè·å–ä¸€æŠŠå…¨å±€çš„spinlock enable_lock, (æ­¤lockå·²åšäº†é‡å…¥æ”¯æŒ)<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/clk.c#L159">kernel source for clk_enable_lock</a><br>
call_graph<br>
</p>
<div class="org-src-container">
<pre class="src src-txt"><code>clk_enable(clk);</code>
<code>    clk-&gt;ops-&gt;enable(clk-&gt;hw);</code>
<code>    [resolves to...]</code>
<code>        clk_gate_enable(hw);</code>
<code>        [resolves struct clk gate with to_clk_gate(hw)]</code>
<code>            clk_gate_set_bit(gate);</code>
</pre>
</div>
</div>
</div>
<div id="outline-container-org01b1d6f" class="outline-4">
<h4 id="org01b1d6f">clk_set_rate</h4>
<div class="outline-text-4" id="text-org01b1d6f">
<p>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/clk.c#L2243">kernel source for clk_set_rate</a><br>
è¿™ä¸ªä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œè®¾ç½®é¢‘ç‡,ä½†æ˜¯å®ç°æ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºéœ€è¦å¤„ç†parentå…³ç³»ï¼Œå¹¶ä¸”é’ˆå¯¹å¤šparentçš„æƒ…å†µä¹Ÿéœ€è¦å¯ä»¥æ­£å¸¸å¤„ç†ã€‚<br>
call_graph<br>
</p>
<div class="org-src-container">
<pre class="src src-txt"><code>clk_set_rate(clk, rate);</code>
<code>    clk_calc_new_rates(core, rate);</code>
<code>        clk-&gt;ops-&gt;determine_rate</code>
<code>        clk-&gt;ops-&gt;round_rate</code>
<code>        clk_calc_new_rates(parent, rate); // parent clock</code>
</pre>
</div>
<ul class="org-ul">
<li>determine_rate<br>
è¿™ä¸ªæ¥å£å‡½æ•°æ˜¯æœ€ä¼˜å…ˆä½¿ç”¨çš„opsï¼Œå¯ä»¥å¤„ç†å¤šparentçš„æƒ…å†µï¼Œmux lockä¸­å°±é€šè¿‡<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/drivers/clk/clk-mux.c#L129">clk_mux_determine_rate</a>æ¥å¤„ç†å¤šparentçš„æƒ…å†µã€‚<br></li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<a href="https://www.jedec.org/standards-documents/dictionary/terms/pll-lock-time-after-frequency-change-tlomega">PLL lock time after frequency change</a><br>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
<a href="https://ewh.ieee.org/r5/denver/sscs/Presentations/2007_05_Fischette.pdf">Phase-Locked Loop Basics (PLL)</a><br>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
<a href="https://stackoverflow.com/questions/17262063/linux-kernel-clock-framework-what-is-role-of-clk-prepare-unprepare">Linux Kernel - Clock Framework - What is role of clk_prepare/unprepare?</a><br>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
