<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2023-04-14 Fri 15:32 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OPTEE persistent-object</title>
<meta name="description" content="persistent-object.org" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">OPTEE persistent-object</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgd8b83f5">Description</a></li>
<li><a href="#org094c898">Secure storage</a></li>
<li><a href="#org46a2471">Usage (secure storage)</a>
<ul>
<li><a href="#org5791c1b">userspace</a></li>
<li><a href="#orge5300b4">ta</a></li>
</ul>
</li>
<li><a href="#org29d50d9">TEE PersistentObject</a>
<ul>
<li><a href="#org006c8e4">API optee_os/lib/libutee/include/ltee_api.h</a></li>
<li><a href="#orga4872f5">TEE_CreatePersistentObject</a></li>
<li><a href="#org8654fd7">ree_fs_ops</a></li>
</ul>
</li>
<li><a href="#org284a79c">All Operation flow</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd8b83f5" class="outline-2">
<h2 id="orgd8b83f5">Description</h2>
<div class="outline-text-2" id="text-orgd8b83f5">
<p>
PersistentObjecté¡¾åæ€è®®ï¼Œæ˜¯å¯ä»¥æŒä¹…åŒ–ä¿å­˜çš„å¯¹è±¡ï¼Œä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹å®ç°çš„åŸç†ã€‚<br>
</p>
</div>
</div>

<div id="outline-container-org094c898" class="outline-2">
<h2 id="org094c898">Secure storage</h2>
<div class="outline-text-2" id="text-org094c898">
<p>
é¦–å…ˆï¼Œçœ‹ä¸€ä¸‹opteeå¦‚ä½•å¤„ç†secureæ•°æ®çš„å­˜å‚¨ï¼ŒåŠ å¯†ã€‚<br>
opteeå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://optee.readthedocs.io/en/latest/architecture/secure_storage.html#ree-fs-secure-storage">https://optee.readthedocs.io/en/latest/architecture/secure_storage.html#ree-fs-secure-storage</a><br>
ç³»ç»Ÿæ¡†æ¶ï¼š<br>
<img src="https://optee.readthedocs.io/en/latest/_images/secure_storage_system_architecture.png" alt="secure_storage_system_architecture.png"><br>
</p>

<p>
ç”±ä¸Šå›¾å¯çŸ¥ï¼Œæ•´ä¸ªæµç¨‹å¤§è‡´ä¸ºï¼šTEE File Systemåœ¨ä¿å­˜æ–‡ä»¶æ—¶ï¼Œé¦–å…ˆé€šè¿‡teeä¸­çš„æ–‡ä»¶ç³»ç»Ÿæ¥å£è°ƒç”¨linuxå†…æ ¸ä¸­çš„TEE driverï¼ŒTEE driverå†è°ƒç”¨å†…æ ¸æ€çš„TEE Supplicantæ¥å®Œæˆæ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®ã€‚æœ€ç»ˆçš„æ–‡ä»¶å­˜å‚¨æ“ä½œæ˜¯é€šè¿‡reeçš„æ–‡ä»¶ç³»ç»Ÿæ¥å­˜å‚¨ï¼Œæ‰€ä»¥åªè¦reeå¯ä»¥è¯»å†™æ–‡ä»¶ï¼Œè¿™æ¡é“¾è·¯å°±å¯ä»¥æ­£å¸¸è¿è¡Œã€‚<br>
</p>
</div>
</div>

<div id="outline-container-org46a2471" class="outline-2">
<h2 id="org46a2471">Usage (secure storage)</h2>
<div class="outline-text-2" id="text-org46a2471">
</div>
<div id="outline-container-org5791c1b" class="outline-3">
<h3 id="org5791c1b">userspace</h3>
<div class="outline-text-3" id="text-org5791c1b">
<ol class="org-ol">
<li>create session<br></li>
<li><p>
write secure object<br>
</p>
<div class="org-src-container">
<pre class="src src-c"><code><span class="org-type">TEEC_Result</span> <span class="org-function-name">write_secure_object</span>(<span class="org-keyword">struct</span> <span class="org-type">test_ctx</span> *<span class="org-variable-name">ctx</span>, <span class="org-type">char</span> *<span class="org-variable-name">id</span>,</code>
<code>            <span class="org-type">char</span> *<span class="org-variable-name">data</span>, <span class="org-type">size_t</span> <span class="org-variable-name">data_len</span>)</code>
<code>{</code>
<code>    <span class="org-type">TEEC_Operation</span> <span class="org-variable-name">op</span>;</code>
<code>    <span class="org-type">uint32_t</span> <span class="org-variable-name">origin</span>;</code>
<code>    <span class="org-type">TEEC_Result</span> <span class="org-variable-name">res</span>;</code>
<code>    <span class="org-type">size_t</span> <span class="org-variable-name">id_len</span> = strlen(id);</code>
<code></code>
<code>    memset(&amp;op, 0, <span class="org-keyword">sizeof</span>(op));</code>
<code>    op.paramTypes = TEEC_PARAM_TYPES(TEEC_MEMREF_TEMP_INPUT,</code>
<code>                     TEEC_MEMREF_TEMP_INPUT,</code>
<code>                     TEEC_NONE, TEEC_NONE);</code>
<code></code>
<code>    op.params[0].tmpref.buffer = id;</code>
<code>    op.params[0].tmpref.size = id_len;</code>
<code></code>
<code>    op.params[1].tmpref.buffer = data;</code>
<code>    op.params[1].tmpref.size = data_len;</code>
<code></code>
<code>    res = TEEC_InvokeCommand(&amp;ctx-&gt;sess,</code>
<code>                 TA_SECURE_STORAGE_CMD_WRITE_RAW,</code>
<code>                 &amp;op, &amp;origin);</code>
<code>    <span class="org-keyword">if</span> (res != TEEC_SUCCESS)</code>
<code>        printf(<span class="org-string">"Command WRITE_RAW failed: 0x%x / %u\n"</span>, res, origin);</code>
<code></code>
<code>    <span class="org-keyword">switch</span> (res) {</code>
<code>    <span class="org-keyword">case</span> TEEC_SUCCESS:</code>
<code>        <span class="org-keyword">break</span>;</code>
<code>    <span class="org-keyword">default</span>:</code>
<code>        printf(<span class="org-string">"Command WRITE_RAW failed: 0x%x / %u\n"</span>, res, origin);</code>
<code>    }</code>
<code></code>
<code>    <span class="org-keyword">return</span> res;</code>
<code>}</code>
<code></code>
</pre>
</div>
<p>
è¿™é‡Œä¼ é€’äº†ä¸¤ä¸ªå‚æ•°<br>
</p>
<ul class="org-ul">
<li>object id<br>
å­—ç¬¦ä¸²ç±»å‹id<br></li>
<li>data<br>
è¦å†™å…¥çš„æ•°æ®<br></li>
</ul>
<p>
ä½¿ç”¨invokeè°ƒç”¨TA_SECURE_STORAGE_CMD_WRITE_RAWå‘½ä»¤<br>
</p></li>
<li><p>
delete_secure_object<br>
</p>
<div class="org-src-container">
<pre class="src src-c"><code><span class="org-type">TEEC_Result</span> <span class="org-function-name">delete_secure_object</span>(<span class="org-keyword">struct</span> <span class="org-type">test_ctx</span> *<span class="org-variable-name">ctx</span>, <span class="org-type">char</span> *<span class="org-variable-name">id</span>)</code>
<code>{</code>
<code>    <span class="org-type">TEEC_Operation</span> <span class="org-variable-name">op</span>;</code>
<code>    <span class="org-type">uint32_t</span> <span class="org-variable-name">origin</span>;</code>
<code>    <span class="org-type">TEEC_Result</span> <span class="org-variable-name">res</span>;</code>
<code>    <span class="org-type">size_t</span> <span class="org-variable-name">id_len</span> = strlen(id);</code>
<code></code>
<code>    memset(&amp;op, 0, <span class="org-keyword">sizeof</span>(op));</code>
<code>    op.paramTypes = TEEC_PARAM_TYPES(TEEC_MEMREF_TEMP_INPUT,</code>
<code>                                     TEEC_NONE, TEEC_NONE, TEEC_NONE);</code>
<code></code>
<code>    op.params[0].tmpref.buffer = id;</code>
<code>    op.params[0].tmpref.size = id_len;</code>
<code></code>
<code>    res = TEEC_InvokeCommand(&amp;ctx-&gt;sess,</code>
<code>                             TA_SECURE_STORAGE_CMD_DELETE,</code>
<code>                             &amp;op, &amp;origin);</code>
<code></code>
<code>    <span class="org-keyword">switch</span> (res) {</code>
<code>    <span class="org-keyword">case</span> TEEC_SUCCESS:</code>
<code>    <span class="org-keyword">case</span> TEEC_ERROR_ITEM_NOT_FOUND:</code>
<code>        <span class="org-keyword">break</span>;</code>
<code>    <span class="org-keyword">default</span>:</code>
<code>        printf(<span class="org-string">"Command DELETE failed: 0x%x / %u\n"</span>, res, origin);</code>
<code>    }</code>
<code></code>
<code>    <span class="org-keyword">return</span> res;</code>
<code>}</code>
<code></code>
</pre>
</div>

<p>
åˆ é™¤æ“ä½œä¼ å…¥äº†object id<br>
</p></li>
</ol>
</div>
</div>
<div id="outline-container-orge5300b4" class="outline-3">
<h3 id="orge5300b4">ta</h3>
<div class="outline-text-3" id="text-orge5300b4">
<ul class="org-ul">
<li><p>
TA_SECURE_STORAGE_CMD_WRITE_RAW<br>
</p>
<div class="org-src-container">
<pre class="src src-c"><code><span class="org-keyword">static</span> <span class="org-type">TEE_Result</span> <span class="org-function-name">create_raw_object</span>(<span class="org-type">uint32_t</span> <span class="org-variable-name">param_types</span>, <span class="org-type">TEE_Param</span> <span class="org-variable-name">params</span>[4])</code>
<code>{</code>
<code>    ...</code>
<code>    <span class="org-comment-delimiter">/*</span></code>
<code><span class="org-comment">     * Create object in secure storage and fill with data</span></code>
<code><span class="org-comment-delimiter">     */</span></code>
<code>    obj_data_flag = TEE_DATA_FLAG_ACCESS_READ |         <span class="org-comment-delimiter">/* </span><span class="org-comment">we can later read the oject</span><span class="org-comment-delimiter"> */</span></code>
<code>            TEE_DATA_FLAG_ACCESS_WRITE |                <span class="org-comment-delimiter">/* </span><span class="org-comment">we can later write into the object</span><span class="org-comment-delimiter"> */</span></code>
<code>            TEE_DATA_FLAG_ACCESS_WRITE_META |   <span class="org-comment-delimiter">/* </span><span class="org-comment">we can later destroy or rename the object</span><span class="org-comment-delimiter"> */</span></code>
<code>            TEE_DATA_FLAG_OVERWRITE;            <span class="org-comment-delimiter">/* </span><span class="org-comment">destroy existing object of same ID</span><span class="org-comment-delimiter"> */</span></code>
<code></code>
<code>    res = TEE_CreatePersistentObject(TEE_STORAGE_PRIVATE,</code>
<code>                    obj_id, obj_id_sz,</code>
<code>                    obj_data_flag,</code>
<code>                    TEE_HANDLE_NULL,</code>
<code>                    <span class="org-constant">NULL</span>, 0,            <span class="org-comment-delimiter">/* </span><span class="org-comment">we may not fill it right now</span><span class="org-comment-delimiter"> */</span></code>
<code>                    &amp;object);</code>
<code>    <span class="org-keyword">if</span> (res != TEE_SUCCESS) {</code>
<code>        EMSG(<span class="org-string">"TEE_CreatePersistentObject failed 0x%08x"</span>, res);</code>
<code>        TEE_Free(obj_id);</code>
<code>        <span class="org-keyword">return</span> res;</code>
<code>    }</code>
<code></code>
<code>    res = TEE_WriteObjectData(object, data, data_sz);</code>
<code>    <span class="org-keyword">if</span> (res != TEE_SUCCESS) {</code>
<code>        EMSG(<span class="org-string">"TEE_WriteObjectData failed 0x%08x"</span>, res);</code>
<code>        TEE_CloseAndDeletePersistentObject1(object);</code>
<code>    } <span class="org-keyword">else</span> {</code>
<code>        TEE_CloseObject(object);</code>
<code>    }</code>
<code>    ...</code>
<code>}</code>
<code></code>
</pre>
</div>
<ol class="org-ol">
<li>TEE_CreatePersistentObject<br></li>
<li>TEE_WriteObjectData<br></li>
</ol></li>
<li><p>
TA_SECURE_STORAGE_CMD_DELETE<br>
</p>
<div class="org-src-container">
<pre class="src src-c"><code><span class="org-keyword">static</span> <span class="org-type">TEE_Result</span> <span class="org-function-name">delete_object</span>(<span class="org-type">uint32_t</span> <span class="org-variable-name">param_types</span>, <span class="org-type">TEE_Param</span> <span class="org-variable-name">params</span>[4])</code>
<code>{</code>
<code>    <span class="org-keyword">const</span> <span class="org-type">uint32_t</span> <span class="org-variable-name">exp_param_types</span> =</code>
<code>        TEE_PARAM_TYPES(TEE_PARAM_TYPE_MEMREF_INPUT,</code>
<code>                TEE_PARAM_TYPE_NONE,</code>
<code>                TEE_PARAM_TYPE_NONE,</code>
<code>                TEE_PARAM_TYPE_NONE);</code>
<code>    <span class="org-type">TEE_ObjectHandle</span> <span class="org-variable-name">object</span>;</code>
<code>    <span class="org-type">TEE_Result</span> <span class="org-variable-name">res</span>;</code>
<code>    <span class="org-type">char</span> *<span class="org-variable-name">obj_id</span>;</code>
<code>    <span class="org-type">size_t</span> <span class="org-variable-name">obj_id_sz</span>;</code>
<code></code>
<code>    <span class="org-comment-delimiter">/*</span></code>
<code><span class="org-comment">     * Safely get the invocation parameters</span></code>
<code><span class="org-comment-delimiter">     */</span></code>
<code>    <span class="org-keyword">if</span> (param_types != exp_param_types)</code>
<code>        <span class="org-keyword">return</span> TEE_ERROR_BAD_PARAMETERS;</code>
<code></code>
<code>    obj_id_sz = params[0].memref.size;</code>
<code>    obj_id = TEE_Malloc(obj_id_sz, 0);</code>
<code>    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>obj_id)</code>
<code>        <span class="org-keyword">return</span> TEE_ERROR_OUT_OF_MEMORY;</code>
<code></code>
<code>    TEE_MemMove(obj_id, params[0].memref.buffer, obj_id_sz);</code>
<code></code>
<code>    <span class="org-comment-delimiter">/*</span></code>
<code><span class="org-comment">     * Check object exists and delete it</span></code>
<code><span class="org-comment-delimiter">     */</span></code>
<code>    res = TEE_OpenPersistentObject(TEE_STORAGE_PRIVATE,</code>
<code>                    obj_id, obj_id_sz,</code>
<code>                    TEE_DATA_FLAG_ACCESS_READ |</code>
<code>                    TEE_DATA_FLAG_ACCESS_WRITE_META, <span class="org-comment-delimiter">/* </span><span class="org-comment">we must be allowed to delete it</span><span class="org-comment-delimiter"> */</span></code>
<code>                    &amp;object);</code>
<code>    <span class="org-keyword">if</span> (res != TEE_SUCCESS) {</code>
<code>        EMSG(<span class="org-string">"Failed to open persistent object, res=0x%08x"</span>, res);</code>
<code>        TEE_Free(obj_id);</code>
<code>        <span class="org-keyword">return</span> res;</code>
<code>    }</code>
<code></code>
<code>    TEE_CloseAndDeletePersistentObject1(object);</code>
<code>    TEE_Free(obj_id);</code>
<code></code>
<code>    <span class="org-keyword">return</span> res;</code>
<code>}</code>
<code></code>
</pre>
</div>
<ol class="org-ol">
<li>æ‰“å¼€å¯¹è±¡<br>
TEE_OpenPersistentObject<br></li>
<li>åˆ é™¤å¯¹è±¡<br></li>
</ol>
<p>
TEE_CloseAndDeletePersistentObject1<br>
</p></li>
</ul>

<p>
ä»taå¯ä»¥çœ‹åˆ°teeä¸­ä½¿ç”¨äº†TEE_*PersistentObjectçš„api<br>
</p>
</div>
</div>
</div>

<div id="outline-container-org29d50d9" class="outline-2">
<h2 id="org29d50d9">TEE PersistentObject</h2>
<div class="outline-text-2" id="text-org29d50d9">
</div>
<div id="outline-container-org006c8e4" class="outline-3">
<h3 id="org006c8e4">API optee_os/lib/libutee/include/ltee_api.h</h3>
<div class="outline-text-3" id="text-org006c8e4">
<div class="org-src-container">
<pre class="src src-c"><code><span class="org-comment-delimiter">/* </span><span class="org-comment">Data and Key Storage API  - Persistent Object Functions</span><span class="org-comment-delimiter"> */</span></code>
<code></code>
<code><span class="org-type">TEE_Result</span> <span class="org-function-name">TEE_OpenPersistentObject</span>(<span class="org-type">uint32_t</span> <span class="org-variable-name">storageID</span>, <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">objectID</span>,</code>
<code>                    <span class="org-type">uint32_t</span> <span class="org-variable-name">objectIDLen</span>, <span class="org-type">uint32_t</span> <span class="org-variable-name">flags</span>,</code>
<code>                    <span class="org-type">TEE_ObjectHandle</span> *<span class="org-variable-name">object</span>);</code>
<code></code>
<code><span class="org-type">TEE_Result</span> <span class="org-function-name">TEE_CreatePersistentObject</span>(<span class="org-type">uint32_t</span> <span class="org-variable-name">storageID</span>, <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">objectID</span>,</code>
<code>                      <span class="org-type">uint32_t</span> <span class="org-variable-name">objectIDLen</span>, <span class="org-type">uint32_t</span> <span class="org-variable-name">flags</span>,</code>
<code>                      <span class="org-type">TEE_ObjectHandle</span> <span class="org-variable-name">attributes</span>,</code>
<code>                      <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">initialData</span>,</code>
<code>                      <span class="org-type">uint32_t</span> <span class="org-variable-name">initialDataLen</span>,</code>
<code>                      <span class="org-type">TEE_ObjectHandle</span> *<span class="org-variable-name">object</span>);</code>
<code></code>
<code><span class="org-type">void</span> <span class="org-function-name">TEE_CloseAndDeletePersistentObject</span>(<span class="org-type">TEE_ObjectHandle</span> <span class="org-variable-name">object</span>);</code>
<code></code>
<code><span class="org-type">TEE_Result</span> <span class="org-function-name">TEE_CloseAndDeletePersistentObject1</span>(<span class="org-type">TEE_ObjectHandle</span> <span class="org-variable-name">object</span>);</code>
<code></code>
<code><span class="org-type">TEE_Result</span> <span class="org-function-name">TEE_RenamePersistentObject</span>(<span class="org-type">TEE_ObjectHandle</span> <span class="org-variable-name">object</span>,</code>
<code>                      <span class="org-keyword">const</span> <span class="org-type">void</span> *<span class="org-variable-name">newObjectID</span>,</code>
<code>                      <span class="org-type">uint32_t</span> <span class="org-variable-name">newObjectIDLen</span>);</code>
<code></code>
<code><span class="org-type">TEE_Result</span> <span class="org-function-name">TEE_AllocatePersistentObjectEnumerator</span>(<span class="org-type">TEE_ObjectEnumHandle</span> *</code>
<code>                          <span class="org-variable-name">objectEnumerator</span>);</code>
<code></code>
<code><span class="org-type">void</span> <span class="org-function-name">TEE_FreePersistentObjectEnumerator</span>(<span class="org-type">TEE_ObjectEnumHandle</span> <span class="org-variable-name">objectEnumerator</span>);</code>
<code></code>
<code><span class="org-type">void</span> <span class="org-function-name">TEE_ResetPersistentObjectEnumerator</span>(<span class="org-type">TEE_ObjectEnumHandle</span> <span class="org-variable-name">objectEnumerator</span>);</code>
<code></code>
<code><span class="org-type">TEE_Result</span> <span class="org-function-name">TEE_StartPersistentObjectEnumerator</span>(<span class="org-type">TEE_ObjectEnumHandle</span></code>
<code>                           <span class="org-variable-name">objectEnumerator</span>,</code>
<code>                           <span class="org-type">uint32_t</span> <span class="org-variable-name">storageID</span>);</code>
<code></code>
<code><span class="org-type">TEE_Result</span> <span class="org-function-name">TEE_GetNextPersistentObject</span>(<span class="org-type">TEE_ObjectEnumHandle</span> <span class="org-variable-name">objectEnumerator</span>,</code>
<code>                       <span class="org-type">TEE_ObjectInfo</span> *<span class="org-variable-name">objectInfo</span>,</code>
<code>                       <span class="org-type">void</span> *<span class="org-variable-name">objectID</span>, <span class="org-type">uint32_t</span> *<span class="org-variable-name">objectIDLen</span>);</code>
<code></code>
</pre>
</div>
<p>
è¿™é‡Œå…±æœ‰10ä¸ªapiæä¾›äº†openï¼Œnewï¼Œenumï¼Œrenameçš„åŠŸèƒ½<br>
</p>


<div id="orgc07260a" class="figure">
<p><img src="assets/persistentobject-api-map.png" alt="persistentobject-api-map.png"><br>
</p>
</div>
</div>
</div>

<div id="outline-container-orga4872f5" class="outline-3">
<h3 id="orga4872f5">TEE_CreatePersistentObject</h3>
<div class="outline-text-3" id="text-orga4872f5">
<p>
è¿™ä¸ªå‡½æ•°æ˜¯å¯¹optee_osä¸­ç³»ç»Ÿè°ƒç”¨çš„å°è£…<br>
ä»ä¸Šä¸ªç« èŠ‚å¯çŸ¥æœ€ç»ˆè°ƒç”¨äº†optee_osä¸­çš„syscall_storage_obj_create<br>
</p>
<ol class="org-ol">
<li>æ ¹æ®storage_idè·å–æ–‡ä»¶ç³»ç»Ÿæ¥å£ `struct tee_file_operations`<br></li>
<li>æ ¹æ®object_idè·å–tee_pobj<br></li>
<li>ç”Ÿæˆæ–°çš„tee_objå¹¶å°†å…¶ä¸tee_pobjç»‘å®š<br></li>
<li>è°ƒç”¨tee_svc_storage_init_fileåˆå§‹åŒ–æ–‡ä»¶<br></li>
<li>å°†tee_objè¿”å›ç»™ç”¨æˆ·ç©ºé—´ç¨‹åºï¼ˆTAï¼‰<br></li>
</ol>
<p>
é‡ç‚¹å†…å®¹ï¼š<br>
</p>
</div>
<ul class="org-ul">
<li><a id="org0ac182e"></a><span class="todo TODO">TODO</span> pobj<br></li>

<li><a id="org0e5ff62"></a>tee_svc_storage_init_file<br>
<div class="outline-text-4" id="text-org0e5ff62">
<ol class="org-ol">
<li>å°†tee_obj_atträ¿å­˜åœ¨æ–‡ä»¶ä¸­<br></li>
</ol>
<pre class="example">
<code>    ...</code>
<code>    if (attr_o) {</code>
<code>    res = tee_obj_set_type(o, attr_o-&gt;info.objectType,</code>
<code>                   attr_o-&gt;info.maxKeySize);</code>
<code>    if (res)</code>
<code>        return res;</code>
<code>    res = tee_obj_attr_copy_from(o, attr_o);</code>
<code>    if (res)</code>
<code>        return res;</code>
<code>    o-&gt;have_attrs = attr_o-&gt;have_attrs;</code>
<code>    o-&gt;info.objectUsage = attr_o-&gt;info.objectUsage;</code>
<code>    o-&gt;info.keySize = attr_o-&gt;info.keySize;</code>
<code>    res = tee_obj_attr_to_binary(o, NULL, &amp;attr_size);</code>
<code>    if (res)</code>
<code>        return res;</code>
<code>    if (attr_size) {</code>
<code>        attr = malloc(attr_size);</code>
<code>        if (!attr)</code>
<code>            return TEE_ERROR_OUT_OF_MEMORY;</code>
<code>        res = tee_obj_attr_to_binary(o, attr, &amp;attr_size);</code>
<code>        if (res != TEE_SUCCESS)</code>
<code>            goto exit;</code>
<code>    }</code>
<code>} else {</code>
<code>    res = tee_obj_set_type(o, TEE_TYPE_DATA, 0);</code>
<code>    if (res != TEE_SUCCESS)</code>
<code>        goto exit;</code>
<code>}</code>
<code>...</code>
<code>o-&gt;ds_pos = sizeof(struct tee_svc_storage_head) + attr_size;</code>
<code></code>
<code>/* write head */</code>
<code>head.attr_size = attr_size;</code>
<code>head.keySize = o-&gt;info.keySize;</code>
<code>head.maxKeySize = o-&gt;info.maxKeySize;</code>
<code>head.objectUsage = o-&gt;info.objectUsage;</code>
<code>head.objectType = o-&gt;info.objectType;</code>
<code>head.have_attrs = o-&gt;have_attrs;</code>
<code></code>
<code>res = fops-&gt;create(o-&gt;pobj, !!(o-&gt;flags &amp; TEE_DATA_FLAG_OVERWRITE),</code>
<code>           &amp;head, sizeof(head), attr, attr_size, data, len,</code>
<code>           &amp;o-&gt;fh);</code>
<code></code>
<code>if (!res)</code>
<code>    o-&gt;info.dataSize = len;</code>
<code></code>
</pre>
<p>
ä»£ç ä¸­è°ƒç”¨äº†ä¸¤æ¬¡tee_obj_attr_to_binaryï¼Œç¬¬ä¸€æ¬¡ä¸ºäº†è·å–å¤§å°ï¼Œç¬¬äºŒæ¬¡ä¿å­˜<br>
</p>
<ol class="org-ol">
<li><p>
è°ƒç”¨fops-&gt;createåˆ›å»ºå¯¹è±¡<br>
fops table: tee_svc_storage_file_ops<br>
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">storage_id</th>
<th scope="col" class="org-left">fops</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">TEE_STORAGE_PRIVATE</td>
<td class="org-left">ree_fs_ops/rpmb_fs_ops</td>
</tr>

<tr>
<td class="org-left">TEE_STORAGE_PRIVATE_REE</td>
<td class="org-left">ree_fs_ops</td>
</tr>

<tr>
<td class="org-left">CFG_RPMB_FS</td>
<td class="org-left">rpmb_fs_ops</td>
</tr>
</tbody>
</table></li>
</ol>
</div>
</li>
</ul>
</div>

<div id="outline-container-org8654fd7" class="outline-3">
<h3 id="org8654fd7">ree_fs_ops</h3>
<div class="outline-text-3" id="text-org8654fd7">
</div>
<ul class="org-ul">
<li><a id="orge4c4497"></a>ree_fs_create<br>
<div class="outline-text-4" id="text-orge4c4497">

<div id="org8c5a8d6" class="figure">
<p><img src="assets/ree_fs_create.png" alt="ree_fs_create.png"><br>
</p>
</div>

<ol class="org-ol">
<li>get_dirh æ‰“å¼€æ–‡ä»¶å¤¹ï¼ˆå…¨å±€å”¯ä¸€çš„æ–‡ä»¶å¤¹ï¼‰<br></li>
<li>è·å–ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¥æŸ„ï¼ˆTEEä¸­æ•°æ®ç»“æ„ï¼‰<br></li>
<li>åˆ›å»ºæ–‡ä»¶ï¼ˆè°ƒç”¨rpcæ¥åˆ›å»ºçœŸæ­£çš„æ–‡ä»¶ï¼‰,åˆ›å»ºhtreeæ ¡éªŒæ•°æ®<br></li>
<li>å†™å…¥headerï¼Œ attrï¼Œdata<br></li>
<li>æ›´æ–°hash<br></li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-org284a79c" class="outline-2">
<h2 id="org284a79c">All Operation flow</h2>
<div class="outline-text-2" id="text-org284a79c">

<div id="org89888df" class="figure">
<p><img src="assets/secure-storage-flow.png" alt="secure-storage-flow.png"><br>
</p>
</div>

<p>
ä»ä¸Šé¢çš„æµç¨‹å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿåœ¨è®¿é—®æ–‡ä»¶æ—¶ï¼Œéœ€è¦é€šè¿‡ä¸€ç³»åˆ—çš„æµç¨‹ï¼Œæœ€åé€šè¿‡reeä¸­çš„tee_supplicantæœåŠ¡æ¥å®Œæˆæœ€ç»ˆçš„æ–‡ä»¶è®¿é—®æ“ä½œï¼Œç³»ç»Ÿä¼šåœ¨TEEä¸­å¯¹æ–‡ä»¶è¿›è¡ŒåŠ è§£å¯†çš„æ“ä½œï¼Œè¿™æ ·reeå°±æ— æ³•è·å–teeä¸­ä¿å­˜çš„æ–‡ä»¶çš„å†…å®¹ï¼Œä»è€Œå®‰å…¨çš„å­˜å‚¨æˆ‘ä»¬æ‰€éœ€è¦çš„æ•°æ®ã€‚<br>
åœ¨æ­¤åŸºç¡€ä¸Šï¼ŒTEEè¿˜å¯¹æ•°æ®è¿›è¡Œäº†åŠ å¯†ï¼Œhashæ ¡éªŒï¼Œé˜²æ­¢reeæœ‰æœºä¼šå»çªœæ”¹æ•°æ®ã€‚<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>