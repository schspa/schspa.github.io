<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-03-03 Thu 11:48 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Debug linux kernel boot process</title>
<meta name="author" content="schspa" />
<meta name="description" content="how-to-debugging-linux-booting-code" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">Debug linux kernel boot process</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgac556f7">ç›®çš„</a></li>
<li><a href="#org19c26b1">åˆå§‹åŒ–ä»£ç ï¼ˆMMUå¼€å¯ä¹‹å‰ï¼‰</a>
<ul>
<li><a href="#org6da47cb">è·å–åŠ è½½åœ°å€</a>
<ul>
<li><a href="#orgb9106ea">æ­£ç¡®åŠ è½½ubootçš„symbolåˆ°è¿è¡Œä½ç½®</a></li>
<li><a href="#org5bf8562">åœ¨è·³å…¥å†…æ ¸ä¹‹å‰æ‰“ä¸Šæ–­ç‚¹ï¼Œè·å–å†…æ ¸è¿è¡Œåœ°å€</a></li>
<li><a href="#org0208ded">åŠ è½½.head.textæ®µï¼Œåœ¨å†…æ ¸ç¬¬ä¸€æ¡æŒ‡ä»¤å¤„æ‰“æ–­ç‚¹</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org14df6dc">åˆå§‹ä»£ç ï¼ˆMMUå¼€å¯ä¹‹å)</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgac556f7" class="outline-2">
<h2 id="orgac556f7">ç›®çš„</h2>
<div class="outline-text-2" id="text-orgac556f7">
<p>
å½“linuxå†…æ ¸åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­å‡ºç°bugæ—¶ï¼Œå¯èƒ½éœ€è¦é€‚ç”¨gdb/ulink/ds5 debuggeræ¥è¿›è¡Œdebugï¼Œå¤§å¤šæ•°çš„debugæ–¹æ³•æ—¶åœ¨å¯åŠ¨åï¼Œå†è¿æ¥ä¸Šè°ƒè¯•å™¨ï¼Œæœ€åè¿æ¥ä¸Šè°ƒè¯•å™¨ä¹‹åå†åŠ è½½symbolï¼Œæ‰“æ–­ç‚¹æ¥å®Œæˆdebugã€‚<br>
å¯¹äºå¤§å¤šæ•°çš„æƒ…å†µï¼Œä»¥ä¸Šæ–¹æ³•å°±è¶³ä»¥åº”ä»˜ï¼Œä½†æ˜¯éƒ¨åˆ†æƒ…å†µä¸‹ï¼ˆåœ¨å†…æ ¸åˆå§‹åŒ–æ—©æœŸï¼Œå¯èƒ½è¿˜æ¥ä¸åŠè¿ä¸Šè°ƒè¯•å™¨ï¼Œå†…æ ¸å°±å·²ç»æŒ‚æ‰äº†ï¼‰ï¼Œéœ€è¦æ›´åŠ å¤æ‚çš„æ‰“æ–­ç‚¹æ–¹æ³•ã€‚<br>
è¿™ç¯‡æ–‡ç« å°±é’ˆå¯¹è¿™ç§æƒ…å†µè¿›è¡Œè¯´æ˜ã€‚<br>
å®éªŒç¯å¢ƒï¼šqemu + gdb + aarch64<br>
</p>
</div>
</div>

<div id="outline-container-org19c26b1" class="outline-2">
<h2 id="org19c26b1">åˆå§‹åŒ–ä»£ç ï¼ˆMMUå¼€å¯ä¹‹å‰ï¼‰</h2>
<div class="outline-text-2" id="text-org19c26b1">
<p>
ç”±äºLinuxå†…æ ¸å¯ä»¥è¢«bootloaderåŠ è½½åˆ°ä»»æ„ä½ç½®æ¥æ‰§è¡Œï¼Œåœ¨mmuå¼€å¯ä¹‹å‰ï¼Œå†…æ ¸ä»£ç è¿è¡Œåœ°å€æ˜¯ç”±bootloaderæ¥å†³å®šï¼Œæ­¤æ—¶éœ€è¦åœ¨bootloaderå¤„æ‰“æ–­ç‚¹æ¥è·å–åŠ è½½åœ°å€ï¼Œé€šè¿‡è¿™ä¸ªåœ°å€æ¥è°ƒè¯•ã€‚<br>
</p>
</div>

<div id="outline-container-org6da47cb" class="outline-3">
<h3 id="org6da47cb">è·å–åŠ è½½åœ°å€</h3>
<div class="outline-text-3" id="text-org6da47cb">
<p>
ç”±äºéœ€è¦è·å–bootloaderçš„åŠ è½½åœ°å€ï¼Œå¯ä»¥åœ¨bootloaderè·³è½¬åˆ°å†…æ ¸ä¹‹å‰æ‰“ä¸Šæ–­ç‚¹æ¥è·å–åŠ è½½åœ°å€ï¼Œä¸‹é¢ä»¥ubootä¸ºä¾‹ï¼š<br>
</p>
</div>
<div id="outline-container-orgb9106ea" class="outline-4">
<h4 id="orgb9106ea">æ­£ç¡®åŠ è½½ubootçš„symbolåˆ°è¿è¡Œä½ç½®</h4>
<div class="outline-text-4" id="text-orgb9106ea">
<p>
åœ¨ubootå€’è®¡æ—¶å¼€å§‹æ—¶åœæ­¢ï¼Œä½¿ç”¨è°ƒè¯•å™¨è¿æ¥ä¸Šï¼Œç”±äºubootæœ‰relocaddrçš„è¿‡ç¨‹ï¼Œæ‰€ä»¥è¦å…ˆè·å–ubootå®é™…è¿è¡Œçš„åœ°å€ï¼Œåœ¨aarch64å¹³å°ä¸Šx18å¯„å­˜å™¨ä¿å­˜äº†gdæŒ‡é’ˆçš„åœ°å€ï¼Œé€šè¿‡x18å’Œsymbolæ–‡ä»¶å°±å¯ä»¥è·å–åˆ°relocaddr<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>target remote:1234</code>
<code>add-symbol-file ~/work/uboot/u-boot</code>
<code><span style="color: #c678dd;">set</span> $<span style="color: #dcaeea;">uboot_relocaddr</span> = ((gd_t *)$<span style="color: #dcaeea;">x18</span>)-&gt;relocaddr</code>
<code>add-symbol-file ~/work/uboot/u-boot $<span style="color: #dcaeea;">uboot_relocaddr</span></code>
</pre>
</div>

<p>
åœ¨æ­£ç¡®åŠ è½½å¥½symbolä¹‹åï¼Œé€‚ç”¨btå‘½ä»¤æ¥å¯ä»¥æ­£ç¡®çš„è·å–åˆ°ubootå½“å‰æ‰§è¡Œä½ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œubootæ­£åœ¨ç­‰å¾…ä¸²å£è¾“å…¥å‘½ä»¤<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>(gdb) bt</code>
<code><span style="color: #5B6268;">#</span><span style="color: #5B6268;">0  pl01x_serial_pending (dev=&lt;optimized out&gt;, input=true)</span></code>
<code>    at drivers/serial/serial_pl01x.c:321</code>
<code><span style="color: #5B6268;">#</span><span style="color: #5B6268;">1  0x00000000bff316b8 in console_tstc (file=0) at common/console.c:328</span></code>
<code><span style="color: #5B6268;">#</span><span style="color: #5B6268;">2  fgetc (file=0) at common/console.c:328</span></code>
<code><span style="color: #5B6268;">#</span><span style="color: #5B6268;">3  0x00000000bff2fd9c in cread_line (timeout=0, len=&lt;synthetic pointer&gt;, </span></code>
<code>    <span style="color: #dcaeea;">buf</span>=0xbffd9d50 <span style="color: #98be65;">""</span>, <span style="color: #dcaeea;">prompt</span>=0xbff80a19 <span style="color: #98be65;">"Hobot# "</span>) at common/cli_readline.c:274</code>
<code><span style="color: #5B6268;">#</span><span style="color: #5B6268;">4  cli_readline_into_buffer (prompt=0xbff80a19 "Hobot# ", buffer=0xbffd9d50 "", </span></code>
<code>    <span style="color: #dcaeea;">timeout</span>=0) at common/cli_readline.c:549</code>
<code><span style="color: #5B6268;">#</span><span style="color: #5B6268;">5  0x00000000bff2b130 in uboot_cli_readline (i=0xbbe93e60)</span></code>
<code>    at common/cli_hush.c:1029</code>
<code><span style="color: #5B6268;">#</span><span style="color: #5B6268;">6  get_user_input (i=0xbbe93e60) at common/cli_hush.c:1029</span></code>
<code><span style="color: #5B6268;">#</span><span style="color: #5B6268;">7  file_get (i=0xbbe93e60) at common/cli_hush.c:1108</span></code>
<code></code>
</pre>
</div>
</div>
</div>
<div id="outline-container-org5bf8562" class="outline-4">
<h4 id="org5bf8562">åœ¨è·³å…¥å†…æ ¸ä¹‹å‰æ‰“ä¸Šæ–­ç‚¹ï¼Œè·å–å†…æ ¸è¿è¡Œåœ°å€</h4>
<div class="outline-text-4" id="text-org5bf8562">
<div class="org-src-container">
<pre class="src src-text"><code>(gdb) tb boot_jump_linux</code>
<code>Temporary breakpoint 1 at 0x880024e0: boot_jump_linux. (4 locations)</code>
<code>(gdb) c</code>
<code>Continuing.</code>
<code></code>
<code>Thread 1 hit Temporary breakpoint 1, boot_jump_linux (images=0xbffd9b20, flag=1024)</code>
<code>    at arch/arm/lib/bootm.c:323</code>
<code>323 {</code>
<code>(gdb) p images </code>
<code>$3 = (bootm_headers_t *) 0xbffd9b20</code>
<code>(gdb) set print pretty </code>
<code>(gdb) p /x *images </code>
<code>$6 = {</code>
<code>  legacy_hdr_os = 0x0,</code>
<code>  legacy_hdr_os_copy = {</code>
<code>    ih_magic = 0x0,</code>
<code>    ih_hcrc = 0x0,</code>
<code>    ih_time = 0x0,</code>
<code>    ih_size = 0x0,</code>
<code>    ih_load = 0x0,</code>
<code>    ih_ep = 0x0,</code>
<code>    ih_dcrc = 0x0,</code>
<code>    ih_os = 0x0,</code>
<code>    ih_arch = 0x0,</code>
<code>    ih_type = 0x0,</code>
<code>    ih_comp = 0x0,</code>
<code>    ih_name = {0x0 &lt;repeats 32 times&gt;}</code>
<code>  },</code>
<code>  legacy_hdr_valid = 0x0,</code>
<code>  os = {</code>
<code>    start = 0x83000000,</code>
<code>    end = 0x8390b000,</code>
<code>    image_start = 0x83000800,</code>
<code>    image_len = 0x8e9865,</code>
<code>    load = 0x89080000,</code>
<code>    comp = 0x1,</code>
<code>    type = 0x2,</code>
<code>    os = 0x5,</code>
<code>    arch = 0x0</code>
<code>  },</code>
<code>  ep = 0x89080000,</code>
<code>  rd_start = 0x0,</code>
<code>  rd_end = 0x0,</code>
<code>  ft_addr = 0x82000000,</code>
<code>  ft_len = 0x6ede,</code>
<code>  initrd_start = 0x0,</code>
<code>  initrd_end = 0x0,</code>
<code>  cmdline_start = 0x0,</code>
<code>  cmdline_end = 0x0,</code>
<code>  kbd = 0x0,</code>
<code>  verify = 0xffffffff,</code>
<code>  state = 0x1,</code>
<code>  lmb = {</code>
<code>    memory = {</code>
<code>      cnt = 0x1,</code>
<code>      size = 0x0,</code>
<code>--Type &lt;RET&gt; for more, q to quit, c to continue without paging--</code>
<code>      region = {{</code>
<code>          base = 0x80000000,</code>
<code>          size = 0x40000000</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }}</code>
<code>    },</code>
<code>    reserved = {</code>
<code>      cnt = 0x4,</code>
<code>      size = 0x0,</code>
<code>      region = {{</code>
<code>          base = 0x80000000,</code>
<code>          size = 0x770000</code>
<code>        }, {</code>
<code>          base = 0x82000000,</code>
<code>          size = 0x2000</code>
<code>        }, {</code>
<code>          base = 0x89080000,</code>
<code>          size = 0x100c200</code>
<code>        }, {</code>
<code>          base = 0xbbe922c0,</code>
<code>          size = 0x416dd40</code>
<code>--Type &lt;RET&gt; for more, q to quit, c to continue without paging--</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }, {</code>
<code>          base = 0x0,</code>
<code>          size = 0x0</code>
<code>        }}</code>
<code>    }</code>
<code>  }</code>
<code>}</code>
</pre>
</div>
<p>
hootm_headers_tä¸­æœ‰å‡ ä¸ªå˜é‡éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œä¹‹åè·å–è¿è¡Œåœ°å€æ—¶ä¼šé€‚ç”¨åˆ°<br>
</p>
<dl class="org-dl">
<dt>images-&gt;ep</dt><dd>å†…æ ¸å¯åŠ¨åœ°å€<br></dd>
<dt>images-&gt;os.load</dt><dd>å†…æ ¸å¯åŠ¨åœ°å€<br></dd>
<dt>images-&gt;os.start</dt><dd>å†…æ ¸åŠ è½½åœ°å€<br></dd>
</dl>
</div>
</div>
<div id="outline-container-org0208ded" class="outline-4">
<h4 id="org0208ded">åŠ è½½.head.textæ®µï¼Œåœ¨å†…æ ¸ç¬¬ä¸€æ¡æŒ‡ä»¤å¤„æ‰“æ–­ç‚¹</h4>
<div class="outline-text-4" id="text-org0208ded">
<p>
ç”±äºsymbolåœ¨åŠ è½½æ—¶éœ€è¦åŠ è½½åˆ°ç‰©ç†åœ°å€ä¸Šï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä¸‹é¢çš„pythonè„šæœ¬æ¥è¾…åŠ©åŠ è½½<br>
</p>
<div class="org-src-container">
<pre class="src src-text"><code>source  ~/src/gdb-script/load-linux-init.py</code>
<code>load-linux-init ~/work/kernel/vmlinux images-&gt;ep</code>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-text"><code>(gdb) source  ~/src/gdb-script/load-linux-init.py </code>
<code>(gdb) load-linux-init ~/work/kernel/vmlinux images-&gt;ep </code>
<code>Loading linux init head to 0x0000000083080000</code>
<code>Original linux text address at 0xffffff8008080000</code>
<code>generate command</code>
<code>add-symbol-file ~/work/kernel/vmlinux 0x83081000 -s .head.text 0x83080000 -s .init.text 0x83a00000</code>
<code>load linux image to physical address with command add-symbol-file ~/work/kernel/vmlinux 0x83081000 -s .head.t0</code>
<code>add symbol table from file "/home/schspa/work/kernel/vmlinux" at</code>
<code>    .text_addr = 0x83081000</code>
<code>    .head.text_addr = 0x83080000</code>
<code>    .init.text_addr = 0x83a00000</code>
<code>(gdb) b * 0x83080000</code>
<code>Breakpoint 2 at 0x83080000: file arch/arm64/kernel/head.S, line 82.</code>
<code>(gdb) c</code>
<code>Continuing.</code>
<code></code>
<code>Thread 1 hit Breakpoint 2, _text () at arch/arm64/kernel/head.S:82</code>
<code>82      add x13, x18, #0x16</code>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org14df6dc" class="outline-2">
<h2 id="org14df6dc">åˆå§‹ä»£ç ï¼ˆMMUå¼€å¯ä¹‹å)</h2>
<div class="outline-text-2" id="text-org14df6dc">
<p>
MMUå¼€å¯ä¹‹åå°±ä¸éœ€è¦è®¡ç®—åŠ è½½åœ°å€ï¼Œå¯ä»¥ç›´æ¥æ‰“æ–­ç‚¹æ¥è°ƒè¯•<br>
</p>
<div class="org-src-container">
<pre class="src src-text"><code>add-symbol-file ~/work/kernel/vmlinux</code>
<code>tb start_kernel</code>
<code># do whatever you want</code>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
