<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2021-01-31 æ—¥ 22:54 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Debug linux kernel boot process</title>
<meta name="generator" content="Org mode">
<meta name="author" content="schspa">
<meta name="description" content="how-to-debugging-linux-booting-code"
>
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content">
<h1 class="title">Debug linux kernel boot process</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org255ab8e">ç›®çš„</a></li>
<li><a href="#orge83a08b">åˆå§‹åŒ–ä»£ç ï¼ˆMMUå¼€å¯ä¹‹å‰ï¼‰</a>
<ul>
<li><a href="#orgf906660">è·å–åŠ è½½åœ°å€</a>
<ul>
<li><a href="#org49287c5">æ­£ç¡®åŠ è½½ubootçš„symbolåˆ°è¿è¡Œä½ç½®</a></li>
<li><a href="#orgb8fa0d2">åœ¨è·³å…¥å†…æ ¸ä¹‹å‰æ‰“ä¸Šæ–­ç‚¹ï¼Œè·å–å†…æ ¸è¿è¡Œåœ°å€</a></li>
<li><a href="#orgc9b75d1">åŠ è½½.head.textæ®µï¼Œåœ¨å†…æ ¸ç¬¬ä¸€æ¡æŒ‡ä»¤å¤„æ‰“æ–­ç‚¹</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc55cf67">åˆå§‹ä»£ç ï¼ˆMMUå¼€å¯ä¹‹å)</a></li>
</ul>
</div>
</div>

<div id="outline-container-org255ab8e" class="outline-2">
<h2 id="org255ab8e">ç›®çš„</h2>
<div class="outline-text-2" id="text-org255ab8e">
<p>
å½“linuxå†…æ ¸åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­å‡ºç°bugæ—¶ï¼Œå¯èƒ½éœ€è¦é€‚ç”¨gdb/ulink/ds5 debuggeræ¥è¿›è¡Œdebugï¼Œå¤§å¤šæ•°çš„debugæ–¹æ³•æ—¶åœ¨å¯åŠ¨åï¼Œå†è¿æ¥ä¸Šè°ƒè¯•å™¨ï¼Œæœ€åè¿æ¥ä¸Šè°ƒè¯•å™¨ä¹‹åå†åŠ è½½symbolï¼Œæ‰“æ–­ç‚¹æ¥å®Œæˆdebugã€‚<br>
å¯¹äºå¤§å¤šæ•°çš„æƒ…å†µï¼Œä»¥ä¸Šæ–¹æ³•å°±è¶³ä»¥åº”ä»˜ï¼Œä½†æ˜¯éƒ¨åˆ†æƒ…å†µä¸‹ï¼ˆåœ¨å†…æ ¸åˆå§‹åŒ–æ—©æœŸï¼Œå¯èƒ½è¿˜æ¥ä¸åŠè¿ä¸Šè°ƒè¯•å™¨ï¼Œå†…æ ¸å°±å·²ç»æŒ‚æ‰äº†ï¼‰ï¼Œéœ€è¦æ›´åŠ å¤æ‚çš„æ‰“æ–­ç‚¹æ–¹æ³•ã€‚<br>
è¿™ç¯‡æ–‡ç« å°±é’ˆå¯¹è¿™ç§æƒ…å†µè¿›è¡Œè¯´æ˜ã€‚<br>
å®éªŒç¯å¢ƒï¼šqemu + gdb + aarch64<br>
</p>
</div>
</div>

<div id="outline-container-orge83a08b" class="outline-2">
<h2 id="orge83a08b">åˆå§‹åŒ–ä»£ç ï¼ˆMMUå¼€å¯ä¹‹å‰ï¼‰</h2>
<div class="outline-text-2" id="text-orge83a08b">
<p>
ç”±äºLinuxå†…æ ¸å¯ä»¥è¢«bootloaderåŠ è½½åˆ°ä»»æ„ä½ç½®æ¥æ‰§è¡Œï¼Œåœ¨mmuå¼€å¯ä¹‹å‰ï¼Œå†…æ ¸ä»£ç è¿è¡Œåœ°å€æ˜¯ç”±bootloaderæ¥å†³å®šï¼Œæ­¤æ—¶éœ€è¦åœ¨bootloaderå¤„æ‰“æ–­ç‚¹æ¥è·å–åŠ è½½åœ°å€ï¼Œé€šè¿‡è¿™ä¸ªåœ°å€æ¥è°ƒè¯•ã€‚<br>
</p>
</div>

<div id="outline-container-orgf906660" class="outline-3">
<h3 id="orgf906660">è·å–åŠ è½½åœ°å€</h3>
<div class="outline-text-3" id="text-orgf906660">
<p>
ç”±äºéœ€è¦è·å–bootloaderçš„åŠ è½½åœ°å€ï¼Œå¯ä»¥åœ¨bootloaderè·³è½¬åˆ°å†…æ ¸ä¹‹å‰æ‰“ä¸Šæ–­ç‚¹æ¥è·å–åŠ è½½åœ°å€ï¼Œä¸‹é¢ä»¥ubootä¸ºä¾‹ï¼š<br>
</p>
</div>
<div id="outline-container-org49287c5" class="outline-4">
<h4 id="org49287c5">æ­£ç¡®åŠ è½½ubootçš„symbolåˆ°è¿è¡Œä½ç½®</h4>
<div class="outline-text-4" id="text-org49287c5">
<p>
åœ¨ubootå€’è®¡æ—¶å¼€å§‹æ—¶åœæ­¢ï¼Œä½¿ç”¨è°ƒè¯•å™¨è¿æ¥ä¸Šï¼Œç”±äºubootæœ‰relocaddrçš„è¿‡ç¨‹ï¼Œæ‰€ä»¥è¦å…ˆè·å–ubootå®é™…è¿è¡Œçš„åœ°å€ï¼Œåœ¨aarch64å¹³å°ä¸Šx18å¯„å­˜å™¨ä¿å­˜äº†gdæŒ‡é’ˆçš„åœ°å€ï¼Œé€šè¿‡x18å’Œsymbolæ–‡ä»¶å°±å¯ä»¥è·å–åˆ°relocaddr<br>
</p>
<div class="org-src-container">
<pre class="src src-bash">target remote:1234
add-symbol-file ~/work/uboot/u-boot
<span style="color: #c678dd;">set</span> $<span style="color: #dcaeea;">uboot_relocaddr</span> = ((gd_t *)$<span style="color: #dcaeea;">x18</span>)-&gt;relocaddr
add-symbol-file ~/work/uboot/u-boot $<span style="color: #dcaeea;">uboot_relocaddr</span>
</pre>
</div>

<p>
åœ¨æ­£ç¡®åŠ è½½å¥½symbolä¹‹åï¼Œé€‚ç”¨btå‘½ä»¤æ¥å¯ä»¥æ­£ç¡®çš„è·å–åˆ°ubootå½“å‰æ‰§è¡Œä½ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œubootæ­£åœ¨ç­‰å¾…ä¸²å£è¾“å…¥å‘½ä»¤<br>
</p>
<div class="org-src-container">
<pre class="src src-bash">(gdb) bt
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">0  pl01x_serial_pending (dev=&lt;optimized out&gt;, input=true)</span>
    at drivers/serial/serial_pl01x.c:321
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">1  0x00000000bff316b8 in console_tstc (file=0) at common/console.c:328</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">2  fgetc (file=0) at common/console.c:328</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">3  0x00000000bff2fd9c in cread_line (timeout=0, len=&lt;synthetic pointer&gt;, </span>
    <span style="color: #dcaeea;">buf</span>=0xbffd9d50 <span style="color: #98be65;">""</span>, <span style="color: #dcaeea;">prompt</span>=0xbff80a19 <span style="color: #98be65;">"Hobot# "</span>) at common/cli_readline.c:274
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">4  cli_readline_into_buffer (prompt=0xbff80a19 "Hobot# ", buffer=0xbffd9d50 "", </span>
    <span style="color: #dcaeea;">timeout</span>=0) at common/cli_readline.c:549
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">5  0x00000000bff2b130 in uboot_cli_readline (i=0xbbe93e60)</span>
    at common/cli_hush.c:1029
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">6  get_user_input (i=0xbbe93e60) at common/cli_hush.c:1029</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">7  file_get (i=0xbbe93e60) at common/cli_hush.c:1108</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgb8fa0d2" class="outline-4">
<h4 id="orgb8fa0d2">åœ¨è·³å…¥å†…æ ¸ä¹‹å‰æ‰“ä¸Šæ–­ç‚¹ï¼Œè·å–å†…æ ¸è¿è¡Œåœ°å€</h4>
<div class="outline-text-4" id="text-orgb8fa0d2">
<div class="org-src-container">
<pre class="src src-text">(gdb) tb boot_jump_linux
Temporary breakpoint 1 at 0x880024e0: boot_jump_linux. (4 locations)
(gdb) c
Continuing.

Thread 1 hit Temporary breakpoint 1, boot_jump_linux (images=0xbffd9b20, flag=1024)
    at arch/arm/lib/bootm.c:323
323 {
(gdb) p images 
$3 = (bootm_headers_t *) 0xbffd9b20
(gdb) set print pretty 
(gdb) p /x *images 
$6 = {
  legacy_hdr_os = 0x0,
  legacy_hdr_os_copy = {
    ih_magic = 0x0,
    ih_hcrc = 0x0,
    ih_time = 0x0,
    ih_size = 0x0,
    ih_load = 0x0,
    ih_ep = 0x0,
    ih_dcrc = 0x0,
    ih_os = 0x0,
    ih_arch = 0x0,
    ih_type = 0x0,
    ih_comp = 0x0,
    ih_name = {0x0 &lt;repeats 32 times&gt;}
  },
  legacy_hdr_valid = 0x0,
  os = {
    start = 0x83000000,
    end = 0x8390b000,
    image_start = 0x83000800,
    image_len = 0x8e9865,
    load = 0x89080000,
    comp = 0x1,
    type = 0x2,
    os = 0x5,
    arch = 0x0
  },
  ep = 0x89080000,
  rd_start = 0x0,
  rd_end = 0x0,
  ft_addr = 0x82000000,
  ft_len = 0x6ede,
  initrd_start = 0x0,
  initrd_end = 0x0,
  cmdline_start = 0x0,
  cmdline_end = 0x0,
  kbd = 0x0,
  verify = 0xffffffff,
  state = 0x1,
  lmb = {
    memory = {
      cnt = 0x1,
      size = 0x0,
--Type &lt;RET&gt; for more, q to quit, c to continue without paging--
      region = {{
          base = 0x80000000,
          size = 0x40000000
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }}
    },
    reserved = {
      cnt = 0x4,
      size = 0x0,
      region = {{
          base = 0x80000000,
          size = 0x770000
        }, {
          base = 0x82000000,
          size = 0x2000
        }, {
          base = 0x89080000,
          size = 0x100c200
        }, {
          base = 0xbbe922c0,
          size = 0x416dd40
--Type &lt;RET&gt; for more, q to quit, c to continue without paging--
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }, {
          base = 0x0,
          size = 0x0
        }}
    }
  }
}
</pre>
</div>
<p>
hootm_headers_tä¸­æœ‰å‡ ä¸ªå˜é‡éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œä¹‹åè·å–è¿è¡Œåœ°å€æ—¶ä¼šé€‚ç”¨åˆ°<br>
</p>
<dl class="org-dl">
<dt>images-&gt;ep</dt><dd>å†…æ ¸å¯åŠ¨åœ°å€<br></dd>
<dt>images-&gt;os.load</dt><dd>å†…æ ¸å¯åŠ¨åœ°å€<br></dd>
<dt>images-&gt;os.start</dt><dd>å†…æ ¸åŠ è½½åœ°å€<br></dd>
</dl>
</div>
</div>
<div id="outline-container-orgc9b75d1" class="outline-4">
<h4 id="orgc9b75d1">åŠ è½½.head.textæ®µï¼Œåœ¨å†…æ ¸ç¬¬ä¸€æ¡æŒ‡ä»¤å¤„æ‰“æ–­ç‚¹</h4>
<div class="outline-text-4" id="text-orgc9b75d1">
<p>
ç”±äºsymbolåœ¨åŠ è½½æ—¶éœ€è¦åŠ è½½åˆ°ç‰©ç†åœ°å€ä¸Šï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä¸‹é¢çš„pythonè„šæœ¬æ¥è¾…åŠ©åŠ è½½<br>
</p>
<div class="org-src-container">
<pre class="src src-text">source  ~/src/gdb-script/load-linux-init.py
load-linux-init ~/work/kernel/vmlinux images-&gt;ep
</pre>
</div>
<div class="org-src-container">
<pre class="src src-text">(gdb) source  ~/src/gdb-script/load-linux-init.py 
(gdb) load-linux-init ~/work/kernel/vmlinux images-&gt;ep 
Loading linux init head to 0x0000000083080000
Original linux text address at 0xffffff8008080000
generate command
add-symbol-file ~/work/kernel/vmlinux 0x83081000 -s .head.text 0x83080000 -s .init.text 0x83a00000
load linux image to physical address with command add-symbol-file ~/work/kernel/vmlinux 0x83081000 -s .head.t0
add symbol table from file "/home/schspa/work/kernel/vmlinux" at
    .text_addr = 0x83081000
    .head.text_addr = 0x83080000
    .init.text_addr = 0x83a00000
(gdb) b * 0x83080000
Breakpoint 2 at 0x83080000: file arch/arm64/kernel/head.S, line 82.
(gdb) c
Continuing.

Thread 1 hit Breakpoint 2, _text () at arch/arm64/kernel/head.S:82
82      add x13, x18, #0x16
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc55cf67" class="outline-2">
<h2 id="orgc55cf67">åˆå§‹ä»£ç ï¼ˆMMUå¼€å¯ä¹‹å)</h2>
<div class="outline-text-2" id="text-orgc55cf67">
<p>
MMUå¼€å¯ä¹‹åå°±ä¸éœ€è¦è®¡ç®—åŠ è½½åœ°å€ï¼Œå¯ä»¥ç›´æ¥æ‰“æ–­ç‚¹æ¥è°ƒè¯•<br>
</p>
<div class="org-src-container">
<pre class="src src-text">add-symbol-file ~/work/kernel/vmlinux
tb start_kernel
# do whatever you want
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
