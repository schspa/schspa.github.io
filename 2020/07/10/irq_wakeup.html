<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2023-10-20 Fri 17:00 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>irq wakeup in linux</title>
<meta name="author" content="schspa" />
<meta name="description" content="irq wakeup in linux" />
<meta name="generator" content="Org Mode" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">irq wakeup in linux</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgfc9ffe1">术语</a></li>
<li><a href="#org8cf277b">硬件架构</a>
<ul>
<li><a href="#orgbb8d79a">gic对唤醒功能的支持</a></li>
<li><a href="#org9ec32e8">GIC power down ？</a></li>
<li><a href="#org8924152">CPU Power Down</a></li>
<li><a href="#org2184afe">CPU Power Up</a>
<ul>
<li><a href="#org53db4aa">RESET的执行地址</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orge44092a">Suspend In Linux</a></li>
<li><a href="#org506fd02">Linux irq wakeup</a>
<ul>
<li><a href="#org07b1783">irq flags</a>
<ul>
<li><a href="#org9e87a13">IRQCHIP_MASK_ON_SUSPEND</a></li>
<li><a href="#org4b58d52">IRQCHIP_SKIP_SET_WAKE</a></li>
</ul>
</li>
<li><a href="#orgd330b5c">arm-gic</a></li>
<li><a href="#orgff2825d">linux内核接口</a></li>
<li><a href="#orgbc47817">implement stacked irqchip</a>
<ul>
<li><a href="#org846eb01">used function &amp; macors</a></li>
<li><a href="#orgbe92c01">irq domain</a></li>
<li><a href="#org518deae">irq initialization</a></li>
<li><a href="#org3437768">irq domain ops</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org626112b">ATF软件</a>
<ul>
<li><a href="#org8a2844d">参数：</a></li>
<li><a href="#ATF-PSCI-SCMI-IMPLEMENT">平台相关实现</a></li>
</ul>
</li>
<li><a href="#orge69eed8">refs</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgfc9ffe1" class="outline-2">
<h2 id="orgfc9ffe1">术语</h2>
<div class="outline-text-2" id="text-orgfc9ffe1">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">简写</td>
<td class="org-left">全称</td>
</tr>

<tr>
<td class="org-left">TRM</td>
<td class="org-left">Technical Reference Manual</td>
</tr>

<tr>
<td class="org-left">GIC</td>
<td class="org-left">Generic Interrupt Controller</td>
</tr>

<tr>
<td class="org-left">smccc</td>
<td class="org-left">SMC CALLING CONVENTION</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org8cf277b" class="outline-2">
<h2 id="org8cf277b">硬件架构</h2>
<div class="outline-text-2" id="text-org8cf277b">
<p>
在本篇文章中基于AARCH64平台，GIC作为中断控制器来进行讨论<br>
下面是GIC-600的系统框架图：<br>
</p>
<p>
<img src="assets/2021-03-05_12-47-10_screenshot.png" alt="2021-03-05_12-47-10_screenshot.png"><br>
看图可知，Wake Request模块就是为了唤醒功能提供的信号输出。<br>
</p>
</div>

<div id="outline-container-orgbb8d79a" class="outline-3">
<h3 id="orgbb8d79a">gic对唤醒功能的支持</h3>
<div class="outline-text-3" id="text-orgbb8d79a">
<p>
在<a href="https://developer.arm.com/documentation/101206/0000/signal-descriptions/power-control-signals">gic600的TRM手册</a>中，可以看到gic600有wake_request的输出信号，Power controller可以根据这个信号来将对应的cpu唤醒。<br>
唤醒信号：<br>
</p>

<!-- This HTML table template is generated by emacs 29.0.91 -->
<table border="1">
  <tr>
    <td align="left" valign="top">
      &nbsp;Signal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Type&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Source&nbsp;or&nbsp;destination&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Description&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;wake_request[<num_cpus&nbsp;−&nbsp;1:0>]&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Output&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Power&nbsp;controller&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Wake&nbsp;request&nbsp;signal&nbsp;to&nbsp;power&nbsp;controller&nbsp;indicating&nbsp;that&nbsp;an&nbsp;interrupt&nbsp;is&nbsp;targeting&nbsp;&nbsp;&nbsp;&nbsp;<br />
      this&nbsp;core&nbsp;and&nbsp;it&nbsp;must&nbsp;be&nbsp;woken.&nbsp;When&nbsp;asserted,&nbsp;the&nbsp;wake_request&nbsp;is&nbsp;sticky&nbsp;unless&nbsp;the&nbsp;&nbsp;<br />
      Distributor&nbsp;is&nbsp;put&nbsp;into&nbsp;the&nbsp;gated&nbsp;state.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>
</div>
</div>


<div id="outline-container-org9ec32e8" class="outline-3">
<h3 id="org9ec32e8">GIC power down ？</h3>
<div class="outline-text-3" id="text-org9ec32e8">
<p>
GIC可以被关闭电源，也可以不关闭电源，这个在SOC设计阶段就可以选择。<br>
对于Arm gic来言，一般具有两种情况<br>
</p>
<ol class="org-ol">
<li>GIC处于always on的power domain之中，这样gic在休眠时由于没有断电，仍旧可以正常工作，任何的中断都可以正常唤醒soc <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>, 如图中的Wakeup Request的信号<br></li>
<li>GIC在可以断电的power domain中，这样在休眠时一般都会对gic进行断电，这种状况下，系统需要soc特定的实现来进行唤醒。<br>
具体实现各家SOC都不相同，在此不做讨论，只需要知道这个唤醒功能和GIC没有关系，完全由SOC厂商在设计时实现。<br></li>
</ol>
</div>
</div>

<div id="outline-container-org8924152" class="outline-3">
<h3 id="org8924152">CPU Power Down</h3>
<div class="outline-text-3" id="text-org8924152">
<p>
下面是ARM Crotext A55 CPU的下电流程，CPU有寄存器CPUPWRCTLR来控制电源控制相关功能，当CPUPWRCTLR.CORE_PWRDN_EN置1时，就是代表CPU在下次执行WFI指令时要进入掉电状态。<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup><br>
</p>
<blockquote>
<p>
The Cortex-A55 core uses the following power down sequence.<br>
</p>

<p>
To power down a core, perform the following programming sequence:<br>
</p>

<ol class="org-ol">
<li>Save all architectural state.<br></li>

<li>Configure the GIC distributor to disable or reroute interrupts away from this core.<br></li>

<li>Set the CPUPWRCTLR.CORE_PWRDN_EN bit to 1 to indicate to the power controller that a powerdown is requested.<br></li>

<li>Execute an Instruction Synchronization Barrier (ISB) instruction.<br></li>

<li>Execute a WFI instruction.<br></li>
</ol>

<p>
After executing WFI and then receiving a powerdown request from the power controller, the hardware performs the following:<br>
</p>

<p>
• Disabling and flushing of caches (L1 and L2).<br>
</p>

<p>
• Removal of the core from coherency.<br>
</p>
</blockquote>
<p>
从上面的掉电流程可知，A55在下电时，还需要SOC内部power controller的支持，不同的SOC厂商实现的方式千奇百怪，并且设计泄密在此不做深入。<br>
</p>
</div>
</div>

<div id="outline-container-org2184afe" class="outline-3">
<h3 id="org2184afe">CPU Power Up</h3>
<div class="outline-text-3" id="text-org2184afe">
<p>
从上边Power Down的流程可知，系统在进入Power Down之后需要进行reset才可以将CPU重新启动，具体的过程也是SOC厂商自己定义的行为，没有太大分析的必要。<br>
Reset之后，CPU需要从RVBAR寄存器所显示的地址来重新启动。RVBAR寄存器是通过CPU的外部信号线进行输入的。<br>
</p>
</div>

<div id="outline-container-org53db4aa" class="outline-4">
<h4 id="org53db4aa">RESET的执行地址</h4>
<div class="outline-text-4" id="text-org53db4aa">

<div id="orgfe8a757" class="figure">
<p><img src="assets/2021-03-05_13-40-42_screenshot.png" alt="2021-03-05_13-40-42_screenshot.png"><br>
</p>
</div>

<p>
由于没有在A55的TRM中找到关于此信号的定义，拿A53的来充个数。<br>
</p>


<div id="org3441e2d" class="figure">
<p><img src="assets/2021-03-05_13-43-32_screenshot.png" alt="2021-03-05_13-43-32_screenshot.png"><br>
</p>
</div>

<p>
从手册可知，复位执行地址是可以通过配置来修改的，并且4byte对齐(因为bit0,1不可配置)<br>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orge44092a" class="outline-2">
<h2 id="orge44092a">Suspend In Linux</h2>
<div class="outline-text-2" id="text-orge44092a">
<p>
下图是Linux系统中suspend以及resume的流程图，图中以PSCI为例，描写了系统在休眠时的调用流程。<br>
</p>
<p>
<img src="assets/suspend-to-ram.png" alt="suspend-to-ram.png"><br>
上面的流程着重描写了系统通过PSCI休眠时的调用流程，包括Linux系统从休眠状态唤醒之后的resume流程。<br>
Linux唤醒时，运行的Linux内核的第一段指令是cpu_resume，之后再经过arm64 psci相关的一系列调用返回到psci_system_suspend_enter继续执行。<br>
</p>
</div>
</div>

<div id="outline-container-org506fd02" class="outline-2">
<h2 id="org506fd02">Linux irq wakeup</h2>
<div class="outline-text-2" id="text-org506fd02">
<p>
在Linux系统中，如果想要唤醒已经进入休眠状态中的cpu，就需要通过~enable_irq_wake~来设置开启唤醒功能<sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup>。<br>
实际上，芯片支持的唤醒源个数是有限的，并不是每种中断都可以正常的唤醒系统。<br>
</p>
</div>

<div id="outline-container-org07b1783" class="outline-3">
<h3 id="org07b1783">irq flags</h3>
<div class="outline-text-3" id="text-org07b1783">
</div>
<div id="outline-container-org9e87a13" class="outline-4">
<h4 id="org9e87a13">IRQCHIP_MASK_ON_SUSPEND</h4>
<div class="outline-text-4" id="text-org9e87a13">
<p>
Mask non wake irqs in the suspend path<br>
</p>
</div>
</div>

<div id="outline-container-org4b58d52" class="outline-4">
<h4 id="org4b58d52">IRQCHIP_SKIP_SET_WAKE</h4>
<div class="outline-text-4" id="text-org4b58d52">
<p>
Skip chip.irq_set_wake(), for this irq chip<br>
由以下patch引入，提交说明已经很明确<br>
</p>
<div class="org-src-container">
<pre class="src src-diff"><code><span class="org-diff-context">60f96b41f71d2a13d1c0a457b8b77958f77142d1</span></code>
<code><span class="org-diff-context">Author:</span><span class="org-whitespace-space">     </span><span class="org-diff-context">Santosh</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Shilimkar</span><span class="org-whitespace-space"> </span><span class="org-diff-context"><a href="mailto:santosh.shilimkar%40ti.com">&lt;santosh.shilimkar@ti.com&gt;</a></span></code>
<code><span class="org-diff-context">AuthorDate:</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Fri</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Sep</span><span class="org-whitespace-space"> </span><span class="org-diff-context">9</span><span class="org-whitespace-space"> </span><span class="org-diff-context">13:59:35</span><span class="org-whitespace-space"> </span><span class="org-diff-context">2011</span><span class="org-whitespace-space"> </span><span class="org-diff-context">+0530</span></code>
<code><span class="org-diff-context">Commit:</span><span class="org-whitespace-space">     </span><span class="org-diff-context">Thomas</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Gleixner</span><span class="org-whitespace-space"> </span><span class="org-diff-context"><a href="mailto:tglx%40linutronix.de">&lt;tglx@linutronix.de&gt;</a></span></code>
<code><span class="org-diff-context">CommitDate:</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Mon</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Sep</span><span class="org-whitespace-space"> </span><span class="org-diff-context">12</span><span class="org-whitespace-space"> </span><span class="org-diff-context">09:52:49</span><span class="org-whitespace-space"> </span><span class="org-diff-context">2011</span><span class="org-whitespace-space"> </span><span class="org-diff-context">+0200</span></code>
<code></code>
<code><span class="org-diff-context">Parent:</span><span class="org-whitespace-space">     </span><span class="org-diff-context">ed585a651681e</span><span class="org-whitespace-space"> </span><span class="org-diff-context">genirq:</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Make</span><span class="org-whitespace-space"> </span><span class="org-diff-context">irq_shutdown()</span><span class="org-whitespace-space"> </span><span class="org-diff-context">symmetric</span><span class="org-whitespace-space"> </span><span class="org-diff-context">vs.</span><span class="org-whitespace-space"> </span><span class="org-diff-context">irq_startup</span><span class="org-whitespace-space"> </span><span class="org-diff-context">again</span></code>
<code><span class="org-diff-context">Contained:</span><span class="org-whitespace-space">  </span><span class="org-diff-context">(no</span><span class="org-whitespace-space"> </span><span class="org-diff-context">branch)</span><span class="org-whitespace-space"> </span><span class="org-diff-context">master</span></code>
<code><span class="org-diff-context">Follows:</span><span class="org-whitespace-space">    </span><span class="org-diff-context">v3.1-rc5</span><span class="org-whitespace-space"> </span><span class="org-diff-context">(93)</span></code>
<code><span class="org-diff-context">Precedes:</span><span class="org-whitespace-space">   </span><span class="org-diff-context">v3.2-rc1</span><span class="org-whitespace-space"> </span><span class="org-diff-context">(11433)</span></code>
<code></code>
<code><span class="org-diff-context">genirq:</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Add</span><span class="org-whitespace-space"> </span><span class="org-diff-context">IRQCHIP_SKIP_SET_WAKE</span><span class="org-whitespace-space"> </span><span class="org-diff-context">flag</span></code>
<code></code>
<code><span class="org-diff-context">Some</span><span class="org-whitespace-space"> </span><span class="org-diff-context">irq</span><span class="org-whitespace-space"> </span><span class="org-diff-context">chips</span><span class="org-whitespace-space"> </span><span class="org-diff-context">need</span><span class="org-whitespace-space"> </span><span class="org-diff-context">the</span><span class="org-whitespace-space"> </span><span class="org-diff-context">irq_set_wake()</span><span class="org-whitespace-space"> </span><span class="org-diff-context">functionality,</span><span class="org-whitespace-space"> </span><span class="org-diff-context">but</span><span class="org-whitespace-space"> </span><span class="org-diff-context">do</span><span class="org-whitespace-space"> </span><span class="org-diff-context">not</span></code>
<code><span class="org-diff-context">require</span><span class="org-whitespace-space"> </span><span class="org-diff-context">a</span><span class="org-whitespace-space"> </span><span class="org-diff-context">irq_set_wake()</span><span class="org-whitespace-space"> </span><span class="org-diff-context">callback.</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Instead</span><span class="org-whitespace-space"> </span><span class="org-diff-context">of</span><span class="org-whitespace-space"> </span><span class="org-diff-context">forcing</span><span class="org-whitespace-space"> </span><span class="org-diff-context">an</span><span class="org-whitespace-space"> </span><span class="org-diff-context">empty</span></code>
<code><span class="org-diff-context">callback</span><span class="org-whitespace-space"> </span><span class="org-diff-context">to</span><span class="org-whitespace-space"> </span><span class="org-diff-context">be</span><span class="org-whitespace-space"> </span><span class="org-diff-context">implemented</span><span class="org-whitespace-space"> </span><span class="org-diff-context">add</span><span class="org-whitespace-space"> </span><span class="org-diff-context">a</span><span class="org-whitespace-space"> </span><span class="org-diff-context">flag</span><span class="org-whitespace-space"> </span><span class="org-diff-context">which</span><span class="org-whitespace-space"> </span><span class="org-diff-context">notes</span><span class="org-whitespace-space"> </span><span class="org-diff-context">this</span><span class="org-whitespace-space"> </span><span class="org-diff-context">fact.</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Check</span><span class="org-whitespace-space"> </span><span class="org-diff-context">for</span></code>
<code><span class="org-diff-context">the</span><span class="org-whitespace-space"> </span><span class="org-diff-context">flag</span><span class="org-whitespace-space"> </span><span class="org-diff-context">in</span><span class="org-whitespace-space"> </span><span class="org-diff-context">set_irq_wake_real()</span><span class="org-whitespace-space"> </span><span class="org-diff-context">and</span><span class="org-whitespace-space"> </span><span class="org-diff-context">return</span><span class="org-whitespace-space"> </span><span class="org-diff-context">success</span><span class="org-whitespace-space"> </span><span class="org-diff-context">when</span><span class="org-whitespace-space"> </span><span class="org-diff-context">set.</span></code>
<code></code>
<code><span class="org-diff-context">Signed-off-by:</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Santosh</span><span class="org-whitespace-space"> </span><span class="org-diff-context">Shilimkar</span><span class="org-whitespace-space"> </span><span class="org-diff-context"><a href="mailto:santosh.shilimkar%40ti.com">&lt;santosh.shilimkar@ti.com&gt;</a></span></code>
<code>Cc:<span class="org-whitespace-space"> </span>Thomas<span class="org-whitespace-space"> </span>Gleixner<span class="org-whitespace-space"> </span><a href="mailto:tglx%40linutronix.de">&lt;tglx@linutronix.de&gt;</a></code>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd330b5c" class="outline-3">
<h3 id="orgd330b5c">arm-gic</h3>
<div class="outline-text-3" id="text-orgd330b5c">
<p>
在arm gic的实现中，既没有提供IRQCHIP_SKIP_SET_WAKE的flag，也没有实现set_irq_wake的实现。这是因为Linux内核认为gic不处理休眠唤醒的问题，这些应该由平台来基于stacked irqchip来实现。<sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup><br>
Marc Zyngier在内核的邮件有如下回复<br>
</p>
<blockquote>
<p>
  I don't have any strong feeling against this series (anything that<br>
removes hacks from the GIC code has my full and unconditional support),<br>
but I'd just like to make sure I understand the issue.<br>
</p>

<p>
There is (AFAIU) 3 cases when suspending:<br>
</p>

<ol class="org-ol">
<li>The GIC is in an always-on domain: SKIP_SET_WAKE is set, because<br></li>
</ol>
<p>
there is nothing to do (we can always wake up). Problem solved.<br>
</p>

<ol class="org-ol">
<li>The GIC gets powered off, but we have additional HW that will take<br></li>
</ol>
<p>
care of the wake-up: this is implemented by a stacked irqchip that will<br>
do the right thing: irq_set_wake only looks at the top level irqchip, so<br>
the GIC flag isn't observed, and this should work (maybe by luck&#x2026;).<br>
</p>

<ol class="org-ol">
<li>The GIC gets powered off and nothing will wake us up. I'd say that in<br></li>
</ol>
<p>
this case, having programmed a wake-up interrupt is a bit silly, and<br>
doing S2R is equivalent to committing suicide. Do we have any mechanism<br>
that would avoid getting in that situation?<br>
</p>

<p>
Thanks,<br>
</p>

<p>
M.<br>
</p>
</blockquote>
<p>
在Marc Zyngier的回复中，已经提到3种case<br>
</p>
<ol class="org-ol">
<li>GIC处于always on的电源域，这种情况下，通过设置SKIP_SET_WAKE就可以简单的解决我们的问题，因为不需要做任何事，系统总可以通过gic来唤醒。<br></li>
<li>GIC会被掉电，这种情况下，需要额外的硬件来将系统唤醒（意味着各个SOC厂商都有各不相同的实现），这种情况下，gic的驱动也无法去处理，这就需要通过stacked irqchip来实现，平台的irqchip通过作为下级的irqchip，gic作为顶层irqchip就可以由SOC厂商去具体定制唤醒功能的设置。<br></li>
<li>GIC会掉电，没有任何办法唤醒系统。这种情况完全是错误的，休眠等于自杀，需要避免进入这个状况。<br></li>
</ol>
<p>
所以当soc据有唤醒能力时，需要通过平台的gic驱动来实现，arm gic驱动作为平台gic的父设备。<br>
</p>
</div>
</div>

<div id="outline-container-orgff2825d" class="outline-3">
<h3 id="orgff2825d">linux内核接口</h3>
<div class="outline-text-3" id="text-orgff2825d">
<ul class="org-ul">
<li>/sys/power/pm_wakeup_irq<br>
可以查询到最近一次休眠的唤醒源<br></li>
</ul>
</div>
</div>

<div id="outline-container-orgbc47817" class="outline-3">
<h3 id="orgbc47817">implement stacked irqchip</h3>
<div class="outline-text-3" id="text-orgbc47817">
</div>
<div id="outline-container-org846eb01" class="outline-4">
<h4 id="org846eb01">used function &amp; macors</h4>
<div class="outline-text-4" id="text-org846eb01">
</div>
<ul class="org-ul">
<li><a id="org05b2253"></a>IRQCHIP_DECLARE<br>
<div class="outline-text-5" id="text-org05b2253">
<p>
用来声明一个irqchip驱动，包含compatible属性，irqchip的名称，以及初始化函数<br>
device tree<br>
dts中配置了sysirq，其parent是gic，<br>
</p>
<div class="org-src-container">
<pre class="src src-dts"><code><span class="org-variable-name">gic</span>: <span class="org-type">interrupt-controller</span>@58000000 {</code>
<code>    <span class="org-variable-name">status</span> = <span class="org-string">"okay"</span>;</code>
<code>    <span class="org-variable-name">compatible</span> = <span class="org-string">"arm,gic-v3"</span>;</code>
<code>    #<span class="org-variable-name">interrupt-cells</span> = &lt;3&gt;;</code>
<code>    #<span class="org-variable-name">address-cells</span> = &lt;2&gt;;</code>
<code>    #<span class="org-variable-name">size-cells</span> = &lt;2&gt;;</code>
<code>    <span class="org-variable-name">ranges</span>;</code>
<code>    <span class="org-variable-name">interrupt-controller</span>;</code>
<code>    <span class="org-variable-name">reg</span> =   &lt;0x0 0x58000000 0x0 0x10000&gt;,       <span class="org-comment">// GICD</span></code>
<code>        &lt;0x0 0x58040000 0x0 0x100000&gt;;      <span class="org-comment">// GICR0~7</span></code>
<code>    <span class="org-variable-name">interrupts</span> = &lt;1 9 4&gt;;</code>
<code>};</code>
<code></code>
<code><span class="org-variable-name">sysirq</span>: sysirq@<span class="org-type">system</span> {</code>
<code>    <span class="org-variable-name">compatible</span> = <span class="org-string">"xxx,XX-sysirq"</span>, <span class="org-string">"syscon"</span>;</code>
<code>    #<span class="org-variable-name">interrupt-cells</span> = &lt;3&gt;;</code>
<code>    <span class="org-variable-name">interrupt-parent</span> = &lt;&amp;<span class="org-variable-name">gic</span>&gt;;</code>
<code>    <span class="org-variable-name">interrupt-controller</span>;</code>
<code>    <span class="org-variable-name">ranges</span>;</code>
<code>    <span class="org-variable-name">services</span> = &lt;&amp;<span class="org-variable-name">tee_regmap</span>&gt;;</code>
<code>    <span class="org-variable-name">irq-map</span> = &lt;48 2 0&gt;, <span class="org-comment">// GPIO</span></code>
<code>    &lt;29 4 1&gt;, <span class="org-comment">// AON RTC</span></code>
<code>    &lt;31 6 0&gt;, <span class="org-comment">// aon timer1</span></code>
<code>    &lt;30 8 0&gt;, <span class="org-comment">// aon time0</span></code>
<code>    &lt;9 10 0&gt;, <span class="org-comment">// eth0</span></code>
<code>    &lt;33 18 0&gt;, <span class="org-comment">// canfd0</span></code>
<code>    &lt;36 14 0&gt;; <span class="org-comment">// canfd1</span></code>
<code>    <span class="org-variable-name">reg</span> = &lt;0x0 0x43060000 0x0 0x634&gt;;</code>
<code>};</code>
</pre>
</div>
</div>
</li>

<li><a id="org5e71ca1"></a>get map configuration from device tree node.<br>
<div class="outline-text-5" id="text-org5e71ca1">
<div class="org-src-container">
<pre class="src src-dts"><code><span class="org-variable-name">irq-map</span> = &lt;irq-number enable-bit polar-bit&gt;;</code>
<code>#<span class="org-variable-name">address-cells</span> = &lt;2&gt;;</code>
<code>#<span class="org-variable-name">size-cells</span> = &lt;2&gt;;</code>
<code><span class="org-variable-name">reg</span> = &lt;0x0 0x43840000 0x0 0x634&gt;;</code>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgbe92c01" class="outline-4">
<h4 id="orgbe92c01">irq domain</h4>
<div class="outline-text-4" id="text-orgbe92c01">
<p>
关于irq domain可以参考以下文档<br>
<a href="https://lwn.net/Articles/487684/">https://lwn.net/Articles/487684/</a><br>
</p>
</div>
</div>

<div id="outline-container-org518deae" class="outline-4">
<h4 id="org518deae">irq initialization</h4>
<div class="outline-text-4" id="text-org518deae">
<div class="org-src-container">
<pre class="src src-C"><code>(<span class="org-type">gdb</span>) bt</code>
<code><span class="org-preprocessor">#0</span>  XX_irq_of_init (node=0xffffffc03efed568, parent=0x0 &lt;bl1_entrypoint&gt;) at ./include/linux/irqdomain.h:298</code>
<code><span class="org-preprocessor">#1</span>  0xffffff8008856224 in of_irq_init (matches=&lt;optimized out&gt;) at drivers/of/irq.c:546</code>
<code><span class="org-preprocessor">#2</span>  0xffffff8008849240 in irqchip_init () at drivers/irqchip/irqchip.c:29</code>
<code><span class="org-preprocessor">#3</span>  0xffffff800883241c in init_IRQ () at arch/arm64/kernel/irq.c:91</code>
<code><span class="org-preprocessor">#4</span>  0xffffff80088309f8 in start_kernel () at init/main.c:611</code>
<code><span class="org-preprocessor">#5</span>  0x0000000000000000 in ?? ()</code>
<code>Backtrace <span class="org-type">stopped</span>: previous frame identical to this frame (corrupt stack?)</code>
</pre>
</div>
<p>
查找partent的irq, 并添加新的irq_domain<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code>domain_parent = irq_find_host(parent);</code>
<code><span class="org-keyword">if</span> (<span class="org-negation-char">!</span>domain_parent) {</code>
<code>    pr_err(<span class="org-string">"XX_irq: interrupt-parent not found\n"</span>);</code>
<code>    <span class="org-keyword">return</span> -EINVAL;</code>
<code>}</code>
<code></code>
<code>domain = irq_domain_add_hierarchy(domain_parent, 0, intpol_num, node,</code>
<code>                  &amp;sysirq_domain_ops, chip_data);</code>
<code><span class="org-keyword">if</span> (<span class="org-negation-char">!</span>domain) {</code>
<code>    ret = -ENOMEM;</code>
<code>    <span class="org-keyword">goto</span> <span class="org-constant">out_unmap</span>;</code>
<code>}</code>
</pre>
</div>
<p>
上面是主要内容，分为两步<br>
</p>
<ol class="org-ol">
<li>获取parent的irq domain<br></li>
<li>添加新的irq_domain来实现需要的操作<br></li>
</ol>
</div>
</div>
<div id="outline-container-org3437768" class="outline-4">
<h4 id="org3437768">irq domain ops</h4>
<div class="outline-text-4" id="text-org3437768">
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">XX_irq_domain_translate</span>(<span class="org-keyword">struct</span> <span class="org-type">irq_domain</span> *<span class="org-variable-name">d</span>,</code>
<code>                                <span class="org-keyword">struct</span> <span class="org-type">irq_fwspec</span> *<span class="org-variable-name">fwspec</span>,</code>
<code>                                <span class="org-type">unsigned</span> <span class="org-type">long</span> *<span class="org-variable-name">hwirq</span>,</code>
<code>                                <span class="org-type">unsigned</span> <span class="org-type">int</span> *<span class="org-variable-name">type</span>)</code>
<code>{</code>
<code>    <span class="org-keyword">if</span> (is_of_node(fwspec-&gt;fwnode)) {</code>
<code>        <span class="org-keyword">if</span> (fwspec-&gt;param_count != 3)</code>
<code>            <span class="org-keyword">return</span> -EINVAL;</code>
<code></code>
<code>        <span class="org-comment-delimiter">/* </span><span class="org-comment">No PPI should point to this domain</span><span class="org-comment-delimiter"> */</span></code>
<code>        <span class="org-keyword">if</span> (fwspec-&gt;param[0] != GIC_SPI)</code>
<code>            <span class="org-keyword">return</span> -EINVAL;</code>
<code></code>
<code>        *hwirq = fwspec-&gt;param[1];</code>
<code>        *type = fwspec-&gt;param[2] &amp; IRQ_TYPE_SENSE_MASK;</code>
<code>        <span class="org-keyword">return</span> 0;</code>
<code>    }</code>
<code></code>
<code>    <span class="org-keyword">return</span> -EINVAL;</code>
<code>}</code>
<code></code>
<code><span class="org-keyword">static</span> <span class="org-keyword">const</span> <span class="org-keyword">struct</span> <span class="org-type">irq_domain_ops</span> <span class="org-variable-name">sysirq_domain_ops</span> = {</code>
<code>    .translate  = XX_irq_domain_translate,</code>
<code>    .alloc              = XX_irq_domain_alloc,</code>
<code>    .free               = irq_domain_free_irqs_common,</code>
<code>};</code>
</pre>
</div>
<p>
其中最重要的就是 translate 接口，这个接口实现了irq号的转换功能。<br>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org626112b" class="outline-2">
<h2 id="org626112b">ATF软件</h2>
<div class="outline-text-2" id="text-org626112b">
<p>
arm atf中实现了psci协议，当系统休眠时，可以通过psci来进入休眠。psci方法：PSCI_CPU_SUSPEND_AARCH64，PSCI_CPU_SUSPEND_AARCH32<br>
suspend的方法原型为：<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-type">int</span> <span class="org-function-name">psci_cpu_suspend</span>(<span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">power_state</span>,</code>
<code>        <span class="org-type">uintptr_t</span> <span class="org-variable-name">entrypoint</span>,</code>
<code>        <span class="org-type">u_register_t</span> <span class="org-variable-name">context_id</span>);</code>
</pre>
</div>
</div>
<div id="outline-container-org8a2844d" class="outline-3">
<h3 id="org8a2844d">参数：</h3>
<div class="outline-text-3" id="text-org8a2844d">
<dl class="org-dl">
<dt>power_state</dt><dd>power_state参数比较复杂，power_state定义了系统要处于的低功耗模式，根据系统的实现，有两种格式可供选择。<br></dd>
<dt>entrypoint</dt><dd><p>
resume之后的入口地址，需要提供PA，或者IPA<br>
</p>
<blockquote>
<p>
The entry_point_address parameter is used by the caller to specify where code execution needs to resume at wakeup time. The parameter must be a Physical Address (PA), or, for a guest OS in a virtualized platform, an Intermediate Physical Address (IPA). In this case, the hypervisor must trap the call. Further details can be found in section<br>
</p>
</blockquote></dd>
<dt>context_id</dt><dd>回传参数，当系统resume之后，psci将这个值放入X0/W0/R0，作为第一个参数传递过去。<br></dd>
</dl>
</div>
</div>

<div id="outline-container-ATF-PSCI-SCMI-IMPLEMENT" class="outline-3">
<h3 id="ATF-PSCI-SCMI-IMPLEMENT">平台相关实现</h3>
<div class="outline-text-3" id="text-ATF-PSCI-SCMI-IMPLEMENT">
<p>
在平台的实现中，ATF有几个函数是需要SOC平台进行实现的。<br>
</p>

<p>
在ATF中，psci lib已经实现了平台无关部份的代码，部份代码需要soc平台来根据自己<br>
的需要来实现。psci lib中与休眠唤醒关系不大，上述参数中entrypoint以及<br>
context_id都时psci代码来处理，SOC平台无需关心此部份代码。为了有一个对atf中的<br>
休眠唤醒流程有一个直观的影响，使用下面的代码调用时序图来说明<br>
</p>


<div id="org2621fc3" class="figure">
<p><img src="assets/.atf-suspend-resume.png" alt=".atf-suspend-resume.png"><br>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orge69eed8" class="outline-2">
<h2 id="orge69eed8">refs</h2>
<div class="outline-text-2" id="text-orge69eed8">
<p>
<a href="https://patchwork.kernel.org/patch/9343061/">https://patchwork.kernel.org/patch/9343061/</a><br>
<a href="https://patchwork.kernel.org/patch/6799191/">https://patchwork.kernel.org/patch/6799191/</a><br>
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
虽然gic可以工作来输出唤醒信号，但是输出的唤醒信号仍需gic之外的控制器来处理<br>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
CPU power down还需要SOC内部power controller的支持，具体SOC也有较大区别，在此不做关系<br>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
视SOC的实现不同，enable_irq_wake也不是必须调用。<br>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1598347.html">https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1598347.html</a><br>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="✨💬✨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">虚怀乃若谷，水深则流缓。</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>