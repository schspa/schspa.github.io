<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-03-03 Thu 11:48 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>irq wakeup in linux</title>
<meta name="author" content="schspa" />
<meta name="description" content="irq wakeup in linux" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">irq wakeup in linux</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org25d0ce2">æœ¯è¯­</a></li>
<li><a href="#org96885f3">ç¡¬ä»¶æ¶æ„</a>
<ul>
<li><a href="#org6f51070">gicå¯¹å”¤é†’åŠŸèƒ½çš„æ”¯æŒ</a></li>
<li><a href="#org4d9533d">GIC power down ï¼Ÿ</a></li>
<li><a href="#org04506eb">CPU Power Down</a></li>
<li><a href="#orgf776201">CPU Power Up</a>
<ul>
<li><a href="#orgfd6ef2f">RESETçš„æ‰§è¡Œåœ°å€</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga61bab5">Suspend In Linux</a></li>
<li><a href="#org0e34c76">Linux irq wakeup</a>
<ul>
<li><a href="#org88b2b75">irq flags</a>
<ul>
<li><a href="#org5eb80d8">IRQCHIP_MASK_ON_SUSPEND</a></li>
<li><a href="#org3c38727">IRQCHIP_SKIP_SET_WAKE</a></li>
</ul>
</li>
<li><a href="#org7a22b59">arm-gic</a></li>
<li><a href="#orgabec106">linuxå†…æ ¸æ¥å£</a></li>
<li><a href="#orgf083711">implement stacked irqchip</a>
<ul>
<li><a href="#orgb890355">used function &amp; macors</a></li>
<li><a href="#orgdbcf161">irq domain</a></li>
<li><a href="#org6211cda">irq initialization</a></li>
<li><a href="#org39be6d7">irq domain ops</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orga0a8f6f">ATFè½¯ä»¶</a>
<ul>
<li><a href="#org570b3cf">å‚æ•°ï¼š</a></li>
<li><a href="#org4909732">å¹³å°ç›¸å…³å®ç°</a></li>
</ul>
</li>
<li><a href="#orgb0a401b">refs</a></li>
</ul>
</div>
</div>

<div id="outline-container-org25d0ce2" class="outline-2">
<h2 id="org25d0ce2">æœ¯è¯­</h2>
<div class="outline-text-2" id="text-org25d0ce2">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">ç®€å†™</td>
<td class="org-left">å…¨ç§°</td>
</tr>

<tr>
<td class="org-left">TRM</td>
<td class="org-left">Technical Reference Manual</td>
</tr>

<tr>
<td class="org-left">GIC</td>
<td class="org-left">Generic Interrupt Controller</td>
</tr>

<tr>
<td class="org-left">smccc</td>
<td class="org-left">SMC CALLING CONVENTION</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org96885f3" class="outline-2">
<h2 id="org96885f3">ç¡¬ä»¶æ¶æ„</h2>
<div class="outline-text-2" id="text-org96885f3">
<p>
åœ¨æœ¬ç¯‡æ–‡ç« ä¸­åŸºäºAARCH64å¹³å°ï¼ŒGICä½œä¸ºä¸­æ–­æ§åˆ¶å™¨æ¥è¿›è¡Œè®¨è®º<br>
ä¸‹é¢æ˜¯GIC-600çš„ç³»ç»Ÿæ¡†æ¶å›¾ï¼š<br>
</p>
<p>
<img src="assets/2021-03-05_12-47-10_screenshot.png" alt="2021-03-05_12-47-10_screenshot.png"><br>
çœ‹å›¾å¯çŸ¥ï¼ŒWake Requestæ¨¡å—å°±æ˜¯ä¸ºäº†å”¤é†’åŠŸèƒ½æä¾›çš„ä¿¡å·è¾“å‡ºã€‚<br>
</p>
</div>

<div id="outline-container-org6f51070" class="outline-3">
<h3 id="org6f51070">gicå¯¹å”¤é†’åŠŸèƒ½çš„æ”¯æŒ</h3>
<div class="outline-text-3" id="text-org6f51070">
<p>
åœ¨<a href="https://developer.arm.com/documentation/101206/0000/signal-descriptions/power-control-signals">gic600çš„TRMæ‰‹å†Œ</a>ä¸­ï¼Œå¯ä»¥çœ‹åˆ°gic600æœ‰wake_requestçš„è¾“å‡ºä¿¡å·ï¼ŒPower controllerå¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡å·æ¥å°†å¯¹åº”çš„cpuå”¤é†’ã€‚<br>
å”¤é†’ä¿¡å·ï¼š<br>
</p>

<!-- This HTML table template is generated by emacs 27.2 -->
<table border="1">
  <tr>
    <td align="left" valign="top">
      &nbsp;Signal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Type&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Source&nbsp;or&nbsp;destination&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Description&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;wake_request[<num_cpus&nbsp;âˆ’&nbsp;1:0>]&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Output&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Power&nbsp;controller&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;Wake&nbsp;request&nbsp;signal&nbsp;to&nbsp;power&nbsp;controller&nbsp;indicating&nbsp;that&nbsp;an&nbsp;interrupt&nbsp;is&nbsp;targeting&nbsp;&nbsp;&nbsp;&nbsp;<br />
      this&nbsp;core&nbsp;and&nbsp;it&nbsp;must&nbsp;be&nbsp;woken.&nbsp;When&nbsp;asserted,&nbsp;the&nbsp;wake_request&nbsp;is&nbsp;sticky&nbsp;unless&nbsp;the&nbsp;&nbsp;<br />
      Distributor&nbsp;is&nbsp;put&nbsp;into&nbsp;the&nbsp;gated&nbsp;state.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>
</div>
</div>


<div id="outline-container-org4d9533d" class="outline-3">
<h3 id="org4d9533d">GIC power down ï¼Ÿ</h3>
<div class="outline-text-3" id="text-org4d9533d">
<p>
GICå¯ä»¥è¢«å…³é—­ç”µæºï¼Œä¹Ÿå¯ä»¥ä¸å…³é—­ç”µæºï¼Œè¿™ä¸ªåœ¨SOCè®¾è®¡é˜¶æ®µå°±å¯ä»¥é€‰æ‹©ã€‚<br>
å¯¹äºArm gicæ¥è¨€ï¼Œä¸€èˆ¬å…·æœ‰ä¸¤ç§æƒ…å†µ<br>
</p>
<ol class="org-ol">
<li>GICå¤„äºalways onçš„power domainä¹‹ä¸­ï¼Œè¿™æ ·gicåœ¨ä¼‘çœ æ—¶ç”±äºæ²¡æœ‰æ–­ç”µï¼Œä»æ—§å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä»»ä½•çš„ä¸­æ–­éƒ½å¯ä»¥æ­£å¸¸å”¤é†’soc <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>, å¦‚å›¾ä¸­çš„Wakeup Requestçš„ä¿¡å·<br></li>
<li>GICåœ¨å¯ä»¥æ–­ç”µçš„power domainä¸­ï¼Œè¿™æ ·åœ¨ä¼‘çœ æ—¶ä¸€èˆ¬éƒ½ä¼šå¯¹gicè¿›è¡Œæ–­ç”µï¼Œè¿™ç§çŠ¶å†µä¸‹ï¼Œç³»ç»Ÿéœ€è¦socç‰¹å®šçš„å®ç°æ¥è¿›è¡Œå”¤é†’ã€‚<br>
å…·ä½“å®ç°å„å®¶SOCéƒ½ä¸ç›¸åŒï¼Œåœ¨æ­¤ä¸åšè®¨è®ºï¼Œåªéœ€è¦çŸ¥é“è¿™ä¸ªå”¤é†’åŠŸèƒ½å’ŒGICæ²¡æœ‰å…³ç³»ï¼Œå®Œå…¨ç”±SOCå‚å•†åœ¨è®¾è®¡æ—¶å®ç°ã€‚<br></li>
</ol>
</div>
</div>

<div id="outline-container-org04506eb" class="outline-3">
<h3 id="org04506eb">CPU Power Down</h3>
<div class="outline-text-3" id="text-org04506eb">
<p>
ä¸‹é¢æ˜¯ARM Crotext A55 CPUçš„ä¸‹ç”µæµç¨‹ï¼ŒCPUæœ‰å¯„å­˜å™¨CPUPWRCTLRæ¥æ§åˆ¶ç”µæºæ§åˆ¶ç›¸å…³åŠŸèƒ½ï¼Œå½“CPUPWRCTLR.CORE_PWRDN_ENç½®1æ—¶ï¼Œå°±æ˜¯ä»£è¡¨CPUåœ¨ä¸‹æ¬¡æ‰§è¡ŒWFIæŒ‡ä»¤æ—¶è¦è¿›å…¥æ‰ç”µçŠ¶æ€ã€‚<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup><br>
</p>
<blockquote>
<p>
The Cortex-A55 core uses the following power down sequence.<br>
</p>

<p>
To power down a core, perform the following programming sequence:<br>
</p>

<ol class="org-ol">
<li>Save all architectural state.<br></li>

<li>Configure the GIC distributor to disable or reroute interrupts away from this core.<br></li>

<li>Set the CPUPWRCTLR.CORE_PWRDN_EN bit to 1 to indicate to the power controller that a powerdown is requested.<br></li>

<li>Execute an Instruction Synchronization Barrier (ISB) instruction.<br></li>

<li>Execute a WFI instruction.<br></li>
</ol>

<p>
After executing WFI and then receiving a powerdown request from the power controller, the hardware performs the following:<br>
</p>

<p>
â€¢ Disabling and flushing of caches (L1 and L2).<br>
</p>

<p>
â€¢ Removal of the core from coherency.<br>
</p>
</blockquote>
<p>
ä»ä¸Šé¢çš„æ‰ç”µæµç¨‹å¯çŸ¥ï¼ŒA55åœ¨ä¸‹ç”µæ—¶ï¼Œè¿˜éœ€è¦SOCå†…éƒ¨power controllerçš„æ”¯æŒï¼Œä¸åŒçš„SOCå‚å•†å®ç°çš„æ–¹å¼åƒå¥‡ç™¾æ€ªï¼Œå¹¶ä¸”è®¾è®¡æ³„å¯†åœ¨æ­¤ä¸åšæ·±å…¥ã€‚<br>
</p>
</div>
</div>

<div id="outline-container-orgf776201" class="outline-3">
<h3 id="orgf776201">CPU Power Up</h3>
<div class="outline-text-3" id="text-orgf776201">
<p>
ä»ä¸Šè¾¹Power Downçš„æµç¨‹å¯çŸ¥ï¼Œç³»ç»Ÿåœ¨è¿›å…¥Power Downä¹‹åéœ€è¦è¿›è¡Œresetæ‰å¯ä»¥å°†CPUé‡æ–°å¯åŠ¨ï¼Œå…·ä½“çš„è¿‡ç¨‹ä¹Ÿæ˜¯SOCå‚å•†è‡ªå·±å®šä¹‰çš„è¡Œä¸ºï¼Œæ²¡æœ‰å¤ªå¤§åˆ†æçš„å¿…è¦ã€‚<br>
Resetä¹‹åï¼ŒCPUéœ€è¦ä»RVBARå¯„å­˜å™¨æ‰€æ˜¾ç¤ºçš„åœ°å€æ¥é‡æ–°å¯åŠ¨ã€‚RVBARå¯„å­˜å™¨æ˜¯é€šè¿‡CPUçš„å¤–éƒ¨ä¿¡å·çº¿è¿›è¡Œè¾“å…¥çš„ã€‚<br>
</p>
</div>

<div id="outline-container-orgfd6ef2f" class="outline-4">
<h4 id="orgfd6ef2f">RESETçš„æ‰§è¡Œåœ°å€</h4>
<div class="outline-text-4" id="text-orgfd6ef2f">

<div id="orgd1740ab" class="figure">
<p><img src="assets/2021-03-05_13-40-42_screenshot.png" alt="2021-03-05_13-40-42_screenshot.png"><br>
</p>
</div>

<p>
ç”±äºæ²¡æœ‰åœ¨A55çš„TRMä¸­æ‰¾åˆ°å…³äºæ­¤ä¿¡å·çš„å®šä¹‰ï¼Œæ‹¿A53çš„æ¥å……ä¸ªæ•°ã€‚<br>
</p>


<div id="orgaa72966" class="figure">
<p><img src="assets/2021-03-05_13-43-32_screenshot.png" alt="2021-03-05_13-43-32_screenshot.png"><br>
</p>
</div>

<p>
ä»æ‰‹å†Œå¯çŸ¥ï¼Œå¤ä½æ‰§è¡Œåœ°å€æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ¥ä¿®æ”¹çš„ï¼Œå¹¶ä¸”4byteå¯¹é½(å› ä¸ºbit0,1ä¸å¯é…ç½®)<br>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orga61bab5" class="outline-2">
<h2 id="orga61bab5">Suspend In Linux</h2>
<div class="outline-text-2" id="text-orga61bab5">
<p>
ä¸‹å›¾æ˜¯Linuxç³»ç»Ÿä¸­suspendä»¥åŠresumeçš„æµç¨‹å›¾ï¼Œå›¾ä¸­ä»¥PSCIä¸ºä¾‹ï¼Œæå†™äº†ç³»ç»Ÿåœ¨ä¼‘çœ æ—¶çš„è°ƒç”¨æµç¨‹ã€‚<br>
</p>
<p>
<img src="assets/suspend-to-ram.png" alt="suspend-to-ram.png"><br>
ä¸Šé¢çš„æµç¨‹ç€é‡æå†™äº†ç³»ç»Ÿé€šè¿‡PSCIä¼‘çœ æ—¶çš„è°ƒç”¨æµç¨‹ï¼ŒåŒ…æ‹¬Linuxç³»ç»Ÿä»ä¼‘çœ çŠ¶æ€å”¤é†’ä¹‹åçš„resumeæµç¨‹ã€‚<br>
Linuxå”¤é†’æ—¶ï¼Œè¿è¡Œçš„Linuxå†…æ ¸çš„ç¬¬ä¸€æ®µæŒ‡ä»¤æ˜¯cpu_resumeï¼Œä¹‹åå†ç»è¿‡arm64 psciç›¸å…³çš„ä¸€ç³»åˆ—è°ƒç”¨è¿”å›åˆ°psci_system_suspend_enterç»§ç»­æ‰§è¡Œã€‚<br>
</p>
</div>
</div>

<div id="outline-container-org0e34c76" class="outline-2">
<h2 id="org0e34c76">Linux irq wakeup</h2>
<div class="outline-text-2" id="text-org0e34c76">
<p>
åœ¨Linuxç³»ç»Ÿä¸­ï¼Œå¦‚æœæƒ³è¦å”¤é†’å·²ç»è¿›å…¥ä¼‘çœ çŠ¶æ€ä¸­çš„cpuï¼Œå°±éœ€è¦é€šè¿‡~enable_irq_wake~æ¥è®¾ç½®å¼€å¯å”¤é†’åŠŸèƒ½<sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup>ã€‚<br>
å®é™…ä¸Šï¼ŒèŠ¯ç‰‡æ”¯æŒçš„å”¤é†’æºä¸ªæ•°æ˜¯æœ‰é™çš„ï¼Œå¹¶ä¸æ˜¯æ¯ç§ä¸­æ–­éƒ½å¯ä»¥æ­£å¸¸çš„å”¤é†’ç³»ç»Ÿã€‚<br>
</p>
</div>

<div id="outline-container-org88b2b75" class="outline-3">
<h3 id="org88b2b75">irq flags</h3>
<div class="outline-text-3" id="text-org88b2b75">
</div>
<div id="outline-container-org5eb80d8" class="outline-4">
<h4 id="org5eb80d8">IRQCHIP_MASK_ON_SUSPEND</h4>
<div class="outline-text-4" id="text-org5eb80d8">
<p>
Mask non wake irqs in the suspend path<br>
</p>
</div>
</div>

<div id="outline-container-org3c38727" class="outline-4">
<h4 id="org3c38727">IRQCHIP_SKIP_SET_WAKE</h4>
<div class="outline-text-4" id="text-org3c38727">
<p>
Skip chip.irq_set_wake(), for this irq chip<br>
ç”±ä»¥ä¸‹patchå¼•å…¥ï¼Œæäº¤è¯´æ˜å·²ç»å¾ˆæ˜ç¡®<br>
</p>
<div class="org-src-container">
<pre class="src src-diff"><code><span style="color: #a4aab6;">60f96b41f71d2a13d1c0a457b8b77958f77142d1</span></code>
<code><span style="color: #a4aab6;">Author:</span><span style="color: #3f444a;">     </span><span style="color: #a4aab6;">Santosh</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Shilimkar</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;"><a href="mailto:santosh.shilimkar%40ti.com">&lt;santosh.shilimkar@ti.com&gt;</a></span></code>
<code><span style="color: #a4aab6;">AuthorDate:</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Fri</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Sep</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">9</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">13:59:35</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">2011</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">+0530</span></code>
<code><span style="color: #a4aab6;">Commit:</span><span style="color: #3f444a;">     </span><span style="color: #a4aab6;">Thomas</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Gleixner</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;"><a href="mailto:tglx%40linutronix.de">&lt;tglx@linutronix.de&gt;</a></span></code>
<code><span style="color: #a4aab6;">CommitDate:</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Mon</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Sep</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">12</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">09:52:49</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">2011</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">+0200</span></code>
<code></code>
<code><span style="color: #a4aab6;">Parent:</span><span style="color: #3f444a;">     </span><span style="color: #a4aab6;">ed585a651681e</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">genirq:</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Make</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">irq_shutdown()</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">symmetric</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">vs.</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">irq_startup</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">again</span></code>
<code><span style="color: #a4aab6;">Contained:</span><span style="color: #3f444a;">  </span><span style="color: #a4aab6;">(no</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">branch)</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">master</span></code>
<code><span style="color: #a4aab6;">Follows:</span><span style="color: #3f444a;">    </span><span style="color: #a4aab6;">v3.1-rc5</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">(93)</span></code>
<code><span style="color: #a4aab6;">Precedes:</span><span style="color: #3f444a;">   </span><span style="color: #a4aab6;">v3.2-rc1</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">(11433)</span></code>
<code></code>
<code><span style="color: #a4aab6;">genirq:</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Add</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">IRQCHIP_SKIP_SET_WAKE</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">flag</span></code>
<code></code>
<code><span style="color: #a4aab6;">Some</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">irq</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">chips</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">need</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">the</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">irq_set_wake()</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">functionality,</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">but</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">do</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">not</span></code>
<code><span style="color: #a4aab6;">require</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">a</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">irq_set_wake()</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">callback.</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Instead</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">of</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">forcing</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">an</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">empty</span></code>
<code><span style="color: #a4aab6;">callback</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">to</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">be</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">implemented</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">add</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">a</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">flag</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">which</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">notes</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">this</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">fact.</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Check</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">for</span></code>
<code><span style="color: #a4aab6;">the</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">flag</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">in</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">set_irq_wake_real()</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">and</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">return</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">success</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">when</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">set.</span></code>
<code></code>
<code><span style="color: #a4aab6;">Signed-off-by:</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Santosh</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;">Shilimkar</span><span style="color: #3f444a;"> </span><span style="color: #a4aab6;"><a href="mailto:santosh.shilimkar%40ti.com">&lt;santosh.shilimkar@ti.com&gt;</a></span></code>
<code>Cc:<span style="color: #3f444a;"> </span>Thomas<span style="color: #3f444a;"> </span>Gleixner<span style="color: #3f444a;"> </span><a href="mailto:tglx%40linutronix.de">&lt;tglx@linutronix.de&gt;</a></code>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7a22b59" class="outline-3">
<h3 id="org7a22b59">arm-gic</h3>
<div class="outline-text-3" id="text-org7a22b59">
<p>
åœ¨arm gicçš„å®ç°ä¸­ï¼Œæ—¢æ²¡æœ‰æä¾›IRQCHIP_SKIP_SET_WAKEçš„flagï¼Œä¹Ÿæ²¡æœ‰å®ç°set_irq_wakeçš„å®ç°ã€‚è¿™æ˜¯å› ä¸ºLinuxå†…æ ¸è®¤ä¸ºgicä¸å¤„ç†ä¼‘çœ å”¤é†’çš„é—®é¢˜ï¼Œè¿™äº›åº”è¯¥ç”±å¹³å°æ¥åŸºäºstacked irqchipæ¥å®ç°ã€‚<sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup><br>
Marc Zyngieråœ¨å†…æ ¸çš„é‚®ä»¶æœ‰å¦‚ä¸‹å›å¤<br>
</p>
<blockquote>
<p>
  I don't have any strong feeling against this series (anything that<br>
removes hacks from the GIC code has my full and unconditional support),<br>
but I'd just like to make sure I understand the issue.<br>
</p>

<p>
There is (AFAIU) 3 cases when suspending:<br>
</p>

<ol class="org-ol">
<li>The GIC is in an always-on domain: SKIP_SET_WAKE is set, because<br></li>
</ol>
<p>
there is nothing to do (we can always wake up). Problem solved.<br>
</p>

<ol class="org-ol">
<li>The GIC gets powered off, but we have additional HW that will take<br></li>
</ol>
<p>
care of the wake-up: this is implemented by a stacked irqchip that will<br>
do the right thing: irq_set_wake only looks at the top level irqchip, so<br>
the GIC flag isn't observed, and this should work (maybe by luck&#x2026;).<br>
</p>

<ol class="org-ol">
<li>The GIC gets powered off and nothing will wake us up. I'd say that in<br></li>
</ol>
<p>
this case, having programmed a wake-up interrupt is a bit silly, and<br>
doing S2R is equivalent to committing suicide. Do we have any mechanism<br>
that would avoid getting in that situation?<br>
</p>

<p>
Thanks,<br>
</p>

<p>
M.<br>
</p>
</blockquote>
<p>
åœ¨Marc Zyngierçš„å›å¤ä¸­ï¼Œå·²ç»æåˆ°3ç§case<br>
</p>
<ol class="org-ol">
<li>GICå¤„äºalways onçš„ç”µæºåŸŸï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡è®¾ç½®SKIP_SET_WAKEå°±å¯ä»¥ç®€å•çš„è§£å†³æˆ‘ä»¬çš„é—®é¢˜ï¼Œå› ä¸ºä¸éœ€è¦åšä»»ä½•äº‹ï¼Œç³»ç»Ÿæ€»å¯ä»¥é€šè¿‡gicæ¥å”¤é†’ã€‚<br></li>
<li>GICä¼šè¢«æ‰ç”µï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦é¢å¤–çš„ç¡¬ä»¶æ¥å°†ç³»ç»Ÿå”¤é†’ï¼ˆæ„å‘³ç€å„ä¸ªSOCå‚å•†éƒ½æœ‰å„ä¸ç›¸åŒçš„å®ç°ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œgicçš„é©±åŠ¨ä¹Ÿæ— æ³•å»å¤„ç†ï¼Œè¿™å°±éœ€è¦é€šè¿‡stacked irqchipæ¥å®ç°ï¼Œå¹³å°çš„irqchipé€šè¿‡ä½œä¸ºä¸‹çº§çš„irqchipï¼Œgicä½œä¸ºé¡¶å±‚irqchipå°±å¯ä»¥ç”±SOCå‚å•†å»å…·ä½“å®šåˆ¶å”¤é†’åŠŸèƒ½çš„è®¾ç½®ã€‚<br></li>
<li>GICä¼šæ‰ç”µï¼Œæ²¡æœ‰ä»»ä½•åŠæ³•å”¤é†’ç³»ç»Ÿã€‚è¿™ç§æƒ…å†µå®Œå…¨æ˜¯é”™è¯¯çš„ï¼Œä¼‘çœ ç­‰äºè‡ªæ€ï¼Œéœ€è¦é¿å…è¿›å…¥è¿™ä¸ªçŠ¶å†µã€‚<br></li>
</ol>
<p>
æ‰€ä»¥å½“socæ®æœ‰å”¤é†’èƒ½åŠ›æ—¶ï¼Œéœ€è¦é€šè¿‡å¹³å°çš„gicé©±åŠ¨æ¥å®ç°ï¼Œarm gicé©±åŠ¨ä½œä¸ºå¹³å°gicçš„çˆ¶è®¾å¤‡ã€‚<br>
</p>
</div>
</div>

<div id="outline-container-orgabec106" class="outline-3">
<h3 id="orgabec106">linuxå†…æ ¸æ¥å£</h3>
<div class="outline-text-3" id="text-orgabec106">
<ul class="org-ul">
<li>/sys/power/pm_wakeup_irq<br>
å¯ä»¥æŸ¥è¯¢åˆ°æœ€è¿‘ä¸€æ¬¡ä¼‘çœ çš„å”¤é†’æº<br></li>
</ul>
</div>
</div>

<div id="outline-container-orgf083711" class="outline-3">
<h3 id="orgf083711">implement stacked irqchip</h3>
<div class="outline-text-3" id="text-orgf083711">
</div>
<div id="outline-container-orgb890355" class="outline-4">
<h4 id="orgb890355">used function &amp; macors</h4>
<div class="outline-text-4" id="text-orgb890355">
</div>
<ul class="org-ul">
<li><a id="org5e10039"></a>IRQCHIP_DECLARE<br>
<div class="outline-text-5" id="text-org5e10039">
<p>
ç”¨æ¥å£°æ˜ä¸€ä¸ªirqchipé©±åŠ¨ï¼ŒåŒ…å«compatibleå±æ€§ï¼Œirqchipçš„åç§°ï¼Œä»¥åŠåˆå§‹åŒ–å‡½æ•°<br>
device tree<br>
dtsä¸­é…ç½®äº†sysirqï¼Œå…¶parentæ˜¯gicï¼Œ<br>
</p>
<div class="org-src-container">
<pre class="src src-dts"><code><span style="color: #dcaeea;">gic</span>: <span style="color: #ECBE7B;">interrupt-controller</span>@58000000 {</code>
<code>    <span style="color: #dcaeea;">status</span> = <span style="color: #98be65;">"okay"</span>;</code>
<code>    <span style="color: #dcaeea;">compatible</span> = <span style="color: #98be65;">"arm,gic-v3"</span>;</code>
<code>    #<span style="color: #dcaeea;">interrupt-cells</span> = &lt;3&gt;;</code>
<code>    #<span style="color: #dcaeea;">address-cells</span> = &lt;2&gt;;</code>
<code>    #<span style="color: #dcaeea;">size-cells</span> = &lt;2&gt;;</code>
<code>    <span style="color: #dcaeea;">ranges</span>;</code>
<code>    <span style="color: #dcaeea;">interrupt-controller</span>;</code>
<code>    <span style="color: #dcaeea;">reg</span> =   &lt;0x0 0x58000000 0x0 0x10000&gt;,       <span style="color: #5B6268;">// GICD</span></code>
<code>        &lt;0x0 0x58040000 0x0 0x100000&gt;;      <span style="color: #5B6268;">// GICR0~7</span></code>
<code>    <span style="color: #dcaeea;">interrupts</span> = &lt;1 9 4&gt;;</code>
<code>};</code>
<code></code>
<code><span style="color: #dcaeea;">sysirq</span>: sysirq@<span style="color: #ECBE7B;">system</span> {</code>
<code>    <span style="color: #dcaeea;">compatible</span> = <span style="color: #98be65;">"xxx,XX-sysirq"</span>, <span style="color: #98be65;">"syscon"</span>;</code>
<code>    #<span style="color: #dcaeea;">interrupt-cells</span> = &lt;3&gt;;</code>
<code>    <span style="color: #dcaeea;">interrupt-parent</span> = &lt;&amp;<span style="color: #dcaeea;">gic</span>&gt;;</code>
<code>    <span style="color: #dcaeea;">interrupt-controller</span>;</code>
<code>    <span style="color: #dcaeea;">ranges</span>;</code>
<code>    <span style="color: #dcaeea;">services</span> = &lt;&amp;<span style="color: #dcaeea;">tee_regmap</span>&gt;;</code>
<code>    <span style="color: #dcaeea;">irq-map</span> = &lt;48 2 0&gt;, <span style="color: #5B6268;">// GPIO</span></code>
<code>    &lt;29 4 1&gt;, <span style="color: #5B6268;">// AON RTC</span></code>
<code>    &lt;31 6 0&gt;, <span style="color: #5B6268;">// aon timer1</span></code>
<code>    &lt;30 8 0&gt;, <span style="color: #5B6268;">// aon time0</span></code>
<code>    &lt;9 10 0&gt;, <span style="color: #5B6268;">// eth0</span></code>
<code>    &lt;33 18 0&gt;, <span style="color: #5B6268;">// canfd0</span></code>
<code>    &lt;36 14 0&gt;; <span style="color: #5B6268;">// canfd1</span></code>
<code>    <span style="color: #dcaeea;">reg</span> = &lt;0x0 0x43060000 0x0 0x634&gt;;</code>
<code>};</code>
</pre>
</div>
</div>
</li>

<li><a id="orgec72382"></a>get map configuration from device tree node.<br>
<div class="outline-text-5" id="text-orgec72382">
<div class="org-src-container">
<pre class="src src-dts"><code><span style="color: #dcaeea;">irq-map</span> = &lt;irq-number enable-bit polar-bit&gt;;</code>
<code>#<span style="color: #dcaeea;">address-cells</span> = &lt;2&gt;;</code>
<code>#<span style="color: #dcaeea;">size-cells</span> = &lt;2&gt;;</code>
<code><span style="color: #dcaeea;">reg</span> = &lt;0x0 0x43840000 0x0 0x634&gt;;</code>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgdbcf161" class="outline-4">
<h4 id="orgdbcf161">irq domain</h4>
<div class="outline-text-4" id="text-orgdbcf161">
<p>
å…³äºirq domainå¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡æ¡£<br>
<a href="https://lwn.net/Articles/487684/">https://lwn.net/Articles/487684/</a><br>
</p>
</div>
</div>

<div id="outline-container-org6211cda" class="outline-4">
<h4 id="org6211cda">irq initialization</h4>
<div class="outline-text-4" id="text-org6211cda">
<div class="org-src-container">
<pre class="src src-C"><code>(<span style="color: #ECBE7B;">gdb</span>) bt</code>
<code><span style="color: #51afef; font-weight: bold;">#0</span>  XX_irq_of_init (node=0xffffffc03efed568, parent=0x0 &lt;bl1_entrypoint&gt;) at ./include/linux/irqdomain.h:298</code>
<code><span style="color: #51afef; font-weight: bold;">#1</span>  0xffffff8008856224 in of_irq_init (matches=&lt;optimized out&gt;) <span style="color: #ECBE7B;">at</span> <span style="color: #dcaeea;">drivers</span>/of/irq.c:546</code>
<code><span style="color: #51afef; font-weight: bold;">#2</span>  0xffffff8008849240 in irqchip_init () <span style="color: #ECBE7B;">at</span> <span style="color: #dcaeea;">drivers</span>/irqchip/irqchip.c:29</code>
<code><span style="color: #51afef; font-weight: bold;">#3</span>  0xffffff800883241c in init_IRQ () <span style="color: #ECBE7B;">at</span> <span style="color: #dcaeea;">arch</span>/arm64/kernel/irq.c:91</code>
<code><span style="color: #51afef; font-weight: bold;">#4</span>  0xffffff80088309f8 in start_kernel () <span style="color: #ECBE7B;">at</span> <span style="color: #dcaeea;">init</span>/main.c:611</code>
<code><span style="color: #51afef; font-weight: bold;">#5</span>  0x0000000000000000 in ?? ()</code>
<code><span style="color: #ECBE7B;">Backtrace</span> <span style="color: #c678dd;">stopped</span>: previous frame identical to this frame (<span style="color: #ECBE7B;">corrupt</span> <span style="color: #dcaeea;">stack</span>?)</code>
</pre>
</div>
<p>
æŸ¥æ‰¾partentçš„irq, å¹¶æ·»åŠ æ–°çš„irq_domain<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code>domain_parent = irq_find_host(parent);</code>
<code><span style="color: #51afef;">if</span> (<span style="color: #51afef; font-weight: bold;">!</span>domain_parent) {</code>
<code>    pr_err(<span style="color: #98be65;">"XX_irq: interrupt-parent not found\n"</span>);</code>
<code>    <span style="color: #51afef;">return</span> -EINVAL;</code>
<code>}</code>
<code></code>
<code>domain = irq_domain_add_hierarchy(domain_parent, 0, intpol_num, node,</code>
<code>                  &amp;sysirq_domain_ops, chip_data);</code>
<code><span style="color: #51afef;">if</span> (<span style="color: #51afef; font-weight: bold;">!</span>domain) {</code>
<code>    ret = -ENOMEM;</code>
<code>    <span style="color: #51afef;">goto</span> <span style="color: #a9a1e1;">out_unmap</span>;</code>
<code>}</code>
</pre>
</div>
<p>
ä¸Šé¢æ˜¯ä¸»è¦å†…å®¹ï¼Œåˆ†ä¸ºä¸¤æ­¥<br>
</p>
<ol class="org-ol">
<li>è·å–parentçš„irq domain<br></li>
<li>æ·»åŠ æ–°çš„irq_domainæ¥å®ç°éœ€è¦çš„æ“ä½œ<br></li>
</ol>
</div>
</div>
<div id="outline-container-org39be6d7" class="outline-4">
<h4 id="org39be6d7">irq domain ops</h4>
<div class="outline-text-4" id="text-org39be6d7">
<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">XX_irq_domain_translate</span>(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">irq_domain</span> *<span style="color: #dcaeea;">d</span>,</code>
<code>                                <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">irq_fwspec</span> *<span style="color: #dcaeea;">fwspec</span>,</code>
<code>                                <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> *<span style="color: #dcaeea;">hwirq</span>,</code>
<code>                                <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">int</span> *<span style="color: #dcaeea;">type</span>)</code>
<code>{</code>
<code>    <span style="color: #51afef;">if</span> (is_of_node(fwspec-&gt;fwnode)) {</code>
<code>        <span style="color: #51afef;">if</span> (fwspec-&gt;param_count != 3)</code>
<code>            <span style="color: #51afef;">return</span> -EINVAL;</code>
<code></code>
<code>        <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">No PPI should point to this domain</span><span style="color: #5B6268;"> */</span></code>
<code>        <span style="color: #51afef;">if</span> (fwspec-&gt;param[0] != GIC_SPI)</code>
<code>            <span style="color: #51afef;">return</span> -EINVAL;</code>
<code></code>
<code>        *hwirq = fwspec-&gt;param[1];</code>
<code>        *type = fwspec-&gt;param[2] &amp; IRQ_TYPE_SENSE_MASK;</code>
<code>        <span style="color: #51afef;">return</span> 0;</code>
<code>    }</code>
<code></code>
<code>    <span style="color: #51afef;">return</span> -EINVAL;</code>
<code>}</code>
<code></code>
<code><span style="color: #51afef;">static</span> <span style="color: #51afef;">const</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">irq_domain_ops</span> <span style="color: #dcaeea;">sysirq_domain_ops</span> = {</code>
<code>    .translate  = XX_irq_domain_translate,</code>
<code>    .alloc              = XX_irq_domain_alloc,</code>
<code>    .free               = irq_domain_free_irqs_common,</code>
<code>};</code>
</pre>
</div>
<p>
å…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯ translate æ¥å£ï¼Œè¿™ä¸ªæ¥å£å®ç°äº†irqå·çš„è½¬æ¢åŠŸèƒ½ã€‚<br>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orga0a8f6f" class="outline-2">
<h2 id="orga0a8f6f">ATFè½¯ä»¶</h2>
<div class="outline-text-2" id="text-orga0a8f6f">
<p>
arm atfä¸­å®ç°äº†psciåè®®ï¼Œå½“ç³»ç»Ÿä¼‘çœ æ—¶ï¼Œå¯ä»¥é€šè¿‡psciæ¥è¿›å…¥ä¼‘çœ ã€‚psciæ–¹æ³•ï¼šPSCI_CPU_SUSPEND_AARCH64ï¼ŒPSCI_CPU_SUSPEND_AARCH32<br>
suspendçš„æ–¹æ³•åŸå‹ä¸ºï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">psci_cpu_suspend</span>(<span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">power_state</span>,</code>
<code>        <span style="color: #ECBE7B;">uintptr_t</span> <span style="color: #dcaeea;">entrypoint</span>,</code>
<code>        <span style="color: #ECBE7B;">u_register_t</span> <span style="color: #dcaeea;">context_id</span>);</code>
</pre>
</div>
</div>
<div id="outline-container-org570b3cf" class="outline-3">
<h3 id="org570b3cf">å‚æ•°ï¼š</h3>
<div class="outline-text-3" id="text-org570b3cf">
<dl class="org-dl">
<dt>power_state</dt><dd>power_stateå‚æ•°æ¯”è¾ƒå¤æ‚ï¼Œpower_stateå®šä¹‰äº†ç³»ç»Ÿè¦å¤„äºçš„ä½åŠŸè€—æ¨¡å¼ï¼Œæ ¹æ®ç³»ç»Ÿçš„å®ç°ï¼Œæœ‰ä¸¤ç§æ ¼å¼å¯ä¾›é€‰æ‹©ã€‚<br></dd>
<dt>entrypoint</dt><dd><p>
resumeä¹‹åçš„å…¥å£åœ°å€ï¼Œéœ€è¦æä¾›PAï¼Œæˆ–è€…IPA<br>
</p>
<blockquote>
<p>
The entry_point_address parameter is used by the caller to specify where code execution needs to resume at wakeup time. The parameter must be a Physical Address (PA), or, for a guest OS in a virtualized platform, an Intermediate Physical Address (IPA). In this case, the hypervisor must trap the call. Further details can be found in section<br>
</p>
</blockquote></dd>
<dt>context_id</dt><dd>å›ä¼ å‚æ•°ï¼Œå½“ç³»ç»Ÿresumeä¹‹åï¼Œpsciå°†è¿™ä¸ªå€¼æ”¾å…¥X0/W0/R0ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’è¿‡å»ã€‚<br></dd>
</dl>
</div>
</div>

<div id="outline-container-org4909732" class="outline-3">
<h3 id="org4909732">å¹³å°ç›¸å…³å®ç°</h3>
<div class="outline-text-3" id="text-org4909732">
<p>
åœ¨å¹³å°çš„å®ç°ä¸­ï¼ŒATFæœ‰å‡ ä¸ªå‡½æ•°æ˜¯éœ€è¦SOCå¹³å°è¿›è¡Œå®ç°çš„ã€‚<br>
åœ¨atfä¸­ï¼Œpsci libå·²ç»å®ç°äº†å¹³å°æ— å…³éƒ¨ä»½çš„ä»£ç ï¼Œéƒ¨ä»½ä»£ç éœ€è¦socå¹³å°æ¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ¥å®ç°ã€‚psci libä¸­ä¸ä¼‘çœ å”¤é†’å…³ç³»ä¸å¤§ï¼Œä¸Šè¿°å‚æ•°ä¸­entrypointä»¥åŠcontext_idéƒ½æ—¶psciä»£ç æ¥å¤„ç†ï¼ŒSOCå¹³å°æ— éœ€å…³å¿ƒæ­¤éƒ¨ä»½ä»£ç ã€‚<br>
ä¸ºäº†æœ‰ä¸€ä¸ªå¯¹atfä¸­çš„ä¼‘çœ å”¤é†’æµç¨‹æœ‰ä¸€ä¸ªç›´è§‚çš„å½±å“ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç è°ƒç”¨æ—¶åºå›¾æ¥è¯´æ˜<br>
</p>

<div id="orgdfc7372" class="figure">
<p><img src="assets/atf-suspend-resume.png" alt="atf-suspend-resume.png"><br>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb0a401b" class="outline-2">
<h2 id="orgb0a401b">refs</h2>
<div class="outline-text-2" id="text-orgb0a401b">
<p>
<a href="https://patchwork.kernel.org/patch/9343061/">https://patchwork.kernel.org/patch/9343061/</a><br>
<a href="https://patchwork.kernel.org/patch/6799191/">https://patchwork.kernel.org/patch/6799191/</a><br>
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
è™½ç„¶gicå¯ä»¥å·¥ä½œæ¥è¾“å‡ºå”¤é†’ä¿¡å·ï¼Œä½†æ˜¯è¾“å‡ºçš„å”¤é†’ä¿¡å·ä»éœ€gicä¹‹å¤–çš„æ§åˆ¶å™¨æ¥å¤„ç†<br>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
CPU power downè¿˜éœ€è¦SOCå†…éƒ¨power controllerçš„æ”¯æŒï¼Œå…·ä½“SOCä¹Ÿæœ‰è¾ƒå¤§åŒºåˆ«ï¼Œåœ¨æ­¤ä¸åšå…³ç³»<br>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
è§†SOCçš„å®ç°ä¸åŒï¼Œenable_irq_wakeä¹Ÿä¸æ˜¯å¿…é¡»è°ƒç”¨ã€‚<br>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1598347.html">https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg1598347.html</a><br>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
