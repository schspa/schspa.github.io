<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2021-10-12 二 19:35 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Use Github Action to Sync blogs</title>
<meta name="generator" content="Org mode">
<meta name="author" content="schspa">
<meta name="description" content="Use Github Action to Sync blogs"
>
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content">
<h1 class="title">Use Github Action to Sync blogs</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd212838">环境介绍</a></li>
<li><a href="#orge464387">Runner 配置</a>
<ul>
<li><a href="#org15b5761">安装github runner</a></li>
<li><a href="#org6b895fe">自启动runner</a></li>
<li><a href="#org6ec7850">runner权限设置</a></li>
</ul>
</li>
<li><a href="#org5c6abc8">设置在push操作时自动更新</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd212838" class="outline-2">
<h2 id="orgd212838">环境介绍</h2>
<div class="outline-text-2" id="text-orgd212838">
<p>
我自己的Blog是通过<a href="https://orgmode.org/manual/Publishing.html">org-publish</a>来生成的, 生成之后部属在<a href="http://schspa.tk">schspa.tk</a>以及<a href="http://schspa.github.io">github io</a>上，之前每次更新博客之后，我都会向两个服务器上去同步一下博客，<br>
现在github有了<a href="https://github.com/features/actions">github action</a> 并且可以支持使用自己runner服务，这样我们就可以利用github action来动态在更新github action时自动更新博客了。<br>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">博客</td>
<td class="org-left">服务器</td>
<td class="org-left">版本</td>
</tr>

<tr>
<td class="org-left"><a href="http://schspa.tk">schspa.tk</a></td>
<td class="org-left">schspa.tk</td>
<td class="org-left">Ubuntu 18.04</td>
</tr>

<tr>
<td class="org-left"><a href="https://schspa.github.io">schspa.github.io</a></td>
<td class="org-left">github</td>
<td class="org-left">github</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orge464387" class="outline-2">
<h2 id="orge464387">Runner 配置</h2>
<div class="outline-text-2" id="text-orge464387">
</div>
<div id="outline-container-org15b5761" class="outline-3">
<h3 id="org15b5761">安装github runner</h3>
<div class="outline-text-3" id="text-org15b5761">
<p>
按照下面的官方文档可以很容易的部属好runner，部属过程很顺利，没有遇到任何错误<br>
<a href="https://docs.github.com/en/free-pro-team@latest/actions/hosting-your-own-runners/adding-self-hosted-runners">https://docs.github.com/en/free-pro-team@latest/actions/hosting-your-own-runners/adding-self-hosted-runners</a><br>
</p>
</div>
</div>
<div id="outline-container-org6b895fe" class="outline-3">
<h3 id="org6b895fe">自启动runner</h3>
<div class="outline-text-3" id="text-org6b895fe">
<p>
按照官方的wiki，linux下可以使用官方自己给的systemd服务配置文件就可以配置好开机自启动<br>
<a href="https://docs.github.com/en/free-pro-team@latest/actions/hosting-your-own-runners/configuring-the-self-hosted-runner-application-as-a-service">https://docs.github.com/en/free-pro-team@latest/actions/hosting-your-own-runners/configuring-the-self-hosted-runner-application-as-a-service</a><br>
</p>
<div class="org-src-container">
<pre class="src src-bash">ubuntu@ip-172-31-43-98:~/actions-runner$ sudo ./svc.sh install
Creating launch runner<span style="color: #51afef;"> in</span> /etc/systemd/system/actions.runner.schspa-schspa.github.io.schspa.tk.service
Run as user: ubuntu
Run as uid: 1000
gid: 1000
Created symlink /etc/systemd/system/multi-user.target.wants/actions.runner.schspa-schspa.github.io.schspa.tk.service &#8594; /etc/systemd/system/actions.runner.schspa-schspa.github.io.schspa.tk.service.
ubuntu@ip-172-31-43-98:~/actions-runner$ sudo ./svc.sh start

/etc/systemd/system/actions.runner.schspa-schspa.github.io.schspa.tk.service
&#9679; actions.runner.schspa-schspa.github.io.schspa.tk.service - Github sync Runner
   Loaded: loaded (/etc/systemd/system/actions.runner.schspa-schspa.github.io.schspa.tk.service; enabled; vendor preset: enabled)
   Active: active (running) since Fri 2020-10-09 22:54:47 CST; 21ms ago
 Main PID: 2032 (runsvc.sh)
    Tasks: 2 (<span style="color: #c678dd;">limit</span>: 1140)
   CGroup: /system.slice/actions.runner.schspa-schspa.github.io.schspa.tk.service
           &#9500;&#9472;2032 /bin/bash /home/ubuntu/actions-runner/runsvc.sh
           &#9492;&#9472;2038 /bin/bash /home/ubuntu/actions-runner/runsvc.sh

Oct 09 22:54:47 ip-172-31-43-98 systemd[1]: Started Github sync Runner.
Oct 09 22:54:47 ip-172-31-43-98 runsvc.sh[2032]: .path=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ec7850" class="outline-3">
<h3 id="org6ec7850">runner权限设置</h3>
<div class="outline-text-3" id="text-org6ec7850">
<p>
由于runner直接安装在了host机上，没有docker等容器的保护，所以权限方面要格外设置好，放置不法分子利用这个runner来攻击服务器。<br>
</p>

<p>
下面是我自己的权限设置，只允许自己使用<br>
</p>

<div id="orgbd6e34c" class="figure">
<p><img src="assets/github-selfhost-action-setup.jpg" alt="github-selfhost-action-setup.jpg"><br>
</p>
<p><span class="figure-number">Figure 1: </span>runner权限设置</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org5c6abc8" class="outline-2">
<h2 id="org5c6abc8">设置在push操作时自动更新</h2>
<div class="outline-text-2" id="text-org5c6abc8">
<p>
配置文件：<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">name: sync to schspa.tk

on:
  push:
    branches:
    - master

jobs:
  sync:
    runs-on: schspa.tk

    steps:
    - name: Sync blogs
      run: bash -c "cd ~/sites &amp;&amp; git fetch &amp;&amp; git reset --hard origin/master"
</pre>
</div>
<p>
很简单，上面的配置文件告诉github，在收到master分支的push事件时，就自动在标签为schspa.tk的runner上自动执行下面的Sync blogs的步骤。<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="✨💬✨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">虚怀乃若谷，水深则流缓。</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
