<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-03-03 Thu 11:47 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Use org-caldav to sync calendars</title>
<meta name="author" content="Schspa" />
<meta name="description" content="Use org-caldav to sync calendars" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">Use org-caldav to sync calendars</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgeeef049">è·å–caldavé“¾æ¥</a></li>
<li><a href="#orgbfdbb3a">æ·»åŠ org-caldavè®¾ç½®</a>
<ul>
<li><a href="#orge9434a1">é…ç½®</a></li>
<li><a href="#orge715909">æ›´æ–°æ—¥å†</a></li>
<li><a href="#org0559c4a">å¯†ç è®¤è¯</a>
<ul>
<li><a href="#orgf86ff7c">ä½¿ç”¨gpg + authinfoæ¥è¿›è¡Œè®¤è¯</a></li>
</ul>
</li>
<li><a href="#org4cff26e">å‚è€ƒèµ„æ–™ï¼š</a></li>
</ul>
</li>
<li><a href="#org44241c0">è¿›é˜¶</a>
<ul>
<li><a href="#orgf32a490">æµ‹è¯•</a></li>
<li><a href="#orgb35f247"><span class="done DONE">DONE</span> è‡ªåŠ¨ç”Ÿæˆorg-protocolé“¾æ¥</a>
<ul>
<li><a href="#orgc1c8f9d">åœ¨å¯¼å‡ºæ—¶icalendaræ—¶è‡ªåŠ¨ç”Ÿæˆæ‰“å¼€å¯¹åº”task elementçš„é“¾æ¥</a></li>
<li><a href="#org0bc0b9b">æ·»åŠ org-protocolåè®®å¤„ç†å‡½æ•°ï¼Œè‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”çš„taskèŠ‚ç‚¹</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgeeef049" class="outline-2">
<h2 id="orgeeef049">è·å–caldavé“¾æ¥</h2>
<div class="outline-text-2" id="text-orgeeef049">
<p>
ä»¥nextcloudä¸ºä¾‹ï¼Œæ‰“å¼€ç½‘é¡µï¼Œå¹¶è¿›å…¥å€’æ—¥å†é€‰é¡¹å¡<br>
</p>
<p>
<img src="assets/2020-10-03_13-41-44_screenshot.png" alt="2020-10-03_13-41-44_screenshot.png"><br>
ç‚¹å‡»ä¸Šå›¾ä¸­çš„personalæ—¥å†çš„linké€‰é¡¹ï¼Œæ—¢å¯è·å¾—é“¾æ¥<br>
ä¸‹é¢è¿™ä¸ªè¿™ä¸ªå°±æ˜¯æˆ‘è‡ªå·±è·å–åˆ°çš„é“¾æ¥äº†ï¼ˆæ•æ„Ÿä¿¡æ¯å·²ç»ä½¿ç”¨å°–æ‹¬å·æ›¿æ¢æ‰äº†ï¼‰<br>
<a href="https://">https://</a>&lt;SERVER-DOMAIN.com&gt;/remote.php/dav/calendars/&lt;PERSONAL-UUID&gt;/personal/<br>
</p>
</div>
</div>

<div id="outline-container-orgbfdbb3a" class="outline-2">
<h2 id="orgbfdbb3a">æ·»åŠ org-caldavè®¾ç½®</h2>
<div class="outline-text-2" id="text-orgbfdbb3a">
</div>
<div id="outline-container-orge9434a1" class="outline-3">
<h3 id="orge9434a1">é…ç½®</h3>
<div class="outline-text-3" id="text-orge9434a1">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span style="color: #5B6268;">;; </span><span style="color: #5B6268;">org-caldav</span></code>
<code>(<span style="color: #51afef;">use-package</span> <span style="color: #a9a1e1;">org-caldav</span></code>
<code>  <span style="color: #c678dd;">:ensure</span> t</code>
<code>  <span style="color: #c678dd;">:config</span></code>
<code>  (<span style="color: #51afef;">unless</span> (file-exists-p (concat my-cache-dir <span style="color: #98be65;">"/org-caldav/"</span>))</code>
<code>    (make-directory (concat my-cache-dir <span style="color: #98be65;">"/org-caldav/"</span>)))</code>
<code></code>
<code>  (<span style="color: #51afef;">setq</span> org-caldav-url <span style="color: #98be65;">"https://&lt;SERVER-DOMAIN.com&gt;/remote.php/dav/calendars/&lt;PERSONAL-UUID&gt;"</span>)</code>
<code>  (<span style="color: #51afef;">setq</span> org-caldav-calendar-id <span style="color: #98be65;">"personal"</span>)</code>
<code>  (<span style="color: #51afef;">setq</span></code>
<code>   org-caldav-save-directory (concat my-cache-dir <span style="color: #98be65;">"/org-caldav/"</span>)</code>
<code>   org-caldav-backup-file (concat my-cache-dir <span style="color: #98be65;">"/org-caldav-backup.org"</span>)</code>
<code>   org-caldav-show-sync-results 'nil</code>
<code>   org-caldav-files (mapcar (<span style="color: #51afef;">lambda</span> (x)</code>
<code>                              (concat org-directory x))</code>
<code>                            '(<span style="color: #98be65;">"gtd/homework.org"</span> <span style="color: #98be65;">"gtd/tasks.org"</span>)))</code>
<code>  (<span style="color: #51afef;">setq</span> org-caldav-inbox (concat org-directory <span style="color: #98be65;">"gtd/inbox.org"</span>)))</code>
</pre>
</div>
<p>
éœ€è¦æ³¨æ„ï¼Œä¸Šé¢å¡«å†™çš„org-caldav-canlendar-idæ˜¯personalï¼ŒåŒä¸€ä¸ªè´¦æˆ·å¯ä»¥æœ‰å¤šä¸ªæ—¥å†ï¼Œé€‰æ‹©å…¶ä¸­ä¸€ä¸ªä¸orgmodeåšåŒæ­¥<br>
</p>
</div>
</div>
<div id="outline-container-orge715909" class="outline-3">
<h3 id="orge715909">æ›´æ–°æ—¥å†</h3>
<div class="outline-text-3" id="text-orge715909">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>M-x org-caldav-sync</code>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0559c4a" class="outline-3">
<h3 id="org0559c4a">å¯†ç è®¤è¯</h3>
<div class="outline-text-3" id="text-org0559c4a">
<p>
åœ¨åŒæ­¥æ—¶ï¼Œæ¯æ¬¡éœ€è¦è®¤è¯ï¼Œéƒ½è¦è¾“å…¥å¯†ç , é€šè¿‡emacsè‡ªå¸¦çš„auth sourceï¼Œå¯ä»¥å®Œæˆè‡ªåŠ¨ç™»å½•<br>
</p>
</div>
<div id="outline-container-orgf86ff7c" class="outline-4">
<h4 id="orgf86ff7c">ä½¿ç”¨gpg + authinfoæ¥è¿›è¡Œè®¤è¯</h4>
<div class="outline-text-4" id="text-orgf86ff7c">
</div>
<ul class="org-ul">
<li><a id="org3e0c3c9"></a>åˆ›å»ºgpg key<br>
<div class="outline-text-5" id="text-org3e0c3c9">
<div class="org-src-container">
<pre class="src src-bash"><code>gpg --gen-key</code>
<code><span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#25353;&#29031;&#25552;&#31034;&#36755;&#20837;&#21517;&#31216;&#65292;&#37038;&#31665;&#65292;&#21475;&#20196;&#31561;&#20449;&#24687;</span></code>
</pre>
</div>
</div>
</li>
<li><a id="org8115821"></a>ç”Ÿæˆ~/.authinfo<br>
<div class="outline-text-5" id="text-org8115821">
<div class="org-src-container">
<pre class="src src-bash"><code>touch ~/.authinfo</code>
<code>gpg -e ~/.authinfo</code>
<code>rm ~/.authinfo</code>
</pre>
</div>
</div>
</li>
<li><a id="org2fc8a58"></a>æ‰“å¼€ ~/.authinfo.gpg<br>
<div class="outline-text-5" id="text-org2fc8a58">
<div class="org-src-container">
<pre class="src src-authinfo"><code>machine &lt;SERVER-DOMAIN&gt;.com:443 port https login &lt;USER-NAME&gt; password &lt;PASSWORD&gt;</code>
</pre>
</div>
</div>
</li>
<li><a id="org66ca62b"></a>è¿è¡Œorg-caldav-sync<br>
<div class="outline-text-5" id="text-org66ca62b">
<p>
è¿™ä¸‹åº”è¯¥ä¸ä¼šå†æç¤ºè¾“å…¥å¯†ç äº†ï¼ˆæ³¨ï¼šå¯èƒ½éœ€è¦è¾“å…¥gpg keyçš„å£ä»¤ï¼‰<br>
</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-org4cff26e" class="outline-3">
<h3 id="org4cff26e">å‚è€ƒèµ„æ–™ï¼š</h3>
<div class="outline-text-3" id="text-org4cff26e">
<p>
<a href="https://www.gnu.org/software/emacs/manual/html_mono/auth.html">Emacs auth-source</a><br>
<a href="https://bretthutley.com/2018/09/01/emacs-gpg-and-pinentry-on-mac/">Emacs, gpg and pinentry on Mac</a><br>
<a href="https://www.masteringemacs.org/article/keeping-secrets-in-emacs-gnupg-auth-sources">Keeping Secrets in Emacs with GnuPG and Auth Sources</a><br>
</p>
</div>
</div>
</div>
<div id="outline-container-org44241c0" class="outline-2">
<h2 id="org44241c0">è¿›é˜¶</h2>
<div class="outline-text-2" id="text-org44241c0">
</div>
<div id="outline-container-orgf32a490" class="outline-3">
<h3 id="orgf32a490">æµ‹è¯•</h3>
<div class="outline-text-3" id="text-orgf32a490">
<p>
emacs-macä¸»åˆ†æ”¯ä¸Šçš„ä»£ç è¿˜æœ‰BUGï¼Œæ— æ³•é€šè¿‡open-sourceæ¥æ‰“å¼€æ–‡ä»¶ï¼Œè¯¦è§<a href="https://emacs-china.org/t/org-protocol-open-source/14692">org-protocol://open-sourceæ— æ³•æ‰“å¼€æ–‡ä»¶</a><br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code><span style="color: #5B6268;"># </span><span style="color: #5B6268;">emacs-mac use apple script for url handle.</span></code>
<code>open  <span style="color: #98be65;">'org-protocol://open-source?url=gtd%2Finbox.org'</span></code>
<code></code>
<code><span style="color: #5B6268;"># </span><span style="color: #5B6268;">others use emacsclient for url handle</span></code>
<code>emacsclient  <span style="color: #98be65;">'org-protocol://open-source?url=gtd%2Finbox.org'</span></code>
<code>Waiting for Emacs...</code>
</pre>
</div>
<p>
æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“åœ¨shellä¸­æ‰§è¡Œä»¥ä¸Šå‘½ä»¤æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰“å¼€å¯¹åº”çš„æ–‡ä»¶ã€‚å¦‚æœä¸èƒ½æ‰“å¼€ï¼Œåˆ™éœ€è¦æ£€æŸ¥org-protocalé…ç½®<br>
</p>
</div>
</div>
<div id="outline-container-orgb35f247" class="outline-3">
<h3 id="orgb35f247"><span class="done DONE">DONE</span> è‡ªåŠ¨ç”Ÿæˆorg-protocolé“¾æ¥</h3>
<div class="outline-text-3" id="text-orgb35f247">
</div>
<div id="outline-container-orgc1c8f9d" class="outline-4">
<h4 id="orgc1c8f9d">åœ¨å¯¼å‡ºæ—¶icalendaræ—¶è‡ªåŠ¨ç”Ÿæˆæ‰“å¼€å¯¹åº”task elementçš„é“¾æ¥</h4>
<div class="outline-text-4" id="text-orgc1c8f9d">
<p>
é€šè¿‡org-protocolï¼Œè‡ªå®šä¹‰gdtçš„å­åè®®ï¼Œå¹¶ä¸”é€šè¿‡orgæ–‡ä»¶èŠ‚ç‚¹çš„IDï¼Œå¯ä»¥è½»æ¾å®Œæˆè¿™ä¸ªæ“ä½œï¼Œç”±äºicalendarçš„æ¥å£æ²¡æœ‰æä¾›è‡ªå®šä¹‰entryçš„æ–¹æ³•ï¼Œè¿™é‡Œå¯¹org-icalendar&#x2013;valarmè¿›è¡Œäº†hookï¼Œåœ¨æ·»åŠ valarmå±æ€§ä¹‹å‰ï¼ŒåŠ ä¸Š<a href="https://tools.ietf.org/html/rfc5545#section-3.8.4.6">rfc5545 URL property</a> URLå±æ€§<br>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span style="color: #5B6268;">;; </span><span style="color: #5B6268;">setup icalendar</span></code>
<code><span style="color: #5B6268;">;; </span><span style="color: #5B6268;">advice to org-icalendar--valarm</span></code>
<code><span style="color: #5B6268;">;; </span><span style="color: #5B6268;">we need entry argument, so this function is a goog choice.</span></code>
<code>(<span style="color: #51afef;">defun</span> <span style="color: #c678dd;">org-gdt-icalendar--valarm</span> (orig-fun <span style="color: #ECBE7B;">&amp;rest</span> args)</code>
<code>  <span style="color: #83898d;">"Add needed URL entry for icalendar"</span></code>
<code>  (<span style="color: #51afef;">let</span> ((valarms (apply orig-fun args)))</code>
<code>    (concat</code>
<code>     <span style="color: #98be65;">"URL:org-protocol://gdt?id="</span> (org-element-property <span style="color: #c678dd;">:ID</span> (car args)) <span style="color: #98be65;">"\n"</span></code>
<code>     (<span style="color: #51afef;">if</span> valarms valarms <span style="color: #98be65;">""</span>))))</code>
<code></code>
<code>(eval-after-load 'ox-icalendar</code>
<code>  (<span style="color: #51afef;">progn</span></code>
<code>    (<span style="color: #51afef;">setq</span> org-icalendar-include-todo t</code>
<code>          org-icalendar-use-deadline '(event-if-todo event-if-not-todo todo-due event-if-todo-not-done)</code>
<code>          org-icalendar-use-scheduled '(event-if-todo event-if-not-todo todo-start event-if-todo-not-done)</code>
<code>          org-icalendar-with-timestamps t)</code>
<code>    (advice-add 'org-icalendar--valarm <span style="color: #c678dd;">:around</span> #'org-gdt-icalendar--valarm)))</code>
</pre>
</div>
</div>
</div>
<div id="outline-container-org0bc0b9b" class="outline-4">
<h4 id="org0bc0b9b">æ·»åŠ org-protocolåè®®å¤„ç†å‡½æ•°ï¼Œè‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”çš„taskèŠ‚ç‚¹</h4>
<div class="outline-text-4" id="text-org0bc0b9b">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(<span style="color: #51afef;">require</span> '<span style="color: #a9a1e1;">org-protocol</span>)</code>
<code></code>
<code>(<span style="color: #51afef;">defun</span> <span style="color: #c678dd;">org-gdt-protocol-open</span> (info)</code>
<code>  <span style="color: #83898d;">"This handler simply opens the file with emacsclient.</span></code>
<code><span style="color: #83898d;">INFO is an alist containing additional information passed by the protocol URL.</span></code>
<code><span style="color: #83898d;">It should contain the id key, pointing to the ID property for a org file to open.</span></code>
<code><span style="color: #83898d;">  Example protocol string:</span></code>
<code><span style="color: #83898d;">org-protocol://gdt?id=CBEC8DD1-7814-44A7-AA3D-97AEC35B6DB7"</span></code>
<code>  (<span style="color: #51afef;">when-let</span> ((id (plist-get info <span style="color: #c678dd;">:id</span>)))</code>
<code>    (raise-frame)</code>
<code>    (org-open-link-from-string (format <span style="color: #98be65;">"id:%s"</span> id)))</code>
<code>  nil)</code>
<code></code>
<code>(<span style="color: #51afef;">push</span> '(<span style="color: #98be65;">"org-gdt-ref"</span>  <span style="color: #c678dd;">:protocol</span> <span style="color: #98be65;">"gdt"</span>   <span style="color: #c678dd;">:function</span> org-gdt-protocol-open)</code>
<code>      org-protocol-protocol-alist)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
