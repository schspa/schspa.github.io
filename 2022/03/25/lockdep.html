<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2023-09-25 Mon 11:27 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux lockdep</title>
<meta name="author" content="Schspa Shi" />
<meta name="generator" content="Org Mode" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">Linux lockdep</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org43cce1b">ç®€ä»‹</a></li>
<li><a href="#org8e9439e">å¯ä»¥æ£€æµ‹åˆ°çš„é—®é¢˜</a>
<ul>
<li><a href="#org6bc9ad8">é—®é¢˜æ±‡æ€»</a></li>
</ul>
</li>
<li><a href="#orgc113206">å®ç°åŸç†</a>
<ul>
<li><a href="#org1f258a1">å°†é”æŠ½è±¡æˆlock classï¼Œå¹¶ä¸”åœ¨å…¶ä¸­è®°å½•å„ç§äº‹ä»¶</a></li>
<li><a href="#org8732413">é”çŠ¶æ€</a></li>
<li><a href="#org393a532">åœ¨å½“å‰çš„task structä¸­è®°å½•ç›¸å…³çš„åŠ é”ä¿¡æ¯</a></li>
<li><a href="#org82bcfee">åœ¨è¿›è¡Œé”æ“ä½œæ—¶ï¼Œå¯¹æ¯”ä¹‹å‰å·²ç»æŒæœ‰çš„é”ä¿¡æ¯ï¼Œé€šè¿‡è§„åˆ™åˆ¤æ–­å‡ºå…·ä½“çš„å¼‚å¸¸</a></li>
</ul>
</li>
<li><a href="#org5764464">Debug</a></li>
<li><a href="#orgee0fbe5">refs</a></li>
</ul>
</div>
</div>

<div id="outline-container-org43cce1b" class="outline-2">
<h2 id="org43cce1b">ç®€ä»‹</h2>
<div class="outline-text-2" id="text-org43cce1b">
<p>
lockdepç”¨æ¥åˆ†æå†…æ ¸ä¸­çš„æŒé”é¡ºåºï¼Œä½¿ç”¨æƒ…å†µç­‰é—®é¢˜ï¼Œæœ¬æ–‡ç®€å•çš„åˆ†æä¸€ä¸‹å…¶å®ç°çš„åŸºæœ¬åŸç†ä»¥åŠä½¿ç”¨æ–¹æ³•.<br>
å†…æ ¸æ–‡æ¡£å¯å‚è€ƒ <a href="https://docs.kernel.org/locking/lockdep-design.html">https://docs.kernel.org/locking/lockdep-design.html</a><br>
</p>
</div>
</div>

<div id="outline-container-org8e9439e" class="outline-2">
<h2 id="org8e9439e">å¯ä»¥æ£€æµ‹åˆ°çš„é—®é¢˜</h2>
<div class="outline-text-2" id="text-org8e9439e">
</div>
<div id="outline-container-org6bc9ad8" class="outline-3">
<h3 id="org6bc9ad8">é—®é¢˜æ±‡æ€»</h3>
<div class="outline-text-3" id="text-org6bc9ad8">
</div>
<div id="outline-container-orge8ab453" class="outline-4">
<h4 id="orge8ab453">BUG: Invalid wait context</h4>
<div class="outline-text-4" id="text-orge8ab453">
<p>
è¿™ä¸ªç”¨æ¥åé¦ˆå†…æ ¸ä¸­æŒé”ä¸Šä¸‹æ–‡çš„é—®é¢˜ï¼Œå¯ä»¥æ£€æµ‹åˆ°å¦‚ä¸‹ç±»å‹çš„é—®é¢˜, è¯¦æƒ…å¯ä»¥å‚è€ƒæäº¤ <a href="https://lwn.net/Articles/579849/">https://lwn.net/Articles/579849/</a><br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code>raw_spin_lock(&amp;foo);</code>
<code>spin_lock(&amp;bar);</code>
<code>spin_unlock(&amp;bar);</code>
<code>raw_spin_unlock(&amp;foo);</code>
</pre>
</div>
<p>
ä¸‹é¢æ˜¯ä¸€æ®µå®é™…å‘ç°é—®é¢˜çš„log<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code>[   15.090335][    T1]</code>
<code>[   15.090359][    T1] =============================</code>
<code>[   15.090365][    T1] [ BUG: Invalid wait context ]</code>
<code>[   15.090373][    T1] 5.10.59-rt52-00983-g186a6841c682-dirty #3 Not tainted</code>
<code>[   15.090386][    T1] -----------------------------</code>
<code>[   15.090392][    T1] swapper/0/1 is trying to lock:</code>
<code>[   15.090402][    T1] 70ff00018507c188 (&amp;gc-&gt;bgpio_lock){....}-{3:3}, at: _raw_spin_lock_irqsave+0x1c/0x28</code>
<code>[   15.090470][    T1] other info that might help us debug this:</code>
<code>[   15.090477][    T1] context-{5:5}</code>
<code>[   15.090485][    T1] 3 locks held by swapper/0/1:</code>
<code>[   15.090497][    T1]  #0: c2ff0001816de1a0 (&amp;dev-&gt;mutex){....}-{4:4}, at: __device_driver_lock+0x98/0x104</code>
<code>[   15.090553][    T1]  #1: ffff90001485b4b8 (irq_domain_mutex){+.+.}-{4:4}, at: irq_domain_associate+0xbc/0x6d4</code>
<code>[   15.090606][    T1]  #2: 4bff000185d7a8e0 (lock_class){....}-{2:2}, at: _raw_spin_lock_irqsave+0x1c/0x28</code>
<code>[   15.090654][    T1] stack backtrace:</code>
<code>[   15.090661][    T1] CPU: 4 PID: 1 Comm: swapper/0 Not tainted 5.10.59-rt52-00983-g186a6841c682-dirty #3</code>
<code>[   15.090682][    T1] Hardware name: Horizon Robotics Journey 5 DVB (DT)</code>
<code>[   15.090692][    T1] Call trace:</code>
<code>[   15.090698][    T1]  dump_backtrace+0x0/0x708</code>
<code>[   15.090717][    T1]  show_stack+0x24/0x30</code>
<code>[   15.090733][    T1]  dump_stack+0x1b4/0x2bc</code>
<code>[   15.090752][    T1]  __lock_acquire+0x2800/0xb760</code>
<code>[   15.090774][    T1]  lock_acquire+0x248/0x85c</code>
<code>[   15.090793][    T1]  __raw_spin_lock_irqsave+0xd4/0x270</code>
<code>[   15.090811][    T1]  _raw_spin_lock_irqsave+0x1c/0x28</code>
<code>[   15.090828][    T1]  dwapb_irq_ack+0xb4/0x300</code>
<code>[   15.090846][    T1]  __irq_do_set_handler+0x494/0xb2c</code>
<code>[   15.090864][    T1]  __irq_set_handler+0x74/0x114</code>
<code>[   15.090881][    T1]  irq_set_chip_and_handler_name+0x44/0x58</code>
<code>[   15.090900][    T1]  gpiochip_irq_map+0x210/0x644</code>
<code>[   15.090917][    T1]  irq_domain_associate+0x168/0x6d4</code>
<code>[   15.090935][    T1]  irq_create_mapping_affinity+0x15c/0x354</code>
<code>[   15.090955][    T1]  gpiochip_to_irq+0xb4/0x390</code>
<code>[   15.090970][    T1]  gpiod_to_irq+0xf8/0x1e4</code>
<code>[   15.090987][    T1]  gpio_keys_probe+0x9a0/0x24d0</code>
<code>[   15.091008][    T1]  platform_drv_probe+0x138/0x214</code>
<code>[   15.091026][    T1]  really_probe+0x2e0/0x15d4</code>
<code>[   15.091045][    T1]  driver_probe_device+0x100/0x418</code>
<code>[   15.091064][    T1]  device_driver_attach+0x138/0x234</code>
<code>[   15.091084][    T1]  __driver_attach+0x184/0x358</code>
<code>[   15.091103][    T1]  bus_for_each_dev+0x100/0x1e0</code>
<code>[   15.091122][    T1]  driver_attach+0x5c/0x98</code>
<code>[   15.091141][    T1]  bus_add_driver+0x33c/0x9d8</code>
<code>[   15.091159][    T1]  driver_register+0x1e4/0x6b0</code>
<code>[   15.091179][    T1]  __platform_driver_register+0x118/0x214</code>
<code>[   15.091196][    T1]  gpio_keys_init+0x28/0x34</code>
<code>[   15.091218][    T1]  do_one_initcall+0x8c/0x2d8</code>
<code>[   15.091236][    T1]  do_initcall_level+0x144/0x230</code>
<code>[   15.091257][    T1]  do_initcalls+0xb0/0x170</code>
<code>[   15.091275][    T1]  do_basic_setup+0xd0/0xe4</code>
<code>[   15.091293][    T1]  kernel_init_freeable+0x180/0x3e4</code>
<code>[   15.091311][    T1]  kernel_init+0x2c/0x398</code>
<code>[   15.091330][    T1]  ret_from_fork+0x10/0x30</code>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge4f6c34" class="outline-4">
<h4 id="orge4f6c34">WARNING: bad contention detected!</h4>
<div class="outline-text-4" id="text-orge4f6c34">
<p>
è¿™ä¸ªé”™è¯¯è¡¨ç¤ºlockdepå†…éƒ¨é€»è¾‘å‡ºé”™ï¼Œä¸€èˆ¬ä¸åº”è¯¥æŠ¥å‡ºæ¥<br>
</p>
</div>
</div>
<div id="outline-container-org7060705" class="outline-4">
<h4 id="org7060705">WARNING: possible circular locking dependency detected</h4>
<div class="outline-text-4" id="text-org7060705">
<p>
è§ä¸‹é¢çš„åˆ†æï¼Œé€šè¿‡ä¾èµ–è·¯å¾„åˆ†ææ¥æ£€æµ‹<br>
ABBA, ABBCCA æ­»é”<br>
</p>
</div>
</div>
<div id="outline-container-org3e69467" class="outline-4">
<h4 id="org3e69467">WARNING: possible recursive locking detected</h4>
<div class="outline-text-4" id="text-org3e69467">
<p>
AAæ­»é”ï¼Œé‡å…¥<br>
è¿™ä¸ªé€šè¿‡éå†å·²è·å–åˆ°çš„é”åˆ—è¡¨ï¼Œåˆ¤æ–­å½“å‰çš„é”æ˜¯å¦å·²ç»è¢«è·å–åˆ°.è¯»é”é™¤å¤–.<br>
</p>
</div>
</div>
<div id="outline-container-org375d151" class="outline-4">
<h4 id="org375d151">WARNING: bad unlock balance detected</h4>
<div class="outline-text-4" id="text-org375d151">
<p>
lockå’Œunlockä¸æˆå¯¹è°ƒç”¨<br>
</p>
<ul class="org-ul">
<li>unlockæ—¶è¿›è¡Œæ£€æµ‹å‘ç°å½“å‰é”æ²¡æœ‰è¢«æŒæœ‰æ—¶æŠ¥é”™.<br></li>
<li>åˆå§‹åŒ–æ—¶æ£€æµ‹æ˜¯å¦æŒæœ‰é”ï¼ŒæŒæœ‰åˆ™æŠ¥é”™.<br></li>
</ul>
</div>
</div>
<div id="outline-container-org94808de" class="outline-4">
<h4 id="org94808de">WARNING: suspicious RCU usage</h4>
<div class="outline-text-4" id="text-org94808de">
<p>
åœ¨rcuä»£ç ä¸­é€šè¿‡RCU_LOCKDEP_WARNå®æ¥æŠ¥å‡ºæ¥çš„warning<br>
</p>
</div>
</div>
<div id="outline-container-org92f834e" class="outline-4">
<h4 id="org92f834e">WARNING: lock held when returning to user space!</h4>
<div class="outline-text-4" id="text-org92f834e">
<p>
åœ¨ç¦»å¼€å†…æ ¸ç©ºé—´æ—¶ï¼Œä¾æ—§æŒæœ‰å†…æ ¸ç©ºé—´ä¸­çš„é”, é€šè¿‡åœ¨ç¦»å¼€å†…æ ¸ç©ºé—´ä¹‹å‰è¿‡æ»¤è¿›ç¨‹å·²æŒæœ‰é”çš„åˆ—è¡¨æ¥åˆ¤æ–­.<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/entry/common.c#L215">kernel source for call lockdep_sys_exit();</a><br>
</p>
</div>
</div>
<div id="outline-container-org71888dc" class="outline-4">
<h4 id="org71888dc">WARNING: %s/%d still has locks held!</h4>
<div class="outline-text-4" id="text-org71888dc">
<p>
åœ¨è¿›ç¨‹freezeï¼Œexitæ—¶æŠ¥é”™<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/include/linux/freezer.h#L66">kernel source for no lock held check in include/linux/freezer.h</a><br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/exit.c#L836">kernel source for no_locks_held check in kernel/exit.c</a><br>
</p>
</div>
</div>
<div id="outline-container-org9c62ccd" class="outline-4">
<h4 id="org9c62ccd">WARNING: held lock freed!</h4>
<div class="outline-text-4" id="text-org9c62ccd">
<p>
é€šè¿‡debug_check_no_locks_freedæŠ¥é”™ï¼Œå†…æ ¸ä¸­åœ¨å¾ˆå¤šé”ï¼Œå¯¹è±¡åˆå§‹åŒ–çš„åœ°æ–¹åŠ å…¥è¯¥æ£€æŸ¥ï¼Œé€šè¿‡æ£€æŸ¥free/åˆå§‹åŒ–çš„åŒºåŸŸä¸­åŒ…å«å·²ç»æŒæœ‰çš„é”æ¥åˆ¤æ–­.<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/mm/slub.c#L1700">kernel source for lock freed check in mm/slub.c</a><br>
</p>
</div>
</div>
<div id="outline-container-org40afd9c" class="outline-4">
<h4 id="org40afd9c">WARNING: Nested lock was not taken</h4>
<div class="outline-text-4" id="text-org40afd9c">
<p>
æ£€æµ‹æŒæœ‰nesté”æ—¶ï¼Œæ˜¯å¦å·²ç»æŒæœ‰é”<br>
</p>
</div>
</div>

<div id="outline-container-orgab114aa" class="outline-4">
<h4 id="orgab114aa">WARNING: possible irq lock inversion dependency detected</h4>
<div class="outline-text-4" id="text-orgab114aa">
<p>
æ£€æµ‹ç”±äºirqé‡å…¥è€Œé€ æˆå¯èƒ½çš„æ­»é”<br>
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1304242">https://bugzilla.redhat.com/show_bug.cgi?id=1304242</a><br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>[  108.223030]        CPU0                    CPU1</code>
<code>[  108.223030]        ----                    ----</code>
<code>[  108.223030]   lock(&amp;(&amp;list-&gt;lock)-&gt;rlock#2);</code>
<code>[  108.223030]                                local_irq_disable();</code>
<code>[  108.223030]                                lock(policy_rwlock);</code>
<code>[  108.223030]                                lock(&amp;(&amp;list-&gt;lock)-&gt;rlock#2);</code>
<code>[  108.223030]   &lt;Interrupt&gt;</code>
<code>[  108.223030]     lock(policy_rwlock);</code>
</pre>
</div>
</div>
</div>
<div id="outline-container-org0510966" class="outline-4">
<h4 id="org0510966">WARNING: inconsistent lock state</h4>
<div class="outline-text-4" id="text-org0510966">
<p>
é”çŠ¶æ€ä¸åŒ¹é…ï¼Œi.e. åŒä¸€æŠŠé”åœ¨hardirq, softirq, è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨åˆ°ï¼Œä½†æ˜¯_bh, _irqçš„åç¼€ä½¿ç”¨é”™è¯¯ï¼Œå¯¼è‡´ç³»ç»Ÿæœ‰æ­»é”<br>
å¦‚ä¸‹é¢çš„patchï¼Œä»¥åŠä¿®å¤bug<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>[  313.402947]        CPU0</code>
<code>[  313.402948]        ----</code>
<code>[  313.402949]   lock(&amp;(&amp;wsm.lock)-&gt;rlock);</code>
<code>[  313.402951]   &lt;Interrupt&gt;</code>
<code>[  313.402952]     lock(&amp;(&amp;wsm.lock)-&gt;rlock);</code>
<code>[  313.402954]</code>
<code>*** DEADLOCK ***</code>
<code></code>
</pre>
</div>
<p>
<a href="https://lore.kernel.org/all/20190517231626.85614-1-dennis@kernel.org/">https://lore.kernel.org/all/20190517231626.85614-1-dennis@kernel.org/</a><br>
</p>
</div>
</div>
<div id="outline-container-org71bf41c" class="outline-4">
<h4 id="org71bf41c">WARNING: chain_key collision</h4>
<div class="outline-text-4" id="text-org71bf41c">
<p>
<a href="https://lkml.iu.edu/hypermail/linux/kernel/1606.0/02129.html">https://lkml.iu.edu/hypermail/linux/kernel/1606.0/02129.html</a><br>
</p>
</div>
</div>
<div id="outline-container-org23b9d99" class="outline-4">
<h4 id="org23b9d99">WARNING: %s-safe -&gt; %s-unsafe lock order detected</h4>
<div class="outline-text-4" id="text-org23b9d99">
<p>
é”ä¸Šä¸‹æ–‡å®‰å…¨æ€§æ£€æŸ¥<br>
WARNING: HARDIRQ-safe -&gt; HARDIRQ-unsafe lock order detected<br>
<a href="https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg2299913.html">https://www.mail-archive.com/linux-kernel@vger.kernel.org/msg2299913.html</a><br>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc113206" class="outline-2">
<h2 id="orgc113206">å®ç°åŸç†</h2>
<div class="outline-text-2" id="text-orgc113206">
</div>
<div id="outline-container-org1f258a1" class="outline-3">
<h3 id="org1f258a1">å°†é”æŠ½è±¡æˆlock classï¼Œå¹¶ä¸”åœ¨å…¶ä¸­è®°å½•å„ç§äº‹ä»¶</h3>
<div class="outline-text-3" id="text-org1f258a1">
<ol class="org-ol">
<li><p>
é€šè¿‡å®šä¹‰staticçš„ lock_class_keyæ¥è®°å½•æ¯ä¸ªkey<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_SPINLOCK</code>
<code><span class="org-keyword">extern</span> <span class="org-type">void</span> <span class="org-function-name">__raw_spin_lock_init</span>(<span class="org-type">raw_spinlock_t</span> *<span class="org-variable-name">lock</span>, <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>,</code>
<code>                <span class="org-keyword">struct</span> <span class="org-type">lock_class_key</span> *<span class="org-variable-name">key</span>, <span class="org-type">short</span> <span class="org-variable-name">inner</span>);</code>
<code></code>
<code><span class="org-preprocessor"># define</span> <span class="org-function-name">raw_spin_lock_init</span>(<span class="org-variable-name">lock</span>)                                       \</code>
<code>    <span class="org-keyword">do</span> {                                                                \</code>
<code>        <span class="org-keyword">static</span> <span class="org-keyword">struct</span> <span class="org-type">lock_class_key</span> <span class="org-variable-name">__key</span>;                     \</code>
<code>                                    \</code>
<code>        __raw_spin_lock_init((lock), #lock, &amp;__key, LD_WAIT_SPIN); \</code>
<code>    } <span class="org-keyword">while</span> (0)</code>
<code></code>
<code><span class="org-preprocessor">#else</span></code>
</pre>
</div>
<p>
åœ¨é”åˆå§‹åŒ–æ—¶ï¼Œå°†å…·ä½“çš„keyå’Œclassè”ç³»åœ¨ä¸€èµ· ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä»£ç ä¸­åŒä¸€ä¸ªåˆå§‹åŒ–ä½å€å…·æœ‰ç›¸åŒçš„classï¼‰<br>
</p></li>

<li>éƒ¨åˆ†çš„åŒç±»å‹é”å¯¹è±¡åœ¨ä»£ç çš„ä¸åŒçš„ä½å€åˆå§‹åŒ–ï¼Œå¯ä»¥è‡ªå®šä¹‰key classæ¥è®¾ç½®åŒæ ·çš„class.<br>
lockdep_set_class* APIå¯ä»¥ç”¨æ¥å®ç°è¿™ä¸ªåŠŸèƒ½<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/irq/irqdesc.c#L407">kernel source irq_desc.lock keyclass</a><br></li>

<li>åœ¨ç›¸åŒä»£ç ä½å€åˆå§‹åŒ–çš„key classä¹Ÿå¯ä»¥å…·å¤‡ä¸åŒçš„subclass<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/drivers/tty/pty.c#L394">kernel source for tty_struct-&gt;termios_rwsem</a><br>
<a href="https://github.com/torvalds/linux/commit/d2b6f44779d3be22d32a5697bd30b59367fd2b33">https://github.com/torvalds/linux/commit/d2b6f44779d3be22d32a5697bd30b59367fd2b33</a><br>
ä¸åŒçš„subclassä¹Ÿä¼šè¢«lockdepå½“ä½œæ˜¯ä¸åŒçš„é”ï¼Œsubclasså¯ä»¥æ”¯æŒåŠ¨æ€è¿›è¡Œæ·»åŠ ï¼Œè€Œkeyclassåªèƒ½æ˜¯ç¼–è¯‘çš„æ—¶å€™å°±ç¡®å®šå¥½ã€‚æ— æ³•åŠ¨æ€æ ¹æ®ç¤ºä¾‹åŒ–å¯¹æ€§çš„ä¸ªæ•°åšæ‰©å±•<br></li>

<li>é€šè¿‡ä»¥ä¸Šçš„æ–¹æ³•ï¼Œlockdepå°†å†…æ ¸ä¸­çš„é”æŒ‰ç…§classçš„ç±»åˆ«è¿›è¡Œæ£€æµ‹<br>
lockdepè®¤ä¸ºåŒclassçš„é”åœ¨é€»è¾‘ä¸Šæ˜¯åŒä¸€ç§é”ï¼Œå…·æœ‰ç›¸åŒçš„å¤„ç†æ–¹æ³•. æ¯ä¸ªclasså¯èƒ½åŒ…å«å¾ˆå¤šä¸ªä¸åŒçš„é”å¯¹è±¡ï¼Œlockdepé€šè¿‡è®°å½•è¿™äº›é”ä½¿ç”¨æ—¶è¿›å‡ºçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»¥åŠè¿›å‡ºè¿›ç¨‹å·²ç»æŒæœ‰çš„é”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒæ¥å‘ç°é—®é¢˜<br></li>
</ol>
</div>
</div>
<div id="outline-container-org8732413" class="outline-3">
<h3 id="org8732413">é”çŠ¶æ€</h3>
<div class="outline-text-3" id="text-org8732413">
<p>
åœ¨å†…æ ¸ä¸­ï¼Œå„ç§é”å…±ç”¨9ç±»çŠ¶æ€<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>===  ===================================================</code>
<code><span class="org-string">'.'</span>  acquired while irqs disabled and not<span class="org-keyword"> in</span> irq context</code>
<code><span class="org-string">'-'</span>  acquired<span class="org-keyword"> in</span> irq context</code>
<code><span class="org-string">'+'</span>  acquired with irqs enabled</code>
<code><span class="org-string">'?'</span>  acquired<span class="org-keyword"> in</span> irq context with irqs enabled.</code>
<code>===  ===================================================</code>
<code></code>
<code>The bits are illustrated with an example::</code>
<code>                     <span class="org-string">\-</span>---&gt; hardirq</code>
<code>                     | <span class="org-string">\-</span>--&gt; hardirq readlock</code>
<code>                     || <span class="org-string">\-</span>-&gt; softirq</code>
<code>                     ||| <span class="org-string">\-</span>&gt; softirq readlock</code>
<code>                     ||||</code>
<code>(&amp;sio_locks[i].lock){-.-.}, at: [&lt;c02867fd&gt;] mutex_lock+0x21/0x24</code>
<code>                     ||||</code>
<code>                     ||| <span class="org-string">\-</span>&gt; softirq disabled and not<span class="org-keyword"> in</span> softirq context</code>
<code>                     || <span class="org-string">\-</span>-&gt; acquired<span class="org-keyword"> in</span> softirq context</code>
<code>                     | <span class="org-string">\-</span>--&gt; hardirq disabled and not<span class="org-keyword"> in</span> hardirq context</code>
<code>                     <span class="org-string">\-</span>---&gt; acquired<span class="org-keyword"> in</span> hardirq context</code>
</pre>
</div>


<p>
ä¸Šé¢çš„æ–‡æ¡£å·²ç»è§£å†³çš„å¾ˆæ¸…æ¥šäº†<br>
ä»å†…æ ¸çš„ä½¿ç”¨ä¸­ï¼Œç”±äºä¸åŒä¸Šä¸‹æ–‡é—´å…·æœ‰å›ºå®šçš„æŠ¢å è§„åˆ™ï¼Œå¯ä»¥é”æ·»åŠ ä¸Šsoftirq/hardirq-safe/unsafeçš„æ ‡ç­¾<br>
æ ¹æ®ä¸Šé¢çš„9ç§çŠ¶æ€ï¼Œlockdepé€šè¿‡è®°å½•é”åœ¨è·å–æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œä»¥åŠä¸­æ–­å¼€å¯çŠ¶æ€ï¼Œæ¥æœºç‡é”çš„çŠ¶æ€ï¼Œæ¯æŠŠé”å¯ä»¥åœ¨ä¸åŒsafe/unsafeçš„æ ‡ç­¾ä¸­è½¬åŒ–<br>
<img src="/assets/.lockdep-struct-3.png"><br>
softirq/hardirqçš„safeçŠ¶æ€å¯ä»¥ç”¨æ¥åˆ¤æ–­æŒé”æ˜¯å¦ä¼šæœ‰é£é™©ï¼Œå…¥ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²ç®­å¤´æ‰€è¡¨ç¤ºçš„é”ä¾èµ–é¡ºåºæ˜¯æœ‰æ­»é”é£é™©çš„<br>
<img src="/assets/.lockdep-struct-4.png"><br>
</p>
</div>
</div>

<div id="outline-container-org393a532" class="outline-3">
<h3 id="org393a532">åœ¨å½“å‰çš„task structä¸­è®°å½•ç›¸å…³çš„åŠ é”ä¿¡æ¯</h3>
<div class="outline-text-3" id="text-org393a532">
<p>
åœ¨è®°å½•æ—¶é€šè¿‡lock_classæ¥è¿›è¡Œï¼Œæ‰€ä»¥å³ä½¿æ²¡æœ‰å‘ç”Ÿæ­»é”ï¼Œç³»ç»Ÿä¹Ÿå¯ä»¥ä¸ŠæŠ¥å…·ä½“çš„é”™è¯¯ä¿¡æ¯<br>
</p>
</div>

<div id="outline-container-org29d3a0c" class="outline-4">
<h4 id="org29d3a0c">RSLS Call Trace</h4>
<div class="outline-text-4" id="text-org29d3a0c">
<p>
ä¸‹é¢æ˜¯raw spinlockæŒé”æ—¶çš„lockdepç›¸å…³çš„æ“ä½œé€»è¾‘<br>
</p>
<p class="verse">
- <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/include/linux/spinlock_api_smp.h#L104">__raw_spin_lock_irqsave</a><br>
&#xa0;&#xa0;-  <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/include/linux/spinlock_api_smp.h#L110">spin_acquire</a><br>
&#xa0;&#xa0;&#xa0;- if !try_lock success<br>
&#xa0;&#xa0;&#xa0;&#xa0;-  <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/include/linux/lockdep.h#L453">lock_contended</a><br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;- lock<br>
&#xa0;&#xa0;&#xa0;- <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/include/linux/lockdep.h#L456">lock_acquired</a><br>
</p>
</div>
</div>

<div id="outline-container-org5a475b1" class="outline-4">
<h4 id="org5a475b1">Mutex lock</h4>
<div class="outline-text-4" id="text-org5a475b1">
<p>
ä¸‹é¢æ˜¯mutex_lockæŒé”æ—¶çš„lockdepç›¸å…³çš„æ“ä½œé€»è¾‘<br>
</p>

<p class="verse">
- <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/mutex.c#L730">__mutex_lock</a><br>
&#xa0;- <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/mutex.c#L566">__mutex_lock_common</a><br>
&#xa0;&#xa0;-  <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/mutex.c#L600">mutex_acquire_nest</a><br>
&#xa0;&#xa0;&#xa0;-  if try_lock success<br>
&#xa0;&#xa0;&#xa0;&#xa0;-  <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/mutex.c#L605">lock_acquired</a><br>
&#xa0;&#xa0;&#xa0;&#xa0;-  return<br>
&#xa0;&#xa0;&#xa0;- else<br>
&#xa0;&#xa0;&#xa0;&#xa0;- <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/mutex.c#L628">lock_contended</a><br>
&#xa0;&#xa0;&#xa0;&#xa0;- wait until lock acquired<br>
&#xa0;&#xa0;- <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/mutex.c#L709">lock_acquired</a><br>
</p>

<p>
ä»ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºä¸åŒçš„é”ï¼Œlockdepå¤„ç†é€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œä¸»è¦ç”¨åˆ°3ä¸ªapiå‡½æ•° lock_acquire, lock_contended, lock_acquired.<br>
</p>
</div>
</div>
</div>

<div id="outline-container-org82bcfee" class="outline-3">
<h3 id="org82bcfee">åœ¨è¿›è¡Œé”æ“ä½œæ—¶ï¼Œå¯¹æ¯”ä¹‹å‰å·²ç»æŒæœ‰çš„é”ä¿¡æ¯ï¼Œé€šè¿‡è§„åˆ™åˆ¤æ–­å‡ºå…·ä½“çš„å¼‚å¸¸</h3>
<div class="outline-text-3" id="text-org82bcfee">
</div>
<div id="outline-container-org787b49e" class="outline-4">
<h4 id="org787b49e">ä¸Šä¸‹æ–‡åˆ¤æ–­</h4>
<div class="outline-text-4" id="text-org787b49e">
<p>
è¿™ä¸ªå¾ˆç®€å•ï¼Œé€šè¿‡åˆ¤æ–­æ¯ä¸ªé”æ‰€å¤„äºçš„ä¸Šä¸‹æ–‡æ¥è¿›è¡Œåˆ¤æ–­<br>
ä¸‹é¢æ˜¯linuxå¯¹äºä¸Šä¸‹æ–‡ç±»å‹çš„å®šä¹‰, ä»£ç æäº¤å¦‚ä¸‹ <a href="https://lwn.net/Articles/579849/">https://lwn.net/Articles/579849/</a><br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/include/linux/lockdep_types.h#L17">lockdep_wait_type</a><br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-keyword">enum</span> <span class="org-type">lockdep_wait_type</span> {</code>
<code>    <span class="org-variable-name">LD_WAIT_INV</span> = 0,    <span class="org-comment-delimiter">/* </span><span class="org-comment">not checked, catch all</span><span class="org-comment-delimiter"> */</span></code>
<code></code>
<code>    <span class="org-variable-name">LD_WAIT_FREE</span>,               <span class="org-comment-delimiter">/* </span><span class="org-comment">wait free, rcu etc..</span><span class="org-comment-delimiter"> */</span></code>
<code>    <span class="org-variable-name">LD_WAIT_SPIN</span>,               <span class="org-comment-delimiter">/* </span><span class="org-comment">spin loops, raw_spinlock_t etc..</span><span class="org-comment-delimiter"> */</span></code>
<code></code>
<code><span class="org-preprocessor">#ifdef</span> CONFIG_PROVE_RAW_LOCK_NESTING</code>
<code>    <span class="org-variable-name">LD_WAIT_CONFIG</span>,             <span class="org-comment-delimiter">/* </span><span class="org-comment">preemptible in PREEMPT_RT, spinlock_t etc..</span><span class="org-comment-delimiter"> */</span></code>
<code><span class="org-preprocessor">#else</span></code>
<code>    <span class="org-variable-name">LD_WAIT_CONFIG</span> = LD_WAIT_SPIN,</code>
<code><span class="org-preprocessor">#endif</span></code>
<code>    <span class="org-variable-name">LD_WAIT_SLEEP</span>,              <span class="org-comment-delimiter">/* </span><span class="org-comment">sleeping locks, mutex_t etc..</span><span class="org-comment-delimiter"> */</span></code>
<code></code>
<code>    <span class="org-variable-name">LD_WAIT_MAX</span>,                <span class="org-comment-delimiter">/* </span><span class="org-comment">must be last</span><span class="org-comment-delimiter"> */</span></code>
<code>};</code>
</pre>
</div>
<p>
ç³»ç»Ÿåœ¨è¿è¡Œæ—¶ä¼šæ£€æŸ¥æ‰€æœ‰å·²ç»è·å–åˆ°çš„é”ï¼Œå¹¶ä¸”ä»¥æ­¤ä¸ºä¾æ®æ£€æŸ¥æŒé”çš„ä¸Šä¸‹æ–‡æ˜¯å¦æ­£ç¡®,ä»£ç å¯ä»¥å‚è€ƒ <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/lockdep.c#L4698">check_wait_context</a><br>
</p>

<ul class="org-ul">
<li>wait_type_outer<br>
å¯ä»¥æŒæœ‰æ­¤é”çš„ä¸Šä¸‹æ–‡ç±»å‹, wait_type &gt;= wait_type_outeræ—¢å¯è®¤ä¸ºæ˜¯æ­£ç¡®çš„æŒæŒé”é¡ºåº<br>
LD_WAIT_SLEEP è¡¨ç¤ºå¯ä»¥åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­æŒæœ‰è¯¥é”<br>
LD_WAIT_SPIN è¡¨ç¤ºå¯ä»¥åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä»¥åŠåŸå­ä¸Šä¸‹æ–‡ä¸­æŒæœ‰è¯¥é”<br>
LD_WAIT_INV è¡¨ç¤ºouterå’Œinnerä¿æŒä¸€è‡´ (å¤§éƒ¨ä»½é”éƒ½æ˜¯è¿™æ ·çš„è®¾ç½®)<br></li>

<li><p>
wait_type_inner<br>
æŒæœ‰è¯¥é”ä¹‹åè¿›å…¥çš„ä¸Šä¸‹æ–‡ç±»å‹<br>
eg:<br>
  Mutex lockçš„wait_type_innerä¸ºLD_WAIT_SLEEP, è¡¨ç¤ºæŒæœ‰è¯¥é”ä¹‹åç³»ç»Ÿå¯ä»¥ç¡çœ ã€‚<br>
  raw_spinlockçš„wait_type_innerä¸ºLD_WAIT_SPIN, è¡¨ç¤ºæŒæœ‰è¯¥é”ä¹‹åç³»ç»Ÿå°±ä¼šè¿›å…¥ä¸å¯æŠ¢å çš„åŸå­ä¸Šä¸‹æ–‡<br>
</p>

<p>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/include/linux/mutex.h#L24">MUTEX LOCK wait_type_inner</a><br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-preprocessor">#ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</code>
<code><span class="org-preprocessor"># define</span> <span class="org-function-name">__DEP_MAP_MUTEX_INITIALIZER</span>(<span class="org-variable-name">lockname</span>)          \</code>
<code>    , .dep_map = {                                      \</code>
<code>        .name = #lockname,                      \</code>
<code>        .wait_type_inner = LD_WAIT_SLEEP,       \</code>
<code>    }</code>
<code><span class="org-preprocessor">#else</span></code>
<code><span class="org-preprocessor"># define</span> <span class="org-function-name">__DEP_MAP_MUTEX_INITIALIZER</span>(<span class="org-variable-name">lockname</span>)</code>
<code><span class="org-preprocessor">#endif</span></code>
</pre>
</div></li>
</ul>

<p>
ç³»ç»Ÿæ ¹æ®ç€ä¸ªç±»å‹ï¼Œå°±å¯ä»¥è·Ÿè¸ªï¼Œè®°å½•ç›®å‰ç³»ç»Ÿæ‰€æŒæœ‰çš„é”çš„ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œå¹¶ä¸”äºå³å°†æŒæœ‰çš„é”inner waittypeåšæ¯”è¾ƒï¼Œæ£€æµ‹å‡ºç›¸åº”çš„é—®é¢˜<br>
</p>
</div>
</div>

<div id="outline-container-org9d4853a" class="outline-4">
<h4 id="org9d4853a">é”ä¾èµ–</h4>
<div class="outline-text-4" id="text-org9d4853a">
<p>
æ­¤éƒ¨ä»½æ˜¯lockdepè®¾è®¡çš„æ ¸å¿ƒï¼Œæ­»é”æ£€æµ‹çš„æ–¹æ³•ï¼Œä»¥åŠå®šç†å°†ä»æ­¤å¤„ç»™å‡º<br>
</p>
</div>
<ul class="org-ul">
<li><a id="org03b889a"></a>lock type<br>
<div class="outline-text-5" id="text-org03b889a">
<p>
å› ä¸ºä¸åŒæ€§è´¨çš„é”é˜»å¡çš„æ¡ä»¶ä¸åŒï¼Œæ‰€ä»¥å†…æ ¸æ ¹æ®é˜»å¡äº§ç”Ÿæ¡ä»¶ï¼Œç»™å†…æ ¸ä¸­çš„é”åˆ†ä¸ºäº†ä»¥ä¸‹çš„å‡ å¤§ç±».lockdepå°†é”åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹<br>
</p>
<dl class="org-dl">
<dt>writers</dt><dd>exclusive lockers, like spin_lock() or write_lock()<br>
æ­¤ç§é”æ˜¯å†…æ ¸ç¼–ç¨‹ä¸­æœ€å¸¸ç”¨çš„ç±»å‹ï¼Œå®Œå…¨ç‹¬å çš„é”ï¼ŒåŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªownerï¼Œæœ€å®¹æ˜“åˆ†æ<br></dd>

<dt>non-recursive readers</dt><dd>shared lockers, like down_read()<br>
æ­¤ç§é”æ˜¯æ™®é€šçš„è¯»é”ï¼Œå› ä¸ºè¯»é”å¯ä»¥åŒæ—¶è¢«è¯»ç«¯é”æŒæœ‰ï¼Œå› æ­¤å…è®¸å¤šçº¿ç¨‹åŒæ—¶æŒæœ‰ï¼Œæœ‰ç›¸äº’ä¾èµ–çš„æŒæœ‰å…³ç³»ä¹Ÿä¸ä¸€å®šä¼šæ­»é”<br></dd>

<dt>recursive readers</dt><dd><p>
recursive shared lockers, like rcu_read_lock()<br>
è¿™ç§é”æ˜¯æ›´ä¸æ˜“æ­»é”çš„ç±»å‹ï¼Œç”±äºæ”¯æŒé‡å…¥ï¼Œå…·æœ‰æ›´ä½³å®½æ¾ä¸ªçš„æ­»é”æ¡ä»¶<br>
</p>

<p>
å¹¶ä¸”ä¸ºäº†æ–¹ä¾¿æ–‡ç« ç¼–å†™ï¼Œåšå‡ºç¼©å†™å¦‚ä¸‹<br>
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">abbr</td>
<td class="org-left">type</td>
</tr>

<tr>
<td class="org-left">W/E</td>
<td class="org-left">exclusive lockers</td>
</tr>

<tr>
<td class="org-left">r</td>
<td class="org-left">non-recursive readers</td>
</tr>

<tr>
<td class="org-left">R</td>
<td class="org-left">recursive readers</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">all readers (non-recursive + recursive), as both are shared lockers.</td>
</tr>

<tr>
<td class="org-left">N</td>
<td class="org-left">writers and non-recursive readers, as both are not recursive.</td>
</tr>
</tbody>
</table></dd>
</dl>
</div>
</li>

<li><a id="orgc59bb69"></a>non-recursive readersçš„æ­»é”æƒ…å½¢<br>
<div class="outline-text-5" id="text-orgc59bb69">
<p>
ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œé€šè¿‡ä¸‹é¢çš„ä¾‹å­ï¼Œå¯ä»¥çœ‹å‡ºé‡å…¥å±æ€§å¯¹æ­»é”çš„äº§ç”Ÿçš„å½±å“<br>
è¿™ä¸ªä¾‹å­å±•ç¤ºäº†non-recursive readersè¢«writerçš„waiteré˜»å¡å¯¼è‡´å‡ºç°deadlockçš„æƒ…å½¢<br>
è™½ç„¶read_lockå¯ä»¥åŒæ—¶è¢«å¤šä¸ªcpu/å•ä¸ªcpuæŒæœ‰ï¼Œä½†æ˜¯å¦‚æœæœ‰çº¿ç¨‹åœ¨ç­‰å¾…writeé”, ç³»ç»Ÿä¾æ—§ä¼šå› æ­¤è€Œé˜»å¡<br>
</p>
<p class="verse">
TASK A:             TASK B:<br>
<br>
read_lock(X);<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;write_lock(X);<br>
read_lock_2(X);<br>
</p>

<p>
ç®€è€Œè¨€ä¹‹å°±æ˜¯é”Xåœ¨ç¬¬äºŒæ¬¡è·å–è¯»é”æ—¶ï¼Œä¼šå› ä¸ºå¦ä¸€ä¸ªtaskåœ¨ç­‰å¾…è·å–å†™é”è€Œå¯¼è‡´æ­»<br>
é”ã€‚è¿™æ˜¯å› ä¸ºå†™é”ä¼šblockä¹‹åå°è¯•è·å–è¯»é”çš„æ“ä½œï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªblockæ“ä½œï¼Œç³»ç»Ÿ<br>
å¯èƒ½ä¼šå› ä¸ºä¸€è‡´æœ‰è¿›ç¨‹ä¸æ–­è·å–è¯»é”ï¼Œè€Œå¯¼è‡´ï¼Œå†™å…¥çš„è¿›ç¨‹æ— æ³•æ‹¿åˆ°é”ï¼Œé€ æˆé¥¿æ­».<br>
</p>

<p>
å…·ä½“å¯ä»¥å‚è€ƒ <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/qrwlock.c#L40">read_lock will wait for write waiter</a><br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><code>void queued_read_lock_slowpath(struct qrwlock *lock)</code>
<code>{</code>
<code>    /*</code>
<code>     * Readers come here when they cannot get the lock without waiting</code>
<code>     */</code>
<code>    <span class="org-keyword">if</span> (unlikely(in_interrupt())) {</code>
<code>        /*</code>
<code>         * Readers<span class="org-keyword"> in</span> interrupt context will get the lock immediately</code>
<code>         * if the writer is just waiting (not holding the lock yet),</code>
<code>         * so spin with ACQUIRE semantics until the lock is available</code>
<code>         * without waiting<span class="org-keyword"> in</span> the queue.</code>
<code>         */</code>
<code>        atomic_cond_read_acquire(&amp;lock-&gt;cnts, !(VAL &amp; _QW_LOCKED));</code>
<code>        <span class="org-keyword">return</span>;</code>
<code>    }</code>
<code>    atomic_sub(_QR_BIAS, &amp;lock-&gt;cnts);</code>
<code></code>
<code>    /*</code>
<code>     * Put the reader into the wait queue</code>
<code>     */</code>
<code>    arch_spin_lock(&amp;lock-&gt;wait_lock);</code>
<code>    atomic_add(_QR_BIAS, &amp;lock-&gt;cnts);</code>
<code></code>
<code>    /*</code>
<code>     * The ACQUIRE semantics of the following spinning code ensure</code>
<code>     * that accesses can<span class="org-string">'t leak upwards out of our subsequent critical</span></code>
<code><span class="org-string">     * section in the case that the lock is currently held for write.</span></code>
<code><span class="org-string">     */</span></code>
<code><span class="org-string">    atomic_cond_read_acquire(&amp;lock-&gt;cnts, !(VAL &amp; _QW_LOCKED));</span></code>
<code></code>
<code><span class="org-string">    /*</span></code>
<code><span class="org-string">     * Signal the next one in queue to become queue head</span></code>
<code><span class="org-string">     */</span></code>
<code><span class="org-string">    arch_spin_unlock(&amp;lock-&gt;wait_lock);</span></code>
<code><span class="org-string">}</span></code>
<code><span class="org-string">EXPORT_SYMBOL(queued_read_lock_slowpath);</span></code>
</pre>
</div>
<p>
å¦‚ä¸Šé¢çš„å†…æ ¸å®ç°ï¼Œè¯»é”ä¼šblockåœ¨arch_spin_lock(&amp;lock-&gt;wait_lock);æˆ–è€… atomic_cond_read_acquire(&amp;lock-&gt;cnts, !(VAL &amp; _QW_LOCKED));ï¼Œåœ¨æ­¤å¤„ç­‰å¾…å†™é”ç¦»å¼€ä¸´ç•ŒåŒºï¼Œå•æ­¤æ—¶ï¼Œè¯»å†™è¢«Task Aæ‹¿åˆ°ï¼Œå¯¼è‡´æ­»é”.<br>
</p>
</div>
</li>

<li><a id="org63c1429"></a>æ ¹æ®é”ç±»å‹ï¼Œæ¥è§‚å¯Ÿæ­»é”çš„æ¡ä»¶å…³ç³»<br>
<div class="outline-text-5" id="text-org63c1429">
<p>
é’ˆå¯¹è¿™ä¸‰ç§é”ç±»å‹ï¼Œå¯ä»¥æœ‰å¦‚ä¸‹å‡ ç§çš„é˜»å¡å…³ç³»çŸ©é˜µ. Yè¡¨ç¤ºè¡Œæ ‡ä¼šé˜»å¡åˆ—æ ‡, Nè¡¨ç¤ºä¸ä¼šäº§ç”Ÿé˜»å¡çš„é—®é¢˜<br>
<img src="/assets/.lockdep-struct-5.png"><br>
</p>

<p>
ä¸Šé¢åˆ—å‡ºäº†ä¸åŒç±»å‹çš„é”åœ¨ç›¸äº’ä¾èµ–æ—¶æ˜¯å¦ä¼šäº§ç”Ÿblockï¼ŒNè¡¨ç¤ºå®Œå…¨ä¸ä¼šå½¢æˆé˜»å¡ç­‰å¾…<br>
ä¸‹é¢ç®€å•åˆ—ä¸¾ä¸¤ä¸ªä¸ä¼šäº§ç”Ÿé˜»å¡çš„è·¯å¾„<br>
</p>
<ul class="org-ul">
<li>R won't block r. é€’å½’çš„è¯»é”ä¸ä¼šé˜»å¡éé€’å½’çš„è¯»é”<br></li>
<li>R won't block R. é€’å½’çš„è¯»é”ä¸ä¼šç›¸äº’block<br></li>
</ul>
</div>
</li>
<li><a id="orgd4cc054"></a>ä¾èµ–åˆ†æ<br>
<div class="outline-text-5" id="text-orgd4cc054">
<p>
é€šè¿‡ä¸Šé¢çš„è¡¨æ ¼ï¼Œåœ¨æ£€æµ‹æ­»é”æ—¶ï¼Œå…±éœ€è¦æ£€æµ‹9ç§æƒ…å†µ<br>
</p>

<p>
è€ƒè™‘å¦‚ä¸‹çš„ä¾èµ–æƒ…å†µ<br>
L1 -&gt; L2<br>
æˆ‘ä»¬éœ€è¦å…³å¿ƒåœ¨è·å–L1çš„æƒ…å†µä¸‹ï¼Œå†å»è·å–L2ç³»ç»Ÿä¼šä¸ä¼šè¢«block. æ¢å¥è¯è¯´å°±æ˜¯æœ‰æ²¡æœ‰å¯èƒ½å­˜åœ¨L3ï¼ŒL3ä¾èµ–äºL1ï¼Œè€ŒL2ä¾èµ–äºL3.<br>
è¿™æ ·æˆ‘ä»¬åªéœ€è¦æ£€æµ‹ä¸€ä¸‹è·å–L1ä¹‹å‰è·å–è¿‡çš„é”åˆ—è¡¨, ä»¥åŠè·å–L2ä¹‹åè·å–è¿‡çš„é”åˆ—è¡¨ï¼Œå†ç»¼åˆé”çš„ç±»å‹è¿›è¡Œè€ƒè™‘å°±å¯ä»¥æ£€æµ‹å‡ºæ¥æ­»é”ã€‚<br>
</p>

<p>
  ç»¼åˆä¸Šé¢çš„é˜»å¡å…³ç³»å›¾ï¼Œå…·æœ‰å¦‚ä¸‹è§„å¾‹<br>
  <img src="/assets/.lockdep-struct-2.png"><br>
  æ ¹æ®è¿™ä¸ªè§„å¾‹ï¼Œå¯ä»¥æ–¹ä¾¿çš„å°†å…³ç³»ç®€åŒ–ä¸º4ç§ï¼Œè¿™æ ·ï¼Œå°±å¯ä»¥å¤§å¤§é™ä½å¤æ‚åº¦.<br>
lockdepä¼šåŠ¨æ€ç”Ÿæˆä¸€å¼ ä¾èµ–å›¾ï¼Œç³»ç»Ÿå°†å¯¹åº”çš„lockclassæ·»åŠ åˆ°è¿™å¼ å›¾ä¸­ï¼Œé€šè¿‡å¯¹åº”çš„ç®—æ³•ç…§å‡ºç›¸åº”çš„ä¾èµ–å…³ç³».<br>
ä¾èµ–ç±»å‹<br>
é’ˆå¯¹ä¸åŒçš„é”ç±»å‹ï¼Œå¯ä»¥æŠ½è±¡å‡ºä»¥ä¸‹å››ä¸­ä¾èµ–å…³ç³», æŒ‰ç…§ä¸Šé¢çš„é˜»å¡å…³ç³»å›¾ã€‚<br>
</p>
<ul class="org-ul">
<li>-(ER)-&gt;<br>
exclusive writer to recursive reader dependency<br></li>
<li>-(EN)-&gt;<br>
exclusive writer to non-recursive locker dependency<br></li>
<li>-(SR)-&gt;<br>
shared reader to recursive reader dependency<br></li>
<li>-(SN)-&gt;<br>
shared reader to non-recursive locker dependency<br></li>
</ul>
</div>
</li>

<li><a id="org259dac5"></a>strong pathå®šä¹‰<br>
<div class="outline-text-5" id="text-org259dac5">
<p>
æ ¹æ®é˜»å¡å›¾ï¼Œå¦‚æœä¸€æ¡ä¾èµ–è·¯å¾„ä¸Šå…¨éƒ¨éƒ½æ˜¯å¯é˜»å¡çš„ç±»å‹ï¼Œåˆ™å®šä¹‰ä¸ºstrong path<br>
ç®€å•æ¥è¯´å°±æ˜¯ä¸ç»è¿‡-(<b>R)-&gt; -(S</b>)-&gt;è·¯å¾„çš„å®šä¹‰ä¸ºstrong path. å› ä¸ºç»è¿‡è¿™ç§è·¯å¾„çš„éƒ½æœ‰éblockçš„é”å…³ç³»ï¼Œlockdepè®¤ä¸ºä¸ä¼šé€ æˆæ­»é”.<br>
ä¸‹é¢æ˜¯å†…æ ¸æ–‡æ¡£ä¸­å¯¹strong pathå®šä¹‰çš„åŸæ–‡<br>
</p>
<blockquote>
<p>
A "path" is a series of conjunct dependency edges in the graph. And we define a<br>
"strong" path, which indicates the strong dependency throughout each dependency<br>
in the path, as the path that doesn't have two conjunct edges (dependencies) as<br>
-(xR)-&gt; and -(Sx)-&gt;. In other words, a "strong" path is a path from a lock<br>
walking to another through the lock dependencies, and if X -&gt; Y -&gt; Z is in the<br>
path (where X, Y, Z are locks), and the walk from X to Y is through a -(SR)-&gt; or<br>
-(ER)-&gt; dependency, the walk from Y to Z must not be through a -(SN)-&gt; or<br>
-(SR)-&gt; dependency.<br>
</p>
</blockquote>
</div>
</li>

<li><a id="orgb3bbb34"></a>æ­»é”å…³ç³»è¯æ˜<br>
<div class="outline-text-5" id="text-orgb3bbb34">
<ul class="org-ul">
<li>å®šç†1<br>
å¦‚æœä¸€æ¡è·¯å¾„ä¸Šæœ‰é—­ç¯çš„strong pathï¼Œé‚£ä¹ˆè¿™ä¸ªå°±ä¼šæ„æˆæ­»é”.<br></li>
<li><p>
å®šç†2<br>
å¦‚æœä¸€æ¡è·¯å¾„ä¸Šæ²¡æœ‰é—­ç¯çš„strong pathï¼Œé‚£ä¹ˆä¸€å®šä¸ä¼šæ„æˆæ­»é”.<br>
</p>

<p>
åœ¨è¿™ä¸¤ä¸ªå®šç†çš„å‰æä¸‹ï¼Œå¯ä»¥å¾ˆå®¹æ˜“å¾—å‡ºï¼Œé—­ç¯çš„strong pathæ˜¯æ­»é”çš„å……åˆ†å¿…è¦æ¡ä»¶. ä¸Šé¢ä¸¤æ¡å®šç†çš„è¯æ˜åœ¨å†…æ ¸æ–‡æ¡£ä¸­æœ‰è¯¦ç»†çš„æè¿°ã€‚åœ¨æ­¤ä¸å†èµ˜è¿°.<br>
</p>

<p>
æ‰€ä»¥åœ¨lockdepçš„æ£€æµ‹ä¸­ï¼Œåªéœ€è¦æ‰¾å‡ºæŒé”è·¯å¾„ä¸Šæ˜¯å¦æœ‰é—­ç¯çš„strong pathå°±å¯ä»¥äº†.<br>
</p></li>
</ul>
</div>
</li>
<li><a id="org9d967db"></a>ä»£ç å®ç°<br>
<div class="outline-text-5" id="text-org9d967db">
<p>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/lockdep.c#L3064">source to call check_noncircular</a><br>
é€šè¿‡ä»£ç æ³¨é‡Šå¯ä»¥çœ‹åˆ°ï¼Œå†…æ ¸é€šè¿‡å¹¿åº¦ä¼˜å…ˆçš„éå†æ–¹å¼ï¼Œå¯»æ‰¾æ˜¯å¦ä¼šå½¢æˆä¾èµ–ç¯è·¯, åœ¨æ‰¾åˆ°å¯¹åº”çš„ç¯è·¯ä¹‹åï¼Œå†ç»è¿‡å¯¹é—­ç¯strong pathçš„åˆ¤æ–­æ¥éªŒè¯æ˜¯å¦å­˜åœ¨æ­»é”.<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/lockdep.c#L1977">æ£€æµ‹æ˜¯å¦å­˜åœ¨é—­ç¯çš„strong path</a><br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-comment-delimiter">/*</span></code>
<code><span class="org-comment"> * We are about to add B -&gt; A into the dependency graph, and in __bfs() a</span></code>
<code><span class="org-comment"> * strong dependency path A -&gt; .. -&gt; B is found: hlock_class equals</span></code>
<code><span class="org-comment"> * entry-&gt;class.</span></code>
<code><span class="org-comment"> *</span></code>
<code><span class="org-comment"> * We will have a deadlock case (conflict) if A -&gt; .. -&gt; B -&gt; A is a strong</span></code>
<code><span class="org-comment"> * dependency cycle, that means:</span></code>
<code><span class="org-comment"> *</span></code>
<code><span class="org-comment"> * Either</span></code>
<code><span class="org-comment"> *</span></code>
<code><span class="org-comment"> *     a) B -&gt; A is -(E*)-&gt;</span></code>
<code><span class="org-comment"> *</span></code>
<code><span class="org-comment"> * or</span></code>
<code><span class="org-comment"> *</span></code>
<code><span class="org-comment"> *     b) A -&gt; .. -&gt; B is -(*N)-&gt; (i.e. A -&gt; .. -(*N)-&gt; B)</span></code>
<code><span class="org-comment"> *</span></code>
<code><span class="org-comment"> * as then we don't have -(*R)-&gt; -(S*)-&gt; in the cycle.</span></code>
<code><span class="org-comment-delimiter"> */</span></code>
<code><span class="org-keyword">static</span> <span class="org-keyword">inline</span> <span class="org-type">bool</span> <span class="org-function-name">hlock_conflict</span>(<span class="org-keyword">struct</span> <span class="org-type">lock_list</span> *<span class="org-variable-name">entry</span>, <span class="org-type">void</span> *<span class="org-variable-name">data</span>)</code>
<code>{</code>
<code>    <span class="org-keyword">struct</span> <span class="org-type">held_lock</span> *<span class="org-variable-name">hlock</span> = (<span class="org-keyword">struct</span> <span class="org-type">held_lock</span> *)data;</code>
<code></code>
<code>    <span class="org-keyword">return</span> hlock_class(hlock) == entry-&gt;class &amp;&amp; <span class="org-comment-delimiter">/* </span><span class="org-comment">Found A -&gt; .. -&gt; B</span><span class="org-comment-delimiter"> */</span></code>
<code>        (hlock-&gt;read == 0 || <span class="org-comment-delimiter">/* </span><span class="org-comment">B -&gt; A is -(E*)-&gt;</span><span class="org-comment-delimiter"> */</span></code>
<code>            <span class="org-negation-char">!</span>entry-&gt;only_xr); <span class="org-comment-delimiter">/* </span><span class="org-comment">A -&gt; .. -&gt; B is -(*N)-&gt;</span><span class="org-comment-delimiter"> */</span></code>
<code>}</code>
</pre>
</div>
<p>
å¦‚ä¸Šé¢çš„æ³¨é‡Šï¼Œåˆ¤æ–­å‡ ä¸ªä¸œè¥¿<br>
</p>
<dl class="org-dl">
<dt>hlock_class(hlock) == entry-&gt;class</dt><dd>A -&gt; B è¿™ä¸ªé”å’Œå³å°†è·å–çš„é”å½¢æˆäº†ä¾èµ–å…³ç³»<br>
ä»¥å‰æœ‰ä¾èµ–å…³ç³» A -&gt; B, å†å°è¯•é€šè¿‡B -&gt; Açš„é¡ºåºæ‹¿é”æ˜¯ä¼šé€ æˆè¿™ä¸ªæ¡ä»¶æˆç«‹<br></dd>
<dt>hlock-&gt;read == 0</dt><dd>B -(E*)-&gt; A è¿™ä¸ªæƒ…å†µæ»¡è¶³é—­ç¯strong pathçš„æ¡ä»¶<br></dd>
<dt>!entry-&gt;only_xr</dt><dd>A -&gt; .. -&gt; B is -(*N)-&gt; (i.e. A -&gt; .. -(*N)-&gt; B)<br>
å¦‚æœè¿™å‡ ä¸ªæ¡ä»¶æˆç«‹ï¼Œåˆ™è®¤ä¸ºæ»¡è¶³äº†é—­ç¯strong pathçš„å……è¦æ¡ä»¶.<br></dd>
</dl>
</div>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org5764464" class="outline-2">
<h2 id="org5764464">Debug</h2>
<div class="outline-text-2" id="text-org5764464">
<p>
/proc/lockdep èŠ‚ç‚¹å¯ä»¥æŸ¥çœ‹æ¯ä¸ªlock classçš„è¯¦ç»†debugä¿¡æ¯, ä¸‹é¢åˆ—å‡ºäº†ç¤ºä¾‹ä¿¡æ¯<br>
ä»£ç è¯·å‚è€ƒ <a target="_blank" href="https://github.com/torvalds/linux/blob/09688c0166e76ce2fb85e86b9d99be8b0084cdf9/kernel/locking/lockdep_proc.c#L58">source for /proc/lockdep</a><br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>00000000d17fd3f7 OPS:     137 FD:  308 BD:    9 ++++: &amp;tty-&gt;termios_rwsem</code>
<code>  -&gt; [00000000b06224ce] &amp;lock-&gt;wait_lock</code>
<code>  -&gt; [00000000d4898666] &amp;tty-&gt;write_wait</code>
<code>  -&gt; [000000007b4e289b] &amp;ldata-&gt;output_lock</code>
<code>  -&gt; [000000006ca1fe00] (console_sem).lock</code>
<code>  -&gt; [00000000ee9c07cf] console_lock</code>
<code>  -&gt; [000000002bdc3481] &amp;port-&gt;mutex</code>
<code>  -&gt; [00000000bc14037e] &amp;rq-&gt;lock</code>
<code>  -&gt; [000000004119195b] &amp;tty-&gt;read_wait</code>
<code>  -&gt; [000000004246edf4] &amp;port_lock_key</code>
<code>  -&gt; [00000000b287322b] &amp;mm-&gt;mmap_lock</code>
<code>  -&gt; [0000000007fc188b] &amp;tty-&gt;throttle_mutex</code>
<code>  -&gt; [000000003fde6c48] &amp;p-&gt;pi_lock</code>
</pre>
</div>

<dl class="org-dl">
<dt>00000000d17fd3f7</dt><dd>lockçš„åœ°å€ï¼Œ%pæ˜¾ç¤ºï¼Œè¿™é‡Œç”±äºæ‰“å°çš„ä¿æŠ¤æœºåˆ¶ï¼Œè¢«æ˜¾ç¤ºä¸ºæŒ‡é’ˆçš„hashå€¼<br></dd>
<dt>OPS</dt><dd>137 å°è¯•è·å–é”çš„æ¬¡æ•°, __lock_acquireæ—¶åŠ 1<br></dd>
<dt>FD</dt><dd>308 åœ¨è·å–è¯¥é”ä¹‹å‰è·å–è¿‡çš„é”çš„ä¸ªæ•°<br></dd>
<dt>BD</dt><dd>9 åœ¨è·å–è¯¥é”ä¹‹åè·å–è¿‡çš„é”ä¸ªæ•°<br></dd>
<dt><del>++</del></dt><dd>é”çš„çŠ¶æ€ï¼Œè§ä¸Šæ–‡ä¸­çš„è§£é‡Š<br></dd>
<dt>&amp;tty-&gt;termios_rwsem</dt><dd>é”çš„åå­—<br></dd>
</dl>
</div>
</div>


<div id="outline-container-orgee0fbe5" class="outline-2">
<h2 id="orgee0fbe5">refs</h2>
<div class="outline-text-2" id="text-orgee0fbe5">
<p>
<a href="https://lpc.events/event/2/contributions/74/attachments/67/78/Recursive_read_deadlocks_and_Where_to_find_them.pdf">https://lpc.events/event/2/contributions/74/attachments/67/78/Recursive_read_deadlocks_and_Where_to_find_them.pdf</a><br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>