<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2021-11-23 äºŒ 13:58 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kprobe in linux with aarch64</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Schspa">
<meta name="description" content="kprobe.org"
>
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content">
<h1 class="title">Kprobe in linux with aarch64</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org31fa66a">Overview</a></li>
<li><a href="#org39613fa">basic usage</a>
<ul>
<li><a href="#orgc246cf3">Kernel config</a></li>
<li><a href="#orgc93d11f">kprobe</a></li>
<li><a href="#org13c4f7f">kretprobe</a></li>
</ul>
</li>
<li><a href="#orgc40bb01">kprobe VS kretprobe</a></li>
<li><a href="#org243415f">åº•å±‚å®ç°</a>
<ul>
<li><a href="#orgc1c5776">kprobe</a>
<ul>
<li><a href="#org531aec0">kprobe ç›¸å…³å…³é”®ä»£ç </a></li>
<li><a href="#orgdcd7043">kprobeæ‰§è¡Œæµç¨‹</a></li>
</ul>
</li>
<li><a href="#org8c47146">kretprobe</a>
<ul>
<li><a href="#orgb4310d8">æ³¨å†Œ</a></li>
<li><a href="#org27db33c">pre_handler</a></li>
<li><a href="#org21b64eb">kretprobe_trampoline</a></li>
<li><a href="#org1acd11d">kretprobe summary</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbf6cb9d">Summary</a></li>
</ul>
</div>
</div>

<div id="outline-container-org31fa66a" class="outline-2">
<h2 id="org31fa66a">Overview</h2>
<div class="outline-text-2" id="text-org31fa66a">
<p>
kprobeæ˜¯Linuxå†…æ ¸è‡ªå¸¦çš„è°ƒè¯•æœºåˆ¶ï¼Œå¯ä»¥åœ¨å†…æ ¸çš„å‡½æ•°æ‰§è¡Œå‰åæ·»åŠ é’©å­æ¥æ‰§è¡Œè‡ªå®šä¹‰å‡½æ•°æ¥è¾¾åˆ°ä¿®æ”¹ï¼Œè°ƒè¯•å†…æ ¸çš„ç›®çš„ã€‚<br>
å…·ä½“ç®€ä»‹å¯ä»¥å‚è€ƒå†…æ ¸å®˜æ–¹æ–‡æ¡£ï¼Œè¿™ä¸ªæ–‡æ¡£å·²ç»æœ‰æ¯”è¾ƒè¯¦ç»†çš„è®°å½•.<br>
<a href="https://www.kernel.org/doc/html/latest/trace/kprobes.html">https://www.kernel.org/doc/html/latest/trace/kprobes.html</a><br>
</p>
</div>
</div>

<div id="outline-container-org39613fa" class="outline-2">
<h2 id="org39613fa">basic usage</h2>
<div class="outline-text-2" id="text-org39613fa">
<p>
å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½çš„åŸºç¡€ä½¿ç”¨æ–¹æ³•, å®˜æ–¹çš„ä¸¤ä¸ªä¾‹å­å¾ˆç®€å•<br>
</p>
</div>

<div id="outline-container-orgc246cf3" class="outline-3">
<h3 id="orgc246cf3">Kernel config</h3>
<div class="outline-text-3" id="text-orgc246cf3">
<div class="org-src-container">
<pre class="src src-text"><code>CONFIG_KPROBES=y</code>
<code>CONFIG_SAMPLES=y</code>
<code>CONFIG_SAMPLE_KPROBES=y</code>
<code>CONFIG_CONFIG_SAMPLE_KRETPROBES=y</code>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc93d11f" class="outline-3">
<h3 id="orgc93d11f">kprobe</h3>
<div class="outline-text-3" id="text-orgc93d11f">
<div class="org-src-container">
<pre class="src src-bash"><code>insmod kprobe_example.ko <span style="color: #dcaeea;">symbol</span>=cmdline_proc_open</code>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><code>root@j5dvb:/system/lib/modules/4.14.74# cat /proc/cmdline </code>
<code>[  277.486723] &lt;cmdline_proc_open&gt; pre_handler: p-&gt;<span style="color: #dcaeea;">addr</span> = 0xffffff8008205f10, <span style="color: #dcaeea;">pc</span> = 0xffffff8008205f10, <span style="color: #dcaeea;">pstate</span> = 0x60400149</code>
<code>[  277.488094] &lt;cmdline_proc_open&gt; post_handler: p-&gt;<span style="color: #dcaeea;">addr</span> = 0xffffff8008205f10, <span style="color: #dcaeea;">pstate</span> = 0x60400149</code>
<code><span style="color: #dcaeea;">console</span>=uart8250,mmio32,0x43B90000,921600n8 <span style="color: #dcaeea;">root</span>=/dev/ram0 <span style="color: #dcaeea;">rdinit</span>=/init rw rootwait <span style="color: #dcaeea;">loglevel</span>=14 hobotboot.hardware=j5dvb hobotboot.reason=freboot hobotboot.fchm_fault=0x00000001 hobotboot.fault_timestamp=1637559008 hobotboot.ipaddr=10.106.32.44 hobotboot.slot_suffix=_a hobotboot.bpu_slot_suffix=_-1 hobotboot.mode=normal <span style="color: #dcaeea;">module_blacklist</span>=isp_hw1 <span style="color: #dcaeea;">dyndbg</span>=<span style="color: #98be65;">"module module +p;"</span> </code>
<code>root@j5dvb:/system/lib/modules/4.14.74# </code>
</pre>
</div>

<p>
ä¸Šè¿°å‘½ä»¤å¯ä»¥åœ¨æ‰“å¼€/proc/cmdlineè¿™ä¸ªå‘½ä»¤æ—¶è¿è¡Œè‡ªå·±æ³¨å†Œçš„é’©å­å‡½æ•°<br>
</p>
</div>
</div>

<div id="outline-container-org13c4f7f" class="outline-3">
<h3 id="org13c4f7f">kretprobe</h3>
<div class="outline-text-3" id="text-org13c4f7f">
<div class="org-src-container">
<pre class="src src-bash"><code>insmod kretprobe_example.ko <span style="color: #dcaeea;">func</span>=meminfo_proc_show</code>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><code>root@j5dvb:/system/lib/modules/4.14.74# cat /proc/meminfo</code>
<code>[  561.094342] meminfo_proc_show returned 0 and took 27667 ns to execute</code>
<code>MemTotal:        3771188 kB</code>
<code>MemFree:         2865632 kB</code>
<code>MemAvailable:    3013684 kB</code>
<code>Buffers:            1688 kB</code>
<code>Cached:           156948 kB</code>
<code>SwapCached:            0 kB</code>
<code>Active:           327792 kB</code>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgc40bb01" class="outline-2">
<h2 id="orgc40bb01">kprobe VS kretprobe</h2>
<div class="outline-text-2" id="text-orgc40bb01">
<p>
kretprobeåº•å±‚é€šè¿‡kprobeæ¥å®ç°ï¼Œä¸kprobeçš„ä¸åŒåœ¨äºå®ç°äº†ä¸€ç³»åˆ—è¾…åŠ©çš„å‡½æ•°æ¥æ”¯æŒinstanceçš„å®ä¾‹åŒ–ï¼Œè¿™æ ·åœ¨æ¯æ¬¡è¿è¡Œåˆ°å¯¹åº”çš„å‡½æ•°/åœ°å€æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–°çš„private dataï¼Œä»è€Œå®ç°å¹¶å‘å’Œå¤šå®ä¾‹.<br>
</p>

<p>
ä»å®˜æ–¹çš„ä¾‹å­å°±å¯ä»¥çœ‹åˆ°ï¼Œkretprobeå¯ä»¥å®ç°ç»Ÿè®¡å‡½æ•°è¿è¡Œæ—¶é—´çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç®€å•çš„kprobeå°±ä¸è¡Œï¼ˆå› ä¸ºæ²¡æœ‰private dataï¼‰ã€‚<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #51afef;">typedef</span> <span style="color: #ECBE7B;">int</span> (*<span style="color: #ECBE7B;">kprobe_pre_handler_t</span>) (<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">kprobe</span> *, <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pt_regs</span> *);</code>
<code><span style="color: #51afef;">typedef</span> <span style="color: #ECBE7B;">void</span> (*<span style="color: #ECBE7B;">kprobe_post_handler_t</span>) (<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">kprobe</span> *, <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pt_regs</span> *,</code>
<code>                <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> <span style="color: #dcaeea;">flags</span>);</code>
<code><span style="color: #51afef;">typedef</span> <span style="color: #ECBE7B;">int</span> (*<span style="color: #ECBE7B;">kretprobe_handler_t</span>) (<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">kretprobe_instance</span> *,</code>
<code>                <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pt_regs</span> *);</code>
</pre>
</div>
<p>
kprobeçš„å›è°ƒä¸­ï¼Œkprobeæ˜¯å…¨å±€å…±äº«çš„ï¼Œæ‰€ä»¥æ²¡æœ‰ç®€å•çš„åŠæ³•å»è¿½è¸ªæ¯æ¬¡çš„å‡½æ•°è°ƒç”¨ã€‚è€Œkretprobeçš„å›è°ƒä¼šæœ‰instanceçš„æ¦‚å¿µï¼Œå¹¶ä¸”å¯ä»¥å¯ä»¥æºå¸¦privateåœ¨kretprobe_instanceä¸­.<br>
</p>

<p>
ç®€è€Œè¨€ä¹‹ï¼Œkretprobeä¼šå¤„ç†å¥½å¤šå®ä¾‹çš„é—®é¢˜ï¼Œå¹¶ä¸”å¯¹æ¯æ¬¡çš„å‡½æ•°è¿›å…¥ï¼Œé€€å‡ºéƒ½æœ‰å¯¹åº”çš„private dataå¯ä¾›ä¿å­˜å¯¹åº”çš„æ•°æ®ã€‚è€Œkprobeåªèƒ½æ¢æµ‹å•æ¡æŒ‡ä»¤ï¼Œåœ¨æŒ‡ä»¤è¿è¡Œå‰åæ‰§è¡Œæ³¨å†Œè¿›å–çš„callback.<br>
</p>
</div>
</div>


<div id="outline-container-org243415f" class="outline-2">
<h2 id="org243415f">åº•å±‚å®ç°</h2>
<div class="outline-text-2" id="text-org243415f">
</div>
<div id="outline-container-orgc1c5776" class="outline-3">
<h3 id="orgc1c5776">kprobe</h3>
<div class="outline-text-3" id="text-orgc1c5776">
<p>
kprobe_addr ç”¨æ¥è·å–éœ€è¦patchçš„æŒ‡ä»¤åœ°å€ï¼Œç›®å‰å¯ä»¥é€šè¿‡æŒ‡å®šadd/symbol + offsetçš„æ–¹æ³•æ¥æŒ‡å®š.<br>
check_kprobe_rereg ç”¨æ¥æ£€æŸ¥kprobeå¯¹è±¡æ˜¯å¦å·²ç»è¢«æ³¨å†Œè¿‡ï¼Œå¦‚æœå·²ç»è¢«æ³¨å†Œè¿‡ï¼Œå°±è¿”å›-EINVALçš„é”™è¯¯<br>
prepare_kprobe ç”¨æ¥è®°å½•åŸå§‹çš„æŒ‡ä»¤, è®¡ç®—æ–°çš„æŒ‡ä»¤ï¼Œå¹¶ä¸”æ³¨å†Œåˆ°ç³»ç»Ÿçš„insnçš„å¤„ç†ä¸­<br>
arm_kprobe ç”¨æ¥ç»™textä»£ç æ®µæ‰“patchï¼Œå°†éœ€è¦trapçš„æŒ‡ä»¤æ›¿æ¢æˆdebugæŒ‡ä»¤<br>
</p>
</div>

<div id="outline-container-org531aec0" class="outline-4">
<h4 id="org531aec0">kprobe ç›¸å…³å…³é”®ä»£ç </h4>
<div class="outline-text-4" id="text-org531aec0">
<p>
åœ¨æ³¨å†Œkprobeæ—¶ï¼Œç³»ç»Ÿå°†å¯¹åº”åœ°å€çš„æŒ‡ä»¤æ›¿æ¢æˆbrkçš„æŒ‡ä»¤ï¼Œå½“ç³»ç»Ÿè¿è¡Œåˆ°å¯¹åº”çš„åœ°å€æ—¶ï¼Œç³»ç»Ÿä¼šè§¦å‘debugçš„å¼‚å¸¸<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">arm kprobe: install breakpoint in text</span><span style="color: #5B6268;"> */</span></code>
<code><span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">__kprobes</span> arch_arm_kprobe(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">kprobe</span> *<span style="color: #dcaeea;">p</span>)</code>
<code>{</code>
<code>    <span style="color: #ECBE7B;">void</span> *<span style="color: #dcaeea;">addr</span> = p-&gt;addr;</code>
<code>    <span style="color: #ECBE7B;">u32</span> <span style="color: #dcaeea;">insn</span> = BRK64_OPCODE_KPROBES;</code>
<code></code>
<code>    aarch64_insn_patch_text(&amp;addr, &amp;insn, 1);</code>
<code>}</code>
<code></code>
<code><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">disarm kprobe: remove breakpoint from text</span><span style="color: #5B6268;"> */</span></code>
<code><span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">__kprobes</span> arch_disarm_kprobe(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">kprobe</span> *<span style="color: #dcaeea;">p</span>)</code>
<code>{</code>
<code>    <span style="color: #ECBE7B;">void</span> *<span style="color: #dcaeea;">addr</span> = p-&gt;addr;</code>
<code></code>
<code>    aarch64_insn_patch_text(&amp;addr, &amp;p-&gt;opcode, 1);</code>
<code>}</code>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">brk_handler</span>(<span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> <span style="color: #dcaeea;">unused</span>, <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">esr</span>,</code>
<code>                    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pt_regs</span> *<span style="color: #dcaeea;">regs</span>)</code>
<code>{</code>
<code>    <span style="color: #51afef;">if</span> (call_break_hook(regs, esr) == DBG_HOOK_HANDLED)</code>
<code>        <span style="color: #51afef;">return</span> 0;</code>
<code></code>
<code>    <span style="color: #51afef;">if</span> (user_mode(regs)) {</code>
<code>        send_user_sigtrap(TRAP_BRKPT);</code>
<code>    } <span style="color: #51afef;">else</span> {</code>
<code>        pr_warn(<span style="color: #98be65;">"Unexpected kernel BRK exception at EL1\n"</span>);</code>
<code>        <span style="color: #51afef;">return</span> -EFAULT;</code>
<code>    }</code>
<code></code>
<code>    <span style="color: #51afef;">return</span> 0;</code>
<code>}</code>
<code><span style="color: #c678dd;">NOKPROBE_SYMBOL</span>(brk_handler);</code>
</pre>
</div>
<p>
åœ¨brk handlerä¸­ï¼Œkprobeé€šè¿‡è®¾ç½®å•éƒ¨è°ƒè¯•æ¥å®ç°è°ƒè¯•æŒ‡ä»¤çš„è¿è¡Œ, ä»£ç å¦‚ä¸‹æ‰€ç¤º<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #51afef;">static</span> <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">__kprobes</span> kprobe_handler(<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">pt_regs</span> *<span style="color: #dcaeea;">regs</span>)</code>
<code>{</code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">kprobe</span> *<span style="color: #dcaeea;">p</span>, *<span style="color: #dcaeea;">cur_kprobe</span>;</code>
<code>    <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">kprobe_ctlblk</span> *<span style="color: #dcaeea;">kcb</span>;</code>
<code>    <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> <span style="color: #dcaeea;">addr</span> = instruction_pointer(regs);</code>
<code></code>
<code>    kcb = get_kprobe_ctlblk();</code>
<code>    cur_kprobe = kprobe_running();</code>
<code></code>
<code>    p = get_kprobe((<span style="color: #ECBE7B;">kprobe_opcode_t</span> *) addr);</code>
<code></code>
<code>    <span style="color: #51afef;">if</span> (p) {</code>
<code>        <span style="color: #51afef;">if</span> (cur_kprobe) {</code>
<code>            <span style="color: #51afef;">if</span> (reenter_kprobe(p, regs, kcb))</code>
<code>                <span style="color: #51afef;">return</span>;</code>
<code>        } <span style="color: #51afef;">else</span> {</code>
<code>            <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Probe hit</span><span style="color: #5B6268;"> */</span></code>
<code>            set_current_kprobe(p);</code>
<code>            kcb-&gt;kprobe_status = KPROBE_HIT_ACTIVE;</code>
<code></code>
<code>            <span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;">             * If we have no pre-handler or it returned 0, we</span></code>
<code><span style="color: #5B6268;">             * continue with normal processing.  If we have a</span></code>
<code><span style="color: #5B6268;">             * pre-handler and it returned non-zero, it will</span></code>
<code><span style="color: #5B6268;">             * modify the execution path and no need to single</span></code>
<code><span style="color: #5B6268;">             * stepping. Let's just reset current kprobe and exit.</span></code>
<code><span style="color: #5B6268;">             */</span></code>
<code>            <span style="color: #51afef;">if</span> (<span style="color: #51afef; font-weight: bold;">!</span>p-&gt;pre_handler || <span style="color: #51afef; font-weight: bold;">!</span>p-&gt;pre_handler(p, regs)) {</code>
<code>                setup_singlestep(p, regs, kcb, 0);</code>
<code>            } <span style="color: #51afef;">else</span></code>
<code>                reset_current_kprobe();</code>
<code>        }</code>
<code>    }</code>
<code>    <span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;">     * The breakpoint instruction was removed right</span></code>
<code><span style="color: #5B6268;">     * after we hit it.  Another cpu has removed</span></code>
<code><span style="color: #5B6268;">     * either a probepoint or a debugger breakpoint</span></code>
<code><span style="color: #5B6268;">     * at this address.  In either case, no further</span></code>
<code><span style="color: #5B6268;">     * handling of this interrupt is appropriate.</span></code>
<code><span style="color: #5B6268;">     * Return back to original instruction, and continue.</span></code>
<code><span style="color: #5B6268;">     */</span></code>
<code>}</code>
</pre>
</div>

<p>
åœ¨è¢«hookçš„æŒ‡ä»¤å•æ­¥æ‰§è¡Œä¹‹åï¼Œç³»ç»Ÿé€šè¿‡ <a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/arch/arm64/kernel/probes/kprobes.c#L335">kprobe_breakpoint_ss_handler</a> æ¥å¤„ç†æ¥ä¸‹æ¥çš„ä»»åŠ¡, å¹¶åœ¨æ­¤å¤„æ¸…ç†å•æ­¥è°ƒè¯•çš„è®¾ç½®ï¼Œå¹¶è°ƒç”¨post_handler<br>
</p>
</div>
</div>

<div id="outline-container-orgdcd7043" class="outline-4">
<h4 id="orgdcd7043">kprobeæ‰§è¡Œæµç¨‹</h4>
<div class="outline-text-4" id="text-orgdcd7043">
<p>
æµç¨‹å›¾å¤§è‡´å¦‚ä¸‹:<br>
</p>
<p>
<img src="assets/.kprobe_call_sequence.png" alt=".kprobe_call_sequence.png"><br>
ä¸Šå›¾å¤§æ¦‚ç”»å‡ºäº†aarch64æ¶æ„ä¸‹kprobeçš„æ‰§è¡Œæµç¨‹ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œkprobeåˆ©ç”¨ä¿®æ”¹æŒ‡ä»¤ï¼Œå¹¶ä¸”CPUå•æ­¥è°ƒè¯•çš„åŠŸèƒ½å®Œæˆæ•´ä¸ªkprobeçš„åŠŸèƒ½ã€‚<br>
</p>

<p>
æ³¨ï¼šä¸ºäº†æ–¹ä¾¿ï¼Œå›¾ä¸­å¹¶æ²¡æœ‰ç”»å‡ºéœ€è¦æ¨¡æ‹ŸæŒ‡ä»¤çš„è¿è¡Œè·¯å¾„ï¼Œå¯¹äºéœ€è¦æ¨¡æ‹Ÿè¿è¡Œçš„æŒ‡ä»¤ï¼Œå¦‚bï¼Œblç­‰å¹¶ä¸ä¼šä½¿ç”¨å•æ­¥è°ƒè¯•çš„åŠŸèƒ½ï¼Œè€Œæ˜¯é€šè¿‡è½¯ä»¶æ¥æ¨¡æ‹Ÿï¼Œè§ä»£ç <a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/arch/arm64/kernel/probes/kprobes.c#L65">singlestep for insn simulation</a>, å¹¶ä¸”åœ¨æ¨¡æ‹Ÿå®Œæˆä¹‹åç›´æ¥è°ƒç”¨ post_handlerå›è°ƒã€‚<br>
</p>
</div>
</div>
</div>

<div id="outline-container-org8c47146" class="outline-3">
<h3 id="org8c47146">kretprobe</h3>
<div class="outline-text-3" id="text-org8c47146">
</div>
<div id="outline-container-orgb4310d8" class="outline-4">
<h4 id="orgb4310d8">æ³¨å†Œ</h4>
<div class="outline-text-4" id="text-orgb4310d8">
<p>
kretprobeåœ¨kprobeçš„åŸºç¡€ä¸Šå®ç°ï¼Œæ³¨å†Œå‡½æ•°å¾ˆç®€å•ï¼Œå‚æ•°æ£€æŸ¥ï¼Œåˆ†é…å¯¹è±¡ï¼Œä»¥åŠæ³¨å†Œkprobe<br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/kernel/kprobes.c#L1983">kernel source for register_kretprobe</a><br>
</p>
<ol class="org-ol">
<li>æ£€æŸ¥å‚æ•°<br>
kretprobeè¦æ±‚æ¢æµ‹çš„å‡½æ•°ä½äºè¡Œæ•°å¼€ç«¯ï¼Œåœ¨æ³¨å†Œæ—¶ç³»ç»Ÿä¼šæ£€æŸ¥åœ°å€æ˜¯å¦åœ¨å‡½æ•°çš„å¼€å§‹ä½ç½® <a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/kernel/kprobes.c#L1967">kprobe_on_func_entry</a><br></li>
<li>æ ¹æ®maxactiveæ¥åˆ†é…kretprobe_instanceå¯¹è±¡<br></li>
<li>æ³¨å†Œkprobe<br></li>
</ol>
</div>
</div>

<div id="outline-container-org27db33c" class="outline-4">
<h4 id="org27db33c">pre_handler</h4>
<div class="outline-text-4" id="text-org27db33c">
<p>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/kernel/kprobes.c#L1922">kernel source for pre_handler_kretprobe</a><br>
</p>

<ol class="org-ol">
<li>ä»freelistä¸­å–å‡ºä¸€ä¸ªæœªä½¿ç”¨çš„kretprobe_instanceå¯¹è±¡<br></li>
<li>å¦‚æœæ³¨å†Œæœ‰entry_handlerï¼Œåˆ™è¿è¡Œentry_handler<br></li>
<li>å¦‚æœæœ‰entry_handlerå¹¶ä¸”è¿è¡Œè¿”å›é0ï¼Œé‡Šæ”¾kretprobe_instanceå¯¹è±¡ï¼Œå¹¶ç»“æŸ<br></li>
<li>è¿è¡Œarch_prepare_kretprobeï¼Œä¿å­˜å¹¶ä¿®æ”¹å‡½æ•°è¿è¡Œè¿”å›åœ°å€ä¸ºkretprobe_trampoline<br></li>
<li>è¢«æ¢æµ‹çš„å‡½æ•°ç»§ç»­è¿è¡Œï¼Œè¿”å›åå°†ä¼šç›´æ¥è¿”å›kretprobe_trampoline<br></li>
</ol>
</div>
</div>

<div id="outline-container-org21b64eb" class="outline-4">
<h4 id="org21b64eb">kretprobe_trampoline</h4>
<div class="outline-text-4" id="text-org21b64eb">
<p>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/arch/arm64/kernel/probes/kprobes_trampoline.S#L64">kretprobe_trampoline</a><br>
<a target="_blank" href="https://github.com/torvalds/linux/blob/b133f076639b918bb6ad157f6308b0f595058959/kernel/kprobes.c#L1860">__kretprobe_trampoline_handler</a><br>
</p>
<ol class="org-ol">
<li>è·å–è¢«æ¢æµ‹å‡½æ•°çš„çœŸå®è¿”å›åœ°å€ (è¯¥åœ°å€åœ¨arch_prepare_kretprobe ä¸­è¢«ä¿å­˜)<br></li>
<li>å°†kretprobe_instanceçš„ret_addrè®¾ç½®ä¸ºçœŸå®çš„è¿”å›åœ°å€ (é’ˆå¯¹ä¸€ä¸ªå‡½æ•°æ³¨å†Œäº†å¤šäº†kretprobeçš„æƒ…å†µ)<br></li>
<li>è°ƒç”¨handlerçš„å›è°ƒ, å¹¶ä¸”å›æ”¶kretprobe_instanceå¯¹è±¡<br></li>
</ol>
</div>
</div>

<div id="outline-container-org1acd11d" class="outline-4">
<h4 id="org1acd11d">kretprobe summary</h4>
<div class="outline-text-4" id="text-org1acd11d">
<p>
æ ¹æ®ä¸Šè¿°çš„åˆ†æï¼Œkretprobeé€šè¿‡åœ¨å‡½æ•°çš„é¦–åœ°å€æ”¾ç½®kprobeæ¢é’ˆï¼Œå¹¶é€šè¿‡ä¿®æ”¹lræŒ‡é’ˆçš„æ–¹å¼å®Œæˆæ•è·æ•´ä¸ªå‡½æ•°çš„è°ƒç”¨å¼€å§‹ä»¥åŠç»“æŸã€‚<br>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbf6cb9d" class="outline-2">
<h2 id="orgbf6cb9d">Summary</h2>
<div class="outline-text-2" id="text-orgbf6cb9d">
<p>
ä»¥ä¸Šåˆ†æäº†kprobeå’Œkretprobeçš„åŸºæœ¬å®ç°ï¼Œç”±åˆ†æå¯å¾—ç»“è®ºï¼Œkprobeåªèƒ½åˆ†æå•æ¡æŒ‡ä»¤ï¼Œå…¶ä¸¤ä¸ªcallbackå‡½æ•°ä¼šåœ¨æŒ‡ä»¤æ‰§è¡Œçš„å‰åè¢«è°ƒç”¨ã€‚<br>
è€Œkretprobeèƒ½åˆ†ææ•´ä¸ªå‡½æ•°çš„æ‰§è¡Œï¼Œå…¶ä¸¤ä¸ªcallbackä¼šåœ¨å‡½æ•°è°ƒç”¨å‰ï¼Œä»¥åŠå‡½æ•°è¿è¡Œè¿”å›åæ‰§è¡Œã€‚<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
