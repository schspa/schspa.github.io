<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2023-05-06 Sat 10:09 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QEMU virtio-9p-device assert failed</title>
<meta name="author" content="Schspa" />
<meta name="description" content="QEMU virtio-9p-device assert failed" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">QEMU virtio-9p-device assert failed</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org61e6dc4">Problems</a></li>
<li><a href="#org1229ea8">Problem analyse</a>
<ul>
<li><a href="#org268e13e">google it.</a></li>
<li><a href="#orgf3e641c">查一下本地仓库的提交记录</a></li>
<li><a href="#orgbf502da">稍微调试一下</a>
<ul>
<li><a href="#org9433aaa">看看之前已经合入的修复patch</a></li>
<li><a href="#orgd1d9f76">回过头看我们的设备名称</a></li>
<li><a href="#org4166c0d">调试以下修复的patch</a></li>
<li><a href="#orgdc6410e">看看这个地址为什么不对</a></li>
<li><a href="#org1cb2595">看一看virtio-mmio的创建代码</a></li>
<li><a href="#org1eebda6">看看其他平台</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org93af68b">修复方案</a>
<ul>
<li><a href="#org0508452">添加sysbus_mmio_map的调用</a></li>
<li><a href="#org8884c83">使用arm virt平台上的初始化</a></li>
<li><a href="#org9daaa14">不太OK的解决方案</a></li>
<li><a href="#org3ec61f4">提交的qemu中的解决方案</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org61e6dc4" class="outline-2">
<h2 id="org61e6dc4">Problems</h2>
<div class="outline-text-2" id="text-org61e6dc4">
<p>
在xlnx-versal-virt平台上，创建多个相同类型的virtio设备时，会报错<br>
</p>
<ul class="org-ul">
<li>启动命令<br></li>
</ul>
<div class="org-src-container">
<pre class="src src-bash"><code>qemu-system-aarch64 <span class="org-sh-escaped-newline">\</span></code>
<code>    -machine xlnx-versal-virt -nographic -smp 2 -m 128 <span class="org-sh-escaped-newline">\</span></code>
<code>    -fsdev local,<span class="org-variable-name">id</span>=shareid,<span class="org-variable-name">path</span>=${<span class="org-variable-name">HOME</span>}/work,<span class="org-variable-name">security_model</span>=none <span class="org-sh-escaped-newline">\</span></code>
<code>    -device virtio-9p-device,<span class="org-variable-name">fsdev</span>=shareid,<span class="org-variable-name">mount_tag</span>=share <span class="org-sh-escaped-newline">\</span></code>
<code>    -fsdev local,<span class="org-variable-name">id</span>=shareid1,<span class="org-variable-name">path</span>=${<span class="org-variable-name">HOME</span>}/Music,<span class="org-variable-name">security_model</span>=none <span class="org-sh-escaped-newline">\</span></code>
<code>    -device virtio-9p-device,<span class="org-variable-name">fsdev</span>=shareid1,<span class="org-variable-name">mount_tag</span>=share1</code>
</pre>
</div>
<ul class="org-ul">
<li>错误信息<br></li>
</ul>
<div class="org-src-container">
<pre class="src src-bash"><code>qemu-system-aarch64: ../migration/savevm.c:860: vmstate_register_with_alias_id: Assertion <span class="org-sh-quoted-exec">`!se-&gt;compat || se-&gt;instance_id == 0' failed.</span></code>
<code><span class="org-sh-quoted-exec">[1]    999094 abort (core dumped)</span></code>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1229ea8" class="outline-2">
<h2 id="org1229ea8">Problem analyse</h2>
<div class="outline-text-2" id="text-org1229ea8">
</div>
<div id="outline-container-org268e13e" class="outline-3">
<h3 id="org268e13e">google it.</h3>
<div class="outline-text-3" id="text-org268e13e">
<ul class="org-ul">
<li>bug report<br>
<a href="https://bugs.launchpad.net/qemu/+bug/1594239">https://bugs.launchpad.net/qemu/+bug/1594239</a><br></li>
<li>maillist<br>
<a href="https://lists.gnu.org/archive/html/qemu-devel/2016-06/msg06367.html">[Qemu-devel] Question about a qemu Aarch64 error when adding several SCS</a><br>
<a href="https://lists.nongnu.org/archive/html/qemu-devel/2016-07/msg01119.html">[Qemu-devel] [PATCH] virtio-mmio: format transport base address in BusCl</a><br></li>
</ul>
</div>
</div>

<div id="outline-container-orgf3e641c" class="outline-3">
<h3 id="orgf3e641c">查一下本地仓库的提交记录</h3>
<div class="outline-text-3" id="text-orgf3e641c">
<p>
<img src="assets/2021-02-03_16-27-59_screenshot.png" alt="2021-02-03_16-27-59_screenshot.png"><br>
这个提交好好的躺在这里呢, 2333.<br>
</p>
</div>
</div>

<div id="outline-container-orgbf502da" class="outline-3">
<h3 id="orgbf502da">稍微调试一下</h3>
<div class="outline-text-3" id="text-orgbf502da">
<p>
gdb调试一下<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>Reading symbols from ./qemu-system<span class="org-string">\-</span>aarch64...</code>
<code>(gdb) <span class="org-builtin">r</span></code>
<code>Starting program: /home/schspa/work/qemu-master/build/qemu-system-aarch64 -machine xlnx-versal-virt -nographic -smp 2 -m 128 -fsdev local,<span class="org-variable-name">id</span>=shareid,<span class="org-variable-name">path</span>=/home/schspa/work,<span class="org-variable-name">security_model</span>=none</code>
<code> -device virtio-9p-device,<span class="org-variable-name">fsdev</span>=shareid,<span class="org-variable-name">mount_tag</span>=share -fsdev local,<span class="org-variable-name">id</span>=shareid1,<span class="org-variable-name">path</span>=/home/schspa/Music,<span class="org-variable-name">security_model</span>=none -device virtio-9p-device,<span class="org-variable-name">fsdev</span>=shareid1,<span class="org-variable-name">mount_tag</span>=share1</code>
<code>[Thread debugging using libthread_db enabled]</code>
<code>Using host libthread_db library <span class="org-string">"/usr/lib/libthread_db.so.1"</span>.</code>
<code>[New Thread 0x7ffff270c640 (LWP 1002865)]</code>
<code>[New Thread 0x7ffff19c0640 (LWP 1002870)]</code>
<code>[New Thread 0x7ffff11bf640 (LWP 1002871)]</code>
<code>qemu-system-aarch64: ../migration/savevm.c:860: vmstate_register_with_alias_id: Assertion <span class="org-sh-quoted-exec">`!se-&gt;compat || se-&gt;instance_id == 0' failed.</span></code>
<code></code>
<code><span class="org-sh-quoted-exec">Thread 1 "qemu-system-aar" received signal SIGABRT, Aborted.</span></code>
<code><span class="org-sh-quoted-exec">0x00007ffff5e5f615 in raise () from /usr/lib/libc.so.6</span></code>
<code><span class="org-sh-quoted-exec">(gdb) bt</span></code>
<code><span class="org-sh-quoted-exec">#0  0x00007ffff5e5f615 in raise () at /usr/lib/libc.so.6</span></code>
<code><span class="org-sh-quoted-exec">#1  0x00007ffff5e48862 in abort () at /usr/lib/libc.so.6</span></code>
<code><span class="org-sh-quoted-exec">#2  0x00007ffff5e48747 in _nl_load_domain.cold () at /usr/lib/libc.so.6</span></code>
<code><span class="org-sh-quoted-exec">#3  0x00007ffff5e57bf6 in  () at /usr/lib/libc.so.6</span></code>
<code><span class="org-sh-quoted-exec">#4  0x000055555590595c in vmstate_register_with_alias_id (obj=&lt;optimized out&gt;, instance_id=&lt;optimized out&gt;, instance_id@entry=4294967295, vmsd=vmsd@entry=0x555556834c00 &lt;vmstate_virtio_9p&gt;, opaque=opaque@entry=0x555557b459b0, alias_id=alias_id@entry=-1, required_for_version=required_for_version@entry=0, errp=0x7fffffffd4c0) at ../migration/savevm.c:860</span></code>
<code><span class="org-sh-quoted-exec">#5  0x0000555555f06b7f in device_set_realized (obj=&lt;optimized out&gt;, value=&lt;optimized out&gt;, errp=0x7fffffffd540) at ../hw/core/qdev.c:784</span></code>
<code><span class="org-sh-quoted-exec">#6  0x0000555555e4cc66 in property_set_bool (obj=0x555557b459b0, v=&lt;optimized out&gt;, name=&lt;optimized out&gt;, opaque=0x555556a96150, errp=0x7fffffffd540) at ../qom/object.c:2255</span></code>
<code><span class="org-sh-quoted-exec">#7  0x0000555555e4fb18 in object_property_set (obj=obj@entry=0x555557b459b0, name=name@entry=0x5555561eecfd "realized", v=v@entry=0x555557b47e40, errp=errp@entry=0x5555569c6ae8 &lt;error_fatal&gt;) at ../qom/object.c:1400</span></code>
<code><span class="org-sh-quoted-exec">#8  0x0000555555e4bc30 in object_property_set_qobject (obj=obj@entry=0x555557b459b0, name=name@entry=0x5555561eecfd "realized", value=value@entry=0x555557b47d80, errp=errp@entry=0x5555569c6ae8 &lt;error_fatal&gt;) at ../qom/qom-qobject.c:28</span></code>
<code><span class="org-sh-quoted-exec">#9  0x0000555555e50105 in object_property_set_bool (obj=0x555557b459b0, name=name@entry=0x5555561eecfd "realized", value=value@entry=true, errp=errp@entry=0x5555569c6ae8 &lt;error_fatal&gt;) at ../qom/object.c:1470</span></code>
<code><span class="org-sh-quoted-exec">#10 0x0000555555f0706e in qdev_realize (dev=&lt;optimized out&gt;, bus=bus@entry=0x5555578cfbb8, errp=errp@entry=0x5555569c6ae8 &lt;error_fatal&gt;) at ../hw/core/qdev.c:389</span></code>
<code><span class="org-sh-quoted-exec">#11 0x0000555555a0c420 in qdev_device_add (opts=0x555556a946b0, errp=errp@entry=0x5555569c6ae8 &lt;error_fatal&gt;) at ../softmmu/qdev-monitor.c:665</span></code>
<code><span class="org-sh-quoted-exec">#12 0x0000555555daf81f in device_init_func (opaque=&lt;optimized out&gt;, opts=&lt;optimized out&gt;, errp=0x5555569c6ae8 &lt;error_fatal&gt;) at ../softmmu/vl.c:1201</span></code>
<code><span class="org-sh-quoted-exec">#13 0x0000555555ffba2a in qemu_opts_foreach (list=&lt;optimized out&gt;, func=func@entry=0x555555daf810 &lt;device_init_func&gt;, opaque=opaque@entry=0x0, errp=0x5555569c6ae8 &lt;error_fatal&gt;) at ../util/qemu-option.c:1163</span></code>
<code><span class="org-sh-quoted-exec">#14 0x0000555555db20fe in qemu_create_cli_devices () at ../softmmu/vl.c:2488</span></code>
<code><span class="org-sh-quoted-exec">#15 qmp_x_exit_preconfig (errp=&lt;optimized out&gt;) at ../softmmu/vl.c:2527</span></code>
<code><span class="org-sh-quoted-exec">#16 0x0000555555db5b7b in qmp_x_exit_preconfig (errp=&lt;optimized out&gt;) at ../softmmu/vl.c:2521</span></code>
<code><span class="org-sh-quoted-exec">#17 qemu_init (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;, envp=&lt;optimized out&gt;) at ../softmmu/vl.c:3533</span></code>
<code><span class="org-sh-quoted-exec">#18 0x000055555589d219 in main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;, envp=&lt;optimized out&gt;) at ../softmmu/main.c:49</span></code>
<code><span class="org-sh-quoted-exec">(gdb) f 4</span></code>
<code><span class="org-sh-quoted-exec">#4  0x000055555590595c in vmstate_register_with_alias_id (obj=&lt;optimized out&gt;, instance_id=&lt;optimized out&gt;, instance_id@entry=4294967295, vmsd=vmsd@entry=0x555556834c00 &lt;vmstate_virtio_9p&gt;, opaque=opaque@entry=0x555557b459b0, alias_id=alias_id@entry=-1, required_for_version=required_for_version@entry=0, errp=0x7fffffffd4c0) at ../migration/savevm.c:860</span></code>
<code><span class="org-sh-quoted-exec">860         assert(!se-&gt;compat || se-&gt;instance_id == 0);</span></code>
<code><span class="org-sh-quoted-exec">(gdb) info locals</span></code>
<code><span class="org-sh-quoted-exec">se = 0x555557c6fe60</span></code>
<code><span class="org-sh-quoted-exec">__PRETTY_FUNCTION__ = "vmstate_register_with_alias_id"</span></code>
<code><span class="org-sh-quoted-exec">__func__ = "vmstate_register_with_alias_id"</span></code>
<code><span class="org-sh-quoted-exec">(gdb) p se</span></code>
<code><span class="org-sh-quoted-exec">$1 = (SaveStateEntry *) 0x555557c6fe60</span></code>
<code><span class="org-sh-quoted-exec">(gdb) p *se</span></code>
<code><span class="org-sh-quoted-exec">$2 = {</span></code>
<code><span class="org-sh-quoted-exec">  entry = {</span></code>
<code><span class="org-sh-quoted-exec">    tqe_next = 0x0,</span></code>
<code><span class="org-sh-quoted-exec">    tqe_circ = {</span></code>
<code><span class="org-sh-quoted-exec">      tql_next = 0x0,</span></code>
<code><span class="org-sh-quoted-exec">      tql_prev = 0x0</span></code>
<code><span class="org-sh-quoted-exec">    }</span></code>
<code><span class="org-sh-quoted-exec">  },</span></code>
<code><span class="org-sh-quoted-exec">  idstr = "virtio-mmio@", 'f' &lt;repeats 16 times&gt;, "/virtio-9p", '\000' &lt;repeats 217 times&gt;,</span></code>
<code><span class="org-sh-quoted-exec">  instance_id = 1,</span></code>
<code><span class="org-sh-quoted-exec">  alias_id = -1,</span></code>
<code><span class="org-sh-quoted-exec">  version_id = 1,</span></code>
<code><span class="org-sh-quoted-exec">  load_version_id = 0,</span></code>
<code><span class="org-sh-quoted-exec">  section_id = 31,</span></code>
<code><span class="org-sh-quoted-exec">  load_section_id = 0,</span></code>
<code><span class="org-sh-quoted-exec">  ops = 0x0,</span></code>
<code><span class="org-sh-quoted-exec">  vmsd = 0x555556834c00 &lt;vmstate_virtio_9p&gt;,</span></code>
<code><span class="org-sh-quoted-exec">  opaque = 0x555557b459b0,</span></code>
<code><span class="org-sh-quoted-exec">  compat = 0x555557c6ffc0,</span></code>
<code><span class="org-sh-quoted-exec">  is_ram = 0</span></code>
<code><span class="org-sh-quoted-exec">}</span></code>
</pre>
</div>
<p>
从上边可以看到，se-&gt;compat = 0x555557c6ffc0, se-&gt;instance_id = 1.所以触发了代码中的assert，导致abort.<br>
</p>

<p>
由于不了解这一块的代码逻辑，只能研究一下之前别人提交的patch<br>
</p>
</div>

<div id="outline-container-org9433aaa" class="outline-4">
<h4 id="org9433aaa">看看之前已经合入的修复patch</h4>
<div class="outline-text-4" id="text-org9433aaa">
<blockquote>
<p>
(1) The virtio device whose devpath is to be formatted resides on a<br>
  virtio-mmio bus that is implemented by a VirtIOMMIOProxy object. Ask<br>
  the parent bus of VirtIOMMIOProxy to format the device path of<br>
  VirtIOMMIOProxy, as a path prefix. (This is identical to what<br>
  virtio_bus_get_dev_path() does.)<br>
</p>

<p>
(2) Append the base address of VirtIOMMIOProxy to the device path, such<br>
  as:<br>
</p>
<ul class="org-ul">
<li>virtio-mmio@000000000a003e00,<br></li>
<li>virtio-mmio@000000000a003c00.<br></li>
</ul>
</blockquote>
<p>
修复方法中有提到修复的方法，从comment中可知，修复中为VirtIOMMIOProxy的bus添加了get_dev_path的实现,最终获取设备时会生成virtio-mmio@000000000a003e00这样的设备名称.<br>
</p>
</div>
</div>

<div id="outline-container-orgd1d9f76" class="outline-4">
<h4 id="orgd1d9f76">回过头看我们的设备名称</h4>
<div class="outline-text-4" id="text-orgd1d9f76">
<div class="org-src-container">
<pre class="src src-bash"><code>(gdb) <span class="org-builtin">print</span> se-&gt;idstr</code>
<code>$<span class="org-variable-name">6</span> = <span class="org-string">"virtio-mmio@"</span>, <span class="org-string">'f'</span> &lt;repeats 16 times&gt;, <span class="org-string">"/virtio-9p"</span>, <span class="org-string">'\000'</span> &lt;repeats 217 times&gt;</code>
</pre>
</div>
<p>
从这里可以看到，这里获取到的设备名称是virtio-mmio@ffffffffffffffff/virtio-9p 这样看来，提交的patch好像没有生效. 2333<br>
</p>
</div>
</div>

<div id="outline-container-org4166c0d" class="outline-4">
<h4 id="org4166c0d">调试以下修复的patch</h4>
<div class="outline-text-4" id="text-org4166c0d">
<ul class="org-ul">
<li><p>
这里我们看一下virtio_mmio_bus_get_dev_path的执行情况:<br>
打上断点，go<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>Thread 1 <span class="org-string">"qemu-system-aar"</span> hit Breakpoint 1, virtio_mmio_bus_get_dev_path (<span class="org-variable-name">dev</span>=0x555557a1b0d0) at ../hw/virtio/virtio-mmio.c:735</code>
<code>735         <span class="org-variable-name">virtio_mmio_bus</span> = qdev_get_parent_bus(dev);</code>
<code>(gdb) n</code>
<code>736         <span class="org-variable-name">virtio_mmio_proxy</span> = VIRTIO_MMIO(virtio_mmio_bus-&gt;parent);</code>
<code>(gdb)</code>
<code>737         <span class="org-variable-name">proxy_path</span> = qdev_get_dev_path(DEVICE(virtio_mmio_proxy));</code>
<code>(gdb)</code>
<code>736         <span class="org-variable-name">virtio_mmio_proxy</span> = VIRTIO_MMIO(virtio_mmio_bus-&gt;parent);</code>
<code>(gdb)</code>
<code>737         <span class="org-variable-name">proxy_path</span> = qdev_get_dev_path(DEVICE(virtio_mmio_proxy));</code>
<code>(gdb)</code>
<code>747         if (<span class="org-negation-char">!</span>virtio_mmio_proxy-&gt;format_transport_address) {</code>
<code>(gdb)</code>
<code>752         <span class="org-variable-name">proxy_sbd</span> = SYS_BUS_DEVICE(virtio_mmio_proxy);</code>
<code>(gdb)</code>
<code>753         assert(proxy_sbd-&gt;<span class="org-variable-name">num_mmio</span> == 1);</code>
<code>(gdb) p proxy_sbd-&gt;mmio</code>
<code>$<span class="org-variable-name">1</span> = {{</code>
<code>    <span class="org-variable-name">addr</span> = 18446744073709551615,</code>
<code>    <span class="org-variable-name">memory</span> = 0x5555579404c0</code>
<code>  }, {</code>
<code>    <span class="org-variable-name">addr</span> = 0,</code>
<code>    <span class="org-variable-name">memory</span> = 0x0</code>
<code>  } &lt;repeats 31 times&gt;}</code>
<code>(gdb) p /x proxy_sbd-&gt;mmio</code>
<code>$<span class="org-variable-name">2</span> = {{</code>
<code>    <span class="org-variable-name">addr</span> = 0xffffffffffffffff,</code>
<code>    <span class="org-variable-name">memory</span> = 0x5555579404c0</code>
<code>  }, {</code>
<code>    <span class="org-variable-name">addr</span> = 0x0,</code>
<code>    <span class="org-variable-name">memory</span> = 0x0</code>
<code>  } &lt;repeats 31 times&gt;}</code>
<code>(gdb)</code>
</pre>
</div>
<p>
从这里可以看到，生成名字时用的address就是0xffffffffffffffff. 所以这个patch是没什么问题的。<br>
</p></li>
</ul>
</div>
</div>
<div id="outline-container-orgdc6410e" class="outline-4">
<h4 id="orgdc6410e">看看这个地址为什么不对</h4>
<div class="outline-text-4" id="text-orgdc6410e">
<p>
首先se的类型是SysBusDevice *, 对应的相关代码是sysbus.c<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">sysbus_mmio_map_common</span>(<span class="org-type">SysBusDevice</span> *<span class="org-variable-name">dev</span>, <span class="org-type">int</span> <span class="org-variable-name">n</span>, <span class="org-type">hwaddr</span> <span class="org-variable-name">addr</span>,</code>
<code>                                   <span class="org-type">bool</span> <span class="org-variable-name">may_overlap</span>, <span class="org-type">int</span> <span class="org-variable-name">priority</span>)</code>
<code>{</code>
<code>    assert(n &gt;= 0 &amp;&amp; n &lt; dev-&gt;num_mmio);</code>
<code></code>
<code>    <span class="org-keyword">if</span> (dev-&gt;mmio[n].addr == addr) {</code>
<code>        <span class="org-comment-delimiter">/* </span><span class="org-comment">??? region already mapped here.</span><span class="org-comment-delimiter">  */</span></code>
<code>        <span class="org-keyword">return</span>;</code>
<code>    }</code>
<code>    <span class="org-keyword">if</span> (dev-&gt;mmio[n].addr != (<span class="org-type">hwaddr</span>)-1) {</code>
<code>        <span class="org-comment-delimiter">/* </span><span class="org-comment">Unregister previous mapping.</span><span class="org-comment-delimiter">  */</span></code>
<code>        memory_region_del_subregion(get_system_memory(), dev-&gt;mmio[n].memory);</code>
<code>    }</code>
<code>    dev-&gt;mmio[n].addr = addr;</code>
<code>    <span class="org-keyword">if</span> (may_overlap) {</code>
<code>        memory_region_add_subregion_overlap(get_system_memory(),</code>
<code>                                            addr,</code>
<code>                                            dev-&gt;mmio[n].memory,</code>
<code>                                            priority);</code>
<code>    }</code>
<code>    <span class="org-keyword">else</span> {</code>
<code>        memory_region_add_subregion(get_system_memory(),</code>
<code>                                    addr,</code>
<code>                                    dev-&gt;mmio[n].memory);</code>
<code>    }</code>
<code>}</code>
<code></code>
<code><span class="org-type">void</span> <span class="org-function-name">sysbus_mmio_unmap</span>(<span class="org-type">SysBusDevice</span> *<span class="org-variable-name">dev</span>, <span class="org-type">int</span> <span class="org-variable-name">n</span>)</code>
<code>{</code>
<code>    assert(n &gt;= 0 &amp;&amp; n &lt; dev-&gt;num_mmio);</code>
<code></code>
<code>    <span class="org-keyword">if</span> (dev-&gt;mmio[n].addr != (<span class="org-type">hwaddr</span>)-1) {</code>
<code>        memory_region_del_subregion(get_system_memory(), dev-&gt;mmio[n].memory);</code>
<code>        dev-&gt;mmio[n].addr = (<span class="org-type">hwaddr</span>)-1;</code>
<code>    }</code>
<code>}</code>
</pre>
</div>
<p>
从代码中可知，dev-&gt;mmio[n].addr会在调用sysbus_mmio_map相关函数的时候赋值，而且默认值是-1.<br>
</p>
</div>
</div>

<div id="outline-container-org1cb2595" class="outline-4">
<h4 id="org1cb2595">看一看virtio-mmio的创建代码</h4>
<div class="outline-text-4" id="text-org1cb2595">
<p>
平台xlnx-versal-virt的相关代码为:<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-preprocessor">#define</span> <span class="org-variable-name">NUM_VIRTIO_TRANSPORT</span> 8</code>
<code><span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">create_virtio_regions</span>(<span class="org-type">VersalVirt</span> *<span class="org-variable-name">s</span>)</code>
<code>{</code>
<code>    <span class="org-type">int</span> <span class="org-variable-name">virtio_mmio_size</span> = 0x200;</code>
<code>    <span class="org-type">int</span> <span class="org-variable-name">i</span>;</code>
<code></code>
<code>    <span class="org-keyword">for</span> (i = 0; i &lt; NUM_VIRTIO_TRANSPORT; i++) {</code>
<code>        <span class="org-type">char</span> *<span class="org-variable-name">name</span> = g_strdup_printf(<span class="org-string">"virtio%d"</span>, i);</code>
<code>        <span class="org-type">hwaddr</span> <span class="org-variable-name">base</span> = MM_TOP_RSVD + i * virtio_mmio_size;</code>
<code>        <span class="org-type">int</span> <span class="org-variable-name">irq</span> = VERSAL_RSVD_IRQ_FIRST + i;</code>
<code>        <span class="org-type">MemoryRegion</span> *<span class="org-variable-name">mr</span>;</code>
<code>        <span class="org-type">DeviceState</span> *<span class="org-variable-name">dev</span>;</code>
<code>        <span class="org-type">qemu_irq</span> <span class="org-variable-name">pic_irq</span>;</code>
<code></code>
<code>        pic_irq = qdev_get_gpio_in(DEVICE(&amp;s-&gt;soc.fpd.apu.gic), irq);</code>
<code>        dev = qdev_new(<span class="org-string">"virtio-mmio"</span>);</code>
<code>        object_property_add_child(OBJECT(&amp;s-&gt;soc), name, OBJECT(dev));</code>
<code>        sysbus_realize_and_unref(SYS_BUS_DEVICE(dev), &amp;error_fatal);</code>
<code>        sysbus_connect_irq(SYS_BUS_DEVICE(dev), 0, pic_irq);</code>
<code>        mr = sysbus_mmio_get_region(SYS_BUS_DEVICE(dev), 0);</code>
<code>        memory_region_add_subregion(&amp;s-&gt;soc.mr_ps, base, mr);</code>
<code>        g_free(name);</code>
<code>    }</code>
<code>...</code>
<code>}</code>
</pre>
</div>
<p>
经过查看，这里的初始化方法不会调用sysbus_mmio_map相关函数，所以这里的地址为-1.<br>
</p>
</div>
</div>

<div id="outline-container-org1eebda6" class="outline-4">
<h4 id="org1eebda6">看看其他平台</h4>
<div class="outline-text-4" id="text-org1eebda6">
<p>
下边是arm virt平台的初始化代码.<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-keyword">for</span> (i = 0; i &lt; NUM_VIRTIO_TRANSPORTS; i++) {</code>
<code>    <span class="org-type">int</span> <span class="org-variable-name">irq</span> = vms-&gt;irqmap[VIRT_MMIO] + i;</code>
<code>    <span class="org-type">hwaddr</span> <span class="org-variable-name">base</span> = vms-&gt;memmap[VIRT_MMIO].base + i * size;</code>
<code></code>
<code>    sysbus_create_simple(<span class="org-string">"virtio-mmio"</span>, base,</code>
<code>                        qdev_get_gpio_in(vms-&gt;gic, irq));</code>
<code>}</code>
</pre>
</div>

<p>
在sysbus_create_simple的实现中,系统会调用sysbus_mmio_map来初始化设备地址<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-type">DeviceState</span> *<span class="org-function-name">sysbus_create_varargs</span>(<span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">name</span>,</code>
<code>                <span class="org-type">hwaddr</span> <span class="org-variable-name">addr</span>, ...)</code>
<code>{</code>
<code>    <span class="org-type">DeviceState</span> *<span class="org-variable-name">dev</span>;</code>
<code>    <span class="org-type">SysBusDevice</span> *<span class="org-variable-name">s</span>;</code>
<code>    <span class="org-type">va_list</span> <span class="org-variable-name">va</span>;</code>
<code>    <span class="org-type">qemu_irq</span> <span class="org-variable-name">irq</span>;</code>
<code>    <span class="org-type">int</span> <span class="org-variable-name">n</span>;</code>
<code></code>
<code>    dev = qdev_create(<span class="org-constant">NULL</span>, name);</code>
<code>    s = SYS_BUS_DEVICE(dev);</code>
<code>    qdev_init_nofail(dev);</code>
<code>    <span class="org-keyword">if</span> (addr != (<span class="org-type">hwaddr</span>)-1) {</code>
<code>        sysbus_mmio_map(s, 0, addr);</code>
<code>    }</code>
<code>    va_start(va, addr);</code>
<code>    n = 0;</code>
<code>    <span class="org-keyword">while</span> (1) {</code>
<code>        irq = va_arg(va, qemu_irq);</code>
<code>        <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>irq) {</code>
<code>            <span class="org-keyword">break</span>;</code>
<code>        }</code>
<code>        sysbus_connect_irq(s, n, irq);</code>
<code>        n++;</code>
<code>    }</code>
<code>    va_end(va);</code>
<code>    <span class="org-keyword">return</span> dev;</code>
<code>}</code>
</pre>
</div>
<p>
至此，我们已经看到了故障的root course. 下边就是去寻找解决方案了。<br>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org93af68b" class="outline-2">
<h2 id="org93af68b">修复方案</h2>
<div class="outline-text-2" id="text-org93af68b">
<p>
下边是尝试的几个解决方案:<br>
</p>
</div>
<div id="outline-container-org0508452" class="outline-3">
<h3 id="org0508452">添加sysbus_mmio_map的调用</h3>
<div class="outline-text-3" id="text-org0508452">
<p>
在xlnx-versal-virt平台的virtio-mmio初始化时调用sysbus_mmio_map<br>
</p>
<div class="org-src-container">
<pre class="src src-diff"><code><span class="org-diff-context">modified</span><span class="org-whitespace-space">   </span><span class="org-diff-context">hw/arm/xlnx-versal-virt.c</span></code>
<code><span class="org-diff-hunk-header">@@</span><span class="org-whitespace-space"> </span><span class="org-diff-hunk-header">-490,6</span><span class="org-whitespace-space"> </span><span class="org-diff-hunk-header">+490,7</span><span class="org-whitespace-space"> </span><span class="org-diff-hunk-header">@@</span><span class="org-whitespace-space"> </span><span class="org-diff-function">static</span><span class="org-whitespace-space"> </span><span class="org-diff-function">void</span><span class="org-whitespace-space"> </span><span class="org-diff-function">create_virtio_regions(VersalVirt</span><span class="org-whitespace-space"> </span><span class="org-diff-function">*s)</span></code>
<code><span class="org-diff-context">object_property_add_child(OBJECT(&amp;s-&gt;soc),</span><span class="org-whitespace-space"> </span><span class="org-diff-context">name,</span><span class="org-whitespace-space"> </span><span class="org-diff-context">OBJECT(dev));</span></code>
<code><span class="org-diff-context">sysbus_realize_and_unref(SYS_BUS_DEVICE(dev),</span><span class="org-whitespace-space"> </span><span class="org-diff-context">&amp;error_fatal);</span></code>
<code><span class="org-diff-context">sysbus_connect_irq(SYS_BUS_DEVICE(dev),</span><span class="org-whitespace-space"> </span><span class="org-diff-context">0,</span><span class="org-whitespace-space"> </span><span class="org-diff-context">pic_irq);</span></code>
<code><span class="org-diff-indicator-added">+</span><span class="org-whitespace-space">        </span><span class="org-diff-added">sysbus_mmio_map(SYS_BUS_DEVICE(dev),</span><span class="org-whitespace-space"> </span><span class="org-diff-added">0,</span><span class="org-whitespace-space"> </span><span class="org-diff-added">base);</span></code>
<code><span class="org-diff-context">mr</span><span class="org-whitespace-space"> </span><span class="org-diff-context">=</span><span class="org-whitespace-space"> </span><span class="org-diff-context">sysbus_mmio_get_region(SYS_BUS_DEVICE(dev),</span><span class="org-whitespace-space"> </span><span class="org-diff-context">0);</span></code>
<code><span class="org-diff-context">memory_region_add_subregion(&amp;s-&gt;soc.mr_ps,</span><span class="org-whitespace-space"> </span><span class="org-diff-context">base,</span><span class="org-whitespace-space"> </span><span class="org-diff-context">mr);</span></code>
<code><span class="org-diff-context">g_free(name);</span></code>
<code></code>
</pre>
</div>
<p>
很不幸，这个方案是行不同的，因为系统会出现另外一个问题<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>qemu-system-aarch64: ../softmmu/memory.c:2440: memory_region_add_subregion_common: Assertion <span class="org-sh-quoted-exec">`!subregion-&gt;container' failed.</span></code>
</pre>
</div>
<p>
显而易见，这个是因为系统在调用sysbus_mmio_map的时候已经将对应的region添加到了系统中去了. 再次添加就会出现错误.<br>
</p>
</div>
</div>

<div id="outline-container-org8884c83" class="outline-3">
<h3 id="org8884c83">使用arm virt平台上的初始化</h3>
<div class="outline-text-3" id="text-org8884c83">
<p>
将xlnx-versal-virt平台的virtio-mmio也使用与arm virt相同的方法来初始化，patch如下<br>
</p>
<div class="org-src-container">
<pre class="src src-diff"><code><span class="org-diff-context">modified</span><span class="org-whitespace-space">   </span><span class="org-diff-context">hw/arm/xlnx-versal-virt.c</span></code>
<code><span class="org-diff-hunk-header">@@</span><span class="org-whitespace-space"> </span><span class="org-diff-hunk-header">-478,21</span><span class="org-whitespace-space"> </span><span class="org-diff-hunk-header">+478,12</span><span class="org-whitespace-space"> </span><span class="org-diff-hunk-header">@@</span><span class="org-whitespace-space"> </span><span class="org-diff-function">static</span><span class="org-whitespace-space"> </span><span class="org-diff-function">void</span><span class="org-whitespace-space"> </span><span class="org-diff-function">create_virtio_regions(VersalVirt</span><span class="org-whitespace-space"> </span><span class="org-diff-function">*s)</span></code>
<code><span class="org-whitespace-indentation">    </span><span class="org-whitespace-space"> </span><span class="org-diff-context">int</span><span class="org-whitespace-space"> </span><span class="org-diff-context">i;</span></code>
<code></code>
<code><span class="org-whitespace-indentation">    </span><span class="org-whitespace-space"> </span><span class="org-diff-context">for</span><span class="org-whitespace-space"> </span><span class="org-diff-context">(i</span><span class="org-whitespace-space"> </span><span class="org-diff-context">=</span><span class="org-whitespace-space"> </span><span class="org-diff-context">0;</span><span class="org-whitespace-space"> </span><span class="org-diff-context">i</span><span class="org-whitespace-space"> </span><span class="org-diff-context">&lt;</span><span class="org-whitespace-space"> </span><span class="org-diff-context">NUM_VIRTIO_TRANSPORT;</span><span class="org-whitespace-space"> </span><span class="org-diff-context">i++)</span><span class="org-whitespace-space"> </span><span class="org-diff-context">{</span></code>
<code><span class="org-diff-indicator-removed">-</span><span class="org-whitespace-space">        </span><span class="org-diff-removed">char</span><span class="org-whitespace-space"> </span><span class="org-diff-removed">*name</span><span class="org-whitespace-space"> </span><span class="org-diff-removed">=</span><span class="org-whitespace-space"> </span><span class="org-diff-removed">g_strdup_printf("virtio%d",</span><span class="org-whitespace-space"> </span><span class="org-diff-removed">i);</span></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span><span class="org-diff-context">hwaddr</span><span class="org-whitespace-space"> </span><span class="org-diff-context">base</span><span class="org-whitespace-space"> </span><span class="org-diff-context">=</span><span class="org-whitespace-space"> </span><span class="org-diff-context">MM_TOP_RSVD</span><span class="org-whitespace-space"> </span><span class="org-diff-context">+</span><span class="org-whitespace-space"> </span><span class="org-diff-context">i</span><span class="org-whitespace-space"> </span><span class="org-diff-context">*</span><span class="org-whitespace-space"> </span><span class="org-diff-context">virtio_mmio_size;</span></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span><span class="org-diff-context">int</span><span class="org-whitespace-space"> </span><span class="org-diff-context">irq</span><span class="org-whitespace-space"> </span><span class="org-diff-context">=</span><span class="org-whitespace-space"> </span><span class="org-diff-context">VERSAL_RSVD_IRQ_FIRST</span><span class="org-whitespace-space"> </span><span class="org-diff-context">+</span><span class="org-whitespace-space"> </span><span class="org-diff-context">i;</span></code>
<code><span class="org-diff-indicator-removed">-</span><span class="org-whitespace-space">        </span><span class="org-diff-removed">MemoryRegion</span><span class="org-whitespace-space"> </span><span class="org-diff-removed">*mr;</span></code>
<code><span class="org-diff-indicator-removed">-</span><span class="org-whitespace-space">        </span><span class="org-diff-removed">DeviceState</span><span class="org-whitespace-space"> </span><span class="org-diff-removed">*dev;</span></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span><span class="org-diff-context">qemu_irq</span><span class="org-whitespace-space"> </span><span class="org-diff-context">pic_irq;</span></code>
<code></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span><span class="org-diff-context">pic_irq</span><span class="org-whitespace-space"> </span><span class="org-diff-context">=</span><span class="org-whitespace-space"> </span><span class="org-diff-context">qdev_get_gpio_in(DEVICE(&amp;s-&gt;soc.fpd.apu.gic),</span><span class="org-whitespace-space"> </span><span class="org-diff-context">irq);</span></code>
<code><span class="org-diff-indicator-removed">-</span><span class="org-whitespace-space">        </span><span class="org-diff-removed"><span class="org-diff-refine-removed">dev</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">=</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">qdev</span></span><span class="org-diff-removed">_</span><span class="org-diff-removed"><span class="org-diff-refine-removed">new</span></span><span class="org-diff-removed">("virtio-mmio"</span><span class="org-diff-removed"><span class="org-diff-refine-removed">);</span></span><span class="org-diff-refine-removed"></code>
<code></span><span class="org-diff-indicator-removed"><span class="org-diff-refine-removed">-</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed">        </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">object_property_add_child(OBJECT(&amp;s-&gt;soc)</span></span><span class="org-diff-removed">,</span><span class="org-whitespace-space"> </span><span class="org-diff-removed"><span class="org-diff-refine-removed">name,</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">OBJECT(dev));</span></span><span class="org-diff-refine-removed"></code>
<code></span><span class="org-diff-indicator-removed"><span class="org-diff-refine-removed">-</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed">        </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">sysbus_realize_and_unref(SYS_BUS_DEVICE(dev),</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">&amp;error_fatal);</span></span><span class="org-diff-refine-removed"></code>
<code></span><span class="org-diff-indicator-removed"><span class="org-diff-refine-removed">-</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed">        </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">sysbus_connect_irq(SYS_BUS_DEVICE(dev),</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">0</span></span><span class="org-diff-removed">,</span><span class="org-whitespace-space"> </span><span class="org-diff-removed">pic_irq</span><span class="org-diff-removed"><span class="org-diff-refine-removed">);</span></span><span class="org-diff-refine-removed"></code>
<code></span><span class="org-diff-indicator-removed"><span class="org-diff-refine-removed">-</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed">        </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">mr</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">=</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">sysbus_mmio_get_region(SYS_BUS_DEVICE(dev),</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">0);</span></span><span class="org-diff-refine-removed"></code>
<code></span><span class="org-diff-indicator-removed"><span class="org-diff-refine-removed">-</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed">        </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">memory_region_add_subregion(&amp;s-&gt;soc.mr_ps,</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">base,</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed"> </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">mr);</span></span><span class="org-diff-refine-removed"></code>
<code></span><span class="org-diff-indicator-removed"><span class="org-diff-refine-removed">-</span></span><span class="org-whitespace-space"><span class="org-diff-refine-removed">        </span></span><span class="org-diff-removed"><span class="org-diff-refine-removed">g_free(name</span></span><span class="org-diff-removed">);</span></code>
<code><span class="org-diff-indicator-added">+</span><span class="org-whitespace-space">        </span><span class="org-diff-added"><span class="org-diff-refine-added">sysbus</span></span><span class="org-diff-added">_</span><span class="org-diff-added"><span class="org-diff-refine-added">create_simple</span></span><span class="org-diff-added">("virtio-mmio",</span><span class="org-whitespace-space"> </span><span class="org-diff-added"><span class="org-diff-refine-added">base</span></span><span class="org-diff-added">,</span><span class="org-whitespace-space"> </span><span class="org-diff-added">pic_irq);</span></code>
<code><span class="org-whitespace-indentation">    </span><span class="org-whitespace-space"> </span><span class="org-diff-context">}</span></code>
<code></code>
<code><span class="org-whitespace-indentation">    </span><span class="org-whitespace-space"> </span>for<span class="org-whitespace-space"> </span>(i<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;<span class="org-whitespace-space"> </span>i<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>NUM_VIRTIO_TRANSPORT;<span class="org-whitespace-space"> </span>i++)<span class="org-whitespace-space"> </span>{</code>
</pre>
</div>

<p>
这样改qemu可以启动，但是在访问virtio设备device内存时会失败<br>
</p>

<p>
为什么virtio device mmio访问不了？<br>
这个和xlnx-versal-virt平台的qemu实现有关系.<br>
</p>

<ol class="org-ol">
<li>sysbus_mmio_map会将设备的mmio地址段映射到system_memory中，这个是个全剧变量。<br></li>
<li><p>
xlnx-versal-virt在cpu初始化时，系统设置cpu访问到的内存空间为<br>
Versal.fpd.apu.mr这个自定义的memory region, 见下面的代码片段.<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">versal_create_apu_cpus</span>(<span class="org-type">Versal</span> *<span class="org-variable-name">s</span>)</code>
<code>{</code>
<code>    <span class="org-type">int</span> <span class="org-variable-name">i</span>;</code>
<code></code>
<code>    <span class="org-keyword">for</span> (i = 0; i &lt; ARRAY_SIZE(s-&gt;fpd.apu.cpu); i++) {</code>
<code>        <span class="org-type">Object</span> *<span class="org-variable-name">obj</span>;</code>
<code></code>
<code>        object_initialize_child(OBJECT(s), <span class="org-string">"apu-cpu[*]"</span>, &amp;s-&gt;fpd.apu.cpu[i],</code>
<code>                    XLNX_VERSAL_ACPU_TYPE);</code>
<code>        obj = OBJECT(&amp;s-&gt;fpd.apu.cpu[i]);</code>
<code>        object_property_set_int(obj, <span class="org-string">"psci-conduit"</span>, s-&gt;cfg.psci_conduit,</code>
<code>                    &amp;error_abort);</code>
<code>        <span class="org-keyword">if</span> (i) {</code>
<code>            <span class="org-comment-delimiter">/* </span><span class="org-comment">Secondary CPUs start in PSCI powered-down state</span><span class="org-comment-delimiter"> */</span></code>
<code>            object_property_set_bool(obj, <span class="org-string">"start-powered-off"</span>, <span class="org-constant">true</span>,</code>
<code>                        &amp;error_abort);</code>
<code>        }</code>
<code></code>
<code>        object_property_set_int(obj, <span class="org-string">"core-count"</span>, ARRAY_SIZE(s-&gt;fpd.apu.cpu),</code>
<code>                    &amp;error_abort);</code>
<code>        object_property_set_link(obj, <span class="org-string">"memory"</span>, OBJECT(&amp;s-&gt;fpd.apu.mr),</code>
<code>                    &amp;error_abort);</code>
<code>        qdev_realize(DEVICE(obj), <span class="org-constant">NULL</span>, &amp;error_fatal);</code>
<code>    }</code>
<code>}</code>
</pre>
</div></li>
<li><p>
xlnx-versal-virt在处理system_memory时，将Versal.fpd.apu.mr设置为system_memory的子region.<br>
从xlnx的代码中可知，在这个平台上,Versal.fpd.apu.mr是system_memory的子region，这样，aarch64的CPU自然就没有办法访问到system_memory中的virtio外设<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>了<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span class="org-comment-delimiter">/* </span><span class="org-comment">Make the APU cpu address space visible to virtio and other</span></code>
<code><span class="org-comment"> * modules unaware of muliple address-spaces.</span><span class="org-comment-delimiter">  */</span></code>
<code><span class="org-function-name">memory_region_add_subregion_overlap</span>(<span class="org-type">get_system_memory</span>(),</code>
<code>                0, &amp;s-&gt;soc.fpd.apu.mr, 0);</code>
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-org9daaa14" class="outline-3">
<h3 id="org9daaa14">不太OK的解决方案</h3>
<div class="outline-text-3" id="text-org9daaa14">
<p>
既然上边两个看起来ok的解决方案都有问题，那么就用个不太好的解决方案吧。<br>
</p>
<div class="org-src-container">
<pre class="src src-diff"><code><span class="org-diff-context">modified</span><span class="org-whitespace-space">   </span><span class="org-diff-context">hw/arm/xlnx-versal-virt.c</span></code>
<code><span class="org-diff-hunk-header">@@</span><span class="org-whitespace-space"> </span><span class="org-diff-hunk-header">-490,6</span><span class="org-whitespace-space"> </span><span class="org-diff-hunk-header">+490,7</span><span class="org-whitespace-space"> </span><span class="org-diff-hunk-header">@@</span><span class="org-whitespace-space"> </span><span class="org-diff-function">static</span><span class="org-whitespace-space"> </span><span class="org-diff-function">void</span><span class="org-whitespace-space"> </span><span class="org-diff-function">create_virtio_regions(VersalVirt</span><span class="org-whitespace-space"> </span><span class="org-diff-function">*s)</span></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span><span class="org-diff-context">object_property_add_child(OBJECT(&amp;s-&gt;soc),</span><span class="org-whitespace-space"> </span><span class="org-diff-context">name,</span><span class="org-whitespace-space"> </span><span class="org-diff-context">OBJECT(dev));</span></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span><span class="org-diff-context">sysbus_realize_and_unref(SYS_BUS_DEVICE(dev),</span><span class="org-whitespace-space"> </span><span class="org-diff-context">&amp;error_fatal);</span></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span><span class="org-diff-context">sysbus_connect_irq(SYS_BUS_DEVICE(dev),</span><span class="org-whitespace-space"> </span><span class="org-diff-context">0,</span><span class="org-whitespace-space"> </span><span class="org-diff-context">pic_irq);</span></code>
<code><span class="org-diff-indicator-added">+</span><span class="org-whitespace-space">        </span><span class="org-diff-added">SYS_BUS_DEVICE(dev)-&gt;mmio[0].addr</span><span class="org-whitespace-space"> </span><span class="org-diff-added">=</span><span class="org-whitespace-space"> </span><span class="org-diff-added">base;</span></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span><span class="org-diff-context">mr</span><span class="org-whitespace-space"> </span><span class="org-diff-context">=</span><span class="org-whitespace-space"> </span><span class="org-diff-context">sysbus_mmio_get_region(SYS_BUS_DEVICE(dev),</span><span class="org-whitespace-space"> </span><span class="org-diff-context">0);</span></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span><span class="org-diff-context">memory_region_add_subregion(&amp;s-&gt;soc.mr_ps,</span><span class="org-whitespace-space"> </span><span class="org-diff-context">base,</span><span class="org-whitespace-space"> </span><span class="org-diff-context">mr);</span></code>
<code><span class="org-whitespace-indentation">        </span><span class="org-whitespace-space"> </span>g_free(name);</code>
</pre>
</div>
<p>
看起来这里直接修改了对应subsys的mmio addr，这也是无奈之举，其实这个平台上只是需要设置好这个地址就可以了。<br>
</p>
</div>
</div>

<div id="outline-container-org3ec61f4" class="outline-3">
<h3 id="org3ec61f4">提交的qemu中的解决方案</h3>
<div class="outline-text-3" id="text-org3ec61f4">
<p>
经过一番交流，终于提交了合适的解决方案<br>
<a href="https://lists.nongnu.org/archive/html/qemu-devel/2021-02/msg07826.html">https://lists.nongnu.org/archive/html/qemu-devel/2021-02/msg07826.html</a><br>
<a href="https://patchew.org/QEMU/20210225053606.385884-1-schspa@gmail.com/">https://patchew.org/QEMU/20210225053606.385884-1-schspa@gmail.com/</a><br>
</p>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">sysbus_create_simple将virtio的内存区域注册到了system_memory中了</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="✨💬✨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">虚怀乃若谷，水深则流缓。</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>