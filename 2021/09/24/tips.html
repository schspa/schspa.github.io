<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-03-23 Wed 17:05 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ASM language tips</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Schspa">
<meta name="description" content="ASM language tips"
>
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content">
<h1 class="title">ASM language tips</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgcbe7554">Position-independent Call</a></li>
<li><a href="#orgfa5cb66">inline asm</a>
<ul>
<li><a href="#org8248998">assembler template</a></li>
<li><a href="#org41bcecc">output operands</a></li>
<li><a href="#org32109c5">input operands</a></li>
<li><a href="#org8ad62a3">list of clobbered registers</a></li>
</ul>
</li>
<li><a href="#orgfdad0ab">inline asm example</a></li>
<li><a href="#org489c847">refs</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgcbe7554" class="outline-2">
<h2 id="orgcbe7554">Position-independent Call</h2>
<div class="outline-text-2" id="text-orgcbe7554">
<p>
ä¸‹é¢è¿™ä¸ªç‰‡æ®µå¾ˆæœ‰æ„æ€ï¼Œåˆ©ç”¨ldræŒ‡ä»¤æ¥è°ƒæ•´pcæŒ‡é’ˆä½ç½®ï¼Œæ¥æ›²çº¿å®ç°PIE<br>
<a href="https://github.com/OP-TEE/optee_os/tree/1c832d7c41cdb2f617bffa74c3d70f7c4a5667fc/core/arch/arm/kernel/generic_entry_a64.S#L28">https://github.com/OP-TEE/optee_os/tree/1c832d7c41cdb2f617bffa74c3d70f7c4a5667fc/core/arch/arm/kernel/generic_entry_a64.S#L28</a><br>
</p>
<div class="org-src-container">
<pre class="src src-asm"><code><span style="color: #51afef;">.macro</span> readjust_pc</code>
<code><span style="color: #51afef; font-weight: bold;">#ifdef</span> <span style="color: #dcaeea;">CFG_CORE_ASLR</span></code>
<code><span style="color: #c678dd;">ldr</span> <span style="color: #51afef;">x16</span>, =1111f</code>
<code><span style="color: #c678dd;">br</span>  <span style="color: #51afef;">x16</span></code>
<code><span style="color: #c678dd;">1111</span>:</code>
<code><span style="color: #51afef; font-weight: bold;">#endif</span></code>
<code><span style="color: #51afef;">.endm</span></code>
<code></code>
<code><span style="color: #c678dd;">LOCAL_FUNC</span> <span style="color: #51afef;">vector</span>_std_smc_entry , : , .identity_map</code>
<code><span style="color: #c678dd;">readjust_pc</span></code>
<code><span style="color: #c678dd;">bl</span>  <span style="color: #51afef;">thread</span>_handle_std_smc</code>
<code><span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;"> * Normally thread_handle_std_smc() should return via</span></code>
<code><span style="color: #5B6268;"> * thread_exit(), thread_rpc(), but if thread_handle_std_smc()</span></code>
<code><span style="color: #5B6268;"> * hasn't switched stack (error detected) it will do a normal "C"</span></code>
<code><span style="color: #5B6268;"> * return.</span></code>
<code><span style="color: #5B6268;"> */</span></code>
<code><span style="color: #c678dd;">mov</span> <span style="color: #51afef;">w1</span>, w0</code>
<code><span style="color: #c678dd;">ldr</span> <span style="color: #51afef;">x0</span>, =TEESMC_OPTEED_RETURN_CALL_DONE</code>
<code><span style="color: #c678dd;">smc</span> #0</code>
<code><span style="color: #c678dd;">b</span>   .   <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">SMC should not return */</span></code>
<code><span style="color: #c678dd;">END_FUNC</span> <span style="color: #51afef;">vector</span>_std_smc_entry</code>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfa5cb66" class="outline-2">
<h2 id="orgfa5cb66">inline asm</h2>
<div class="outline-text-2" id="text-orgfa5cb66">
<p>
ä¸‹é¢å°±æ˜¯å†…è”æ±‡ç¼–çš„åŸå‹å®šä¹‰äº†ï¼Œå…±ç”±4éƒ¨ä»½ç»„æˆï¼Œè§å¦‚ä¸‹<br>
</p>
<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #51afef;">asm</span> ( <span style="color: #ECBE7B;">assembler</span> <span style="color: #dcaeea;">template</span></code>
<code>    : output operands                  <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">optional</span><span style="color: #5B6268;"> */</span></code>
<code>    : input operands                   <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">optional</span><span style="color: #5B6268;"> */</span></code>
<code>    : list of clobbered registers      <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">optional</span><span style="color: #5B6268;"> */</span></code>
<code>);</code>
</pre>
</div>
</div>

<div id="outline-container-org8248998" class="outline-3">
<h3 id="org8248998">assembler template</h3>
<div class="outline-text-3" id="text-org8248998">
<p>
è¿™ä¸ªéƒ¨ä»½ç”¨æ¥å†™æ±‡ç¼–ä»£ç çš„æ¨¡æ¿, ç¼–å†™çš„æ¨¡æ¿ä¼šç”¨æ¥ç»™æ±‡ç¼–å™¨ç”Ÿæˆæœ€ç»ˆçš„ä»£ç <br>
</p>
</div>
</div>

<div id="outline-container-org41bcecc" class="outline-3">
<h3 id="org41bcecc">output operands</h3>
<div class="outline-text-3" id="text-org41bcecc">
<p>
è¾“å‡ºå‚æ•°åˆ—è¡¨<br>
</p>
</div>
</div>

<div id="outline-container-org32109c5" class="outline-3">
<h3 id="org32109c5">input operands</h3>
<div class="outline-text-3" id="text-org32109c5">
<p>
è¾“å…¥å‚æ•°åˆ—è¡¨<br>
</p>
</div>
</div>

<div id="outline-container-org8ad62a3" class="outline-3">
<h3 id="org8ad62a3">list of clobbered registers</h3>
<div class="outline-text-3" id="text-org8ad62a3">
<p>
åœ¨æ±‡ç¼–ä»£ç ä¸­ä½¿ç”¨åˆ°çš„ä¸´æ—¶å¯„å­˜å™¨éœ€è¦åœ¨æ­¤å¤„åˆ—å‡ºæ¥, ç”¨æ¥å‘Šè¯‰Cç¼–è¯‘å™¨æ±‡ç¼–ä»£ç ä¸­ä¼šä½¿ç”¨åˆ°åˆ—è¡¨ä¸­çš„å¯„å­˜å™¨ã€‚<br>
</p>
</div>
</div>
</div>

<div id="outline-container-orgfdad0ab" class="outline-2">
<h2 id="orgfdad0ab">inline asm example</h2>
<div class="outline-text-2" id="text-orgfdad0ab">
<div class="org-src-container">
<pre class="src src-C" id="orgb3b1c11"><code><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;stdint.h&gt;</span></code>
<code></code>
<code><span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">smc_writel</span>(<span style="color: #ECBE7B;">uint32_t</span> <span style="color: #dcaeea;">reg</span>, <span style="color: #ECBE7B;">uint32_t</span> <span style="color: #dcaeea;">value</span>)</code>
<code>{</code>
<code>    <span style="color: #51afef;">register</span> <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> <span style="color: #c678dd;">reg0</span> <span style="color: #51afef;">asm</span>(<span style="color: #98be65;">"r0"</span>) = 0x82000009;</code>
<code>    <span style="color: #51afef;">register</span> <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> <span style="color: #c678dd;">reg1</span> <span style="color: #51afef;">asm</span>(<span style="color: #98be65;">"r1"</span>) = 1;</code>
<code>    <span style="color: #51afef;">register</span> <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> <span style="color: #c678dd;">reg2</span> <span style="color: #51afef;">asm</span>(<span style="color: #98be65;">"r2"</span>) = reg;</code>
<code>    <span style="color: #51afef;">register</span> <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> <span style="color: #c678dd;">reg3</span> <span style="color: #51afef;">asm</span>(<span style="color: #98be65;">"r3"</span>) = value;</code>
<code>    <span style="color: #51afef;">asm</span> <span style="color: #51afef;">volatile</span>(<span style="color: #98be65;">"smc #0\n\t"</span> :<span style="color: #98be65;">"+r"</span> (reg0), <span style="color: #98be65;">"+r"</span> (reg1), <span style="color: #98be65;">"+r"</span> (reg2), <span style="color: #98be65;">"+r"</span> (reg3));</code>
<code>}</code>
<code></code>
<code><span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>(<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">argc</span>, <span style="color: #ECBE7B;">char</span> *<span style="color: #dcaeea;">argv</span>[])</code>
<code>{</code>
<code>    smc_writel(0x40000000, 0x1);</code>
<code>    <span style="color: #51afef;">return</span> 0;</code>
<code>}</code>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><code>Dump of <span style="color: #ECBE7B;">assembler</span> <span style="color: #dcaeea;">code</span> <span style="color: #51afef;">for</span> function smc_writel:</code>
<code>./test.c:</code>
<code>4       {</code>
<code>5           <span style="color: #51afef;">register</span> <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> reg0 <span style="color: #51afef;">asm</span>(<span style="color: #98be65;">"r0"</span>) = 0x82000009;</code>
<code>   0x000000000040059c &lt;+0&gt;:     e2 03 00 2a     mov     w2, w0</code>
<code>   0x00000000004005a0 &lt;+4&gt;:     20 01 80 d2     mov     x0, #0x9                        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">#9</span></code>
<code>   0x00000000004005a4 &lt;+8&gt;:     e3 03 01 2a     mov     w3, w1</code>
<code>   0x00000000004005a8 &lt;+12&gt;:    00 40 b0 f2     movk    x0, #0x8200, lsl #16</code>
<code></code>
<code>6           <span style="color: #51afef;">register</span> <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> reg1 <span style="color: #51afef;">asm</span>(<span style="color: #98be65;">"r1"</span>) = 1;</code>
<code>   0x00000000004005ac &lt;+16&gt;:    21 00 80 d2     mov     x1, #0x1                        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">#1</span></code>
<code></code>
<code>7           <span style="color: #51afef;">register</span> <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> reg2 <span style="color: #51afef;">asm</span>(<span style="color: #98be65;">"r2"</span>) = reg;</code>
<code>8           <span style="color: #51afef;">register</span> <span style="color: #ECBE7B;">unsigned</span> <span style="color: #ECBE7B;">long</span> reg3 <span style="color: #51afef;">asm</span>(<span style="color: #98be65;">"r3"</span>) = value;</code>
<code>9           <span style="color: #51afef;">asm</span> <span style="color: #51afef;">volatile</span>(<span style="color: #98be65;">"smc #0\n\t"</span> :<span style="color: #98be65;">"+r"</span> (reg0), <span style="color: #98be65;">"+r"</span> (reg1), <span style="color: #98be65;">"+r"</span> (reg2), <span style="color: #98be65;">"+r"</span> (reg3));</code>
<code>   0x00000000004005b0 &lt;+20&gt;:    03 00 00 d4     smc     #0x0</code>
<code>   0x00000000004005b4 &lt;+24&gt;:    c0 03 5f d6     ret</code>
<code>End of assembler dump.</code>
</pre>
</div>
</div>
</div>

<div id="outline-container-org489c847" class="outline-2">
<h2 id="org489c847">refs</h2>
<div class="outline-text-2" id="text-org489c847">
<p>
<a href="http://www.ethernut.de/en/documents/arm-inline-asm.html">http://www.ethernut.de/en/documents/arm-inline-asm.html</a><br>
<a href="https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html">https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html</a><br>
<a href="https://github.com/llvm-mirror/clang/blob/master/test/CodeGen/aarch64-inline-asm.c">https://github.com/llvm-mirror/clang/blob/master/test/CodeGen/aarch64-inline-asm.c</a><br>
<a href="https://developer.arm.com/documentation/100067/0610/armclang-Inline-Assembler/Inline-assembly-statements-within-a-function/Clobber-list">https://developer.arm.com/documentation/100067/0610/armclang-Inline-Assembler/Inline-assembly-statements-within-a-function/Clobber-list</a><br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
