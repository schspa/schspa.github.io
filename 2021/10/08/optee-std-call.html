<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-03-03 Thu 11:47 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OPTEE std call process</title>
<meta name="author" content="Schspa" />
<meta name="description" content="OPTEE std call process" />
<meta name="generator" content="Org Mode" />
<link rel="shortcut icon" href="/images/rose-red.png" type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" integrity="sha256-sAcc18zvMnaJZrNT4v8J0T4HqzEUiUTlVFgDIywjQek=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/animate.min.css" />
<link rel="stylesheet" href="/css/all.min.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/navbar.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js" integrity="sha256-/hGxZHGQ57fXLp+NDusFZsZo/PG21Bp2+hXYV5a6w+g=" crossorigin="anonymous"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/darkreader.js"></script>
<script src="/user.config.js"></script>
<script src="/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div class="mobile-container">
  <!-- Top Navigation Menu -->
  <div class="topnav">
    <div id="header">
      <a href="/" class="logo">Schspa's Blog</a>
      <a href="javascript:void(0);" class="icon" onclick="toggleheader()">
        <i class="fa fa-bars"></i>
      </a>
    </div>
    <div id="nav_headers">
      <a href="/sitemap.html" class="menu-item">Categories</a>
    </div>
  </div>
  <!-- End smartphone / tablet look -->
</div>

<header id="header" class="header">
  <div class="logo-wrapper">
    <a href="/" class="logo">Schspa's Blogs</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li>
      <li class="menu-item">
        <a class="menu-item-link" href="/sitemap.html">Categories</a>
      </li>
    </ul>
  </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">OPTEE std call process</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf2bddcd">Example Code</a></li>
<li><a href="#org58366b3">std call process</a></li>
<li><a href="#org68fb327">optee data struct</a></li>
</ul>
</div>
</div>
<p>
OPTEE ä¸»è¦é€šè¿‡std callçš„æ–¹å¼æ¥ç»™non-secure worldæ¥æä¾›æœåŠ¡ï¼Œåœ¨æœ¬æ–‡ä¸­ä¸»è¦ç ”ç©¶ä¸€ä¸‹è¿™ä¸ªæœåŠ¡å¦‚ä½•å®ç°ï¼Œç»™ä»¥åçš„æ¡†æ¶è®¾è®¡æä¾›å‚è€ƒã€‚<br>
ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œä½¿ç”¨optee exampleä¸­çš„hello_worldæ¥ä½œä¸ºä¾‹å­<br>
</p>

<div id="outline-container-orgf2bddcd" class="outline-2">
<h2 id="orgf2bddcd">Example Code</h2>
<div class="outline-text-2" id="text-orgf2bddcd">
<div class="org-src-container">
<pre class="src src-C"><code><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;err.h&gt;</span></code>
<code><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;stdio.h&gt;</span></code>
<code><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;string.h&gt;</span></code>
<code></code>
<code><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">OP-TEE TEE client API (built by optee_client)</span><span style="color: #5B6268;"> */</span></code>
<code><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;tee_client_api.h&gt;</span></code>
<code></code>
<code><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">For the UUID (found in the TA's h-file(s))</span><span style="color: #5B6268;"> */</span></code>
<code><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;hello_world_ta.h&gt;</span></code>
<code></code>
<code><span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>(<span style="color: #ECBE7B;">void</span>)</code>
<code>{</code>
<code>    <span style="color: #ECBE7B;">TEEC_Result</span> <span style="color: #dcaeea;">res</span>;</code>
<code>    <span style="color: #ECBE7B;">TEEC_Context</span> <span style="color: #dcaeea;">ctx</span>;</code>
<code>    <span style="color: #ECBE7B;">TEEC_Session</span> <span style="color: #dcaeea;">sess</span>;</code>
<code>    <span style="color: #ECBE7B;">TEEC_Operation</span> <span style="color: #dcaeea;">op</span>;</code>
<code>    <span style="color: #ECBE7B;">TEEC_UUID</span> <span style="color: #dcaeea;">uuid</span> = TA_HELLO_WORLD_UUID;</code>
<code>    <span style="color: #ECBE7B;">uint32_t</span> <span style="color: #dcaeea;">err_origin</span>;</code>
<code></code>
<code>    <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Initialize a context connecting us to the TEE</span><span style="color: #5B6268;"> */</span></code>
<code>    res = TEEC_InitializeContext(<span style="color: #a9a1e1;">NULL</span>, &amp;ctx);</code>
<code>    <span style="color: #51afef;">if</span> (res != TEEC_SUCCESS)</code>
<code>        errx(1, <span style="color: #98be65;">"TEEC_InitializeContext failed with code 0x%x"</span>, res);</code>
<code></code>
<code>    <span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;">     * Open a session to the "hello world" TA, the TA will print "hello</span></code>
<code><span style="color: #5B6268;">     * world!" in the log when the session is created.</span></code>
<code><span style="color: #5B6268;">     */</span></code>
<code>    res = TEEC_OpenSession(&amp;ctx, &amp;sess, &amp;uuid,</code>
<code>                   TEEC_LOGIN_PUBLIC, <span style="color: #a9a1e1;">NULL</span>, <span style="color: #a9a1e1;">NULL</span>, &amp;err_origin);</code>
<code>    <span style="color: #51afef;">if</span> (res != TEEC_SUCCESS)</code>
<code>        errx(1, <span style="color: #98be65;">"TEEC_Opensession failed with code 0x%x origin 0x%x"</span>,</code>
<code>            res, err_origin);</code>
<code></code>
<code>    <span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;">     * Execute a function in the TA by invoking it, in this case</span></code>
<code><span style="color: #5B6268;">     * we're incrementing a number.</span></code>
<code><span style="color: #5B6268;">     *</span></code>
<code><span style="color: #5B6268;">     * The value of command ID part and how the parameters are</span></code>
<code><span style="color: #5B6268;">     * interpreted is part of the interface provided by the TA.</span></code>
<code><span style="color: #5B6268;">     */</span></code>
<code></code>
<code>    <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">Clear the TEEC_Operation struct</span><span style="color: #5B6268;"> */</span></code>
<code>    memset(&amp;op, 0, <span style="color: #51afef;">sizeof</span>(op));</code>
<code></code>
<code>    <span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;">     * Prepare the argument. Pass a value in the first parameter,</span></code>
<code><span style="color: #5B6268;">     * the remaining three parameters are unused.</span></code>
<code><span style="color: #5B6268;">     */</span></code>
<code>    op.paramTypes = TEEC_PARAM_TYPES(TEEC_VALUE_INOUT, TEEC_NONE,</code>
<code>                     TEEC_NONE, TEEC_NONE);</code>
<code>    op.params[0].value.a = 42;</code>
<code></code>
<code>    <span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;">     * TA_HELLO_WORLD_CMD_INC_VALUE is the actual function in the TA to be</span></code>
<code><span style="color: #5B6268;">     * called.</span></code>
<code><span style="color: #5B6268;">     */</span></code>
<code>    printf(<span style="color: #98be65;">"Invoking TA to increment %d\n"</span>, op.params[0].value.a);</code>
<code>    res = TEEC_InvokeCommand(&amp;sess, TA_HELLO_WORLD_CMD_INC_VALUE, &amp;op,</code>
<code>                 &amp;err_origin);</code>
<code>    <span style="color: #51afef;">if</span> (res != TEEC_SUCCESS)</code>
<code>        errx(1, <span style="color: #98be65;">"TEEC_InvokeCommand failed with code 0x%x origin 0x%x"</span>,</code>
<code>            res, err_origin);</code>
<code>    printf(<span style="color: #98be65;">"TA incremented value to %d\n"</span>, op.params[0].value.a);</code>
<code></code>
<code>    <span style="color: #5B6268;">/*</span></code>
<code><span style="color: #5B6268;">     * We're done with the TA, close the session and</span></code>
<code><span style="color: #5B6268;">     * destroy the context.</span></code>
<code><span style="color: #5B6268;">     *</span></code>
<code><span style="color: #5B6268;">     * The TA will print "Goodbye!" in the log when the</span></code>
<code><span style="color: #5B6268;">     * session is closed.</span></code>
<code><span style="color: #5B6268;">     */</span></code>
<code></code>
<code>    TEEC_CloseSession(&amp;sess);</code>
<code></code>
<code>    TEEC_FinalizeContext(&amp;ctx);</code>
<code></code>
<code>    <span style="color: #51afef;">return</span> 0;</code>
<code>}</code>
</pre>
</div>


<p>
ç”±ä¸Šé¢çš„ä»£ç å¯çŸ¥ï¼Œnon secureworldå…±éœ€è¦5æ­¥æ¥å®Œæˆæ•´ä¸ªæœåŠ¡è°ƒç”¨<br>
</p>
<ol class="org-ol">
<li>åˆå§‹åŒ–context<br></li>
<li>æ‰“å¼€session<br></li>
<li>è°ƒç”¨sessionä¸­çš„æœåŠ¡ï¼Œå‘½ä»¤<br></li>
<li>å…³é—­session<br></li>
<li>é‡Šæ”¾context<br></li>
</ol>
</div>
</div>

<div id="outline-container-org58366b3" class="outline-2">
<h2 id="org58366b3">std call process</h2>
<div class="outline-text-2" id="text-org58366b3">
<p>
ä¸‹å›¾å±•ç¤ºäº†ä¸€æ¬¡helloworldçš„è°ƒç”¨ä¸­ï¼Œç³»ç»Ÿå†…éƒ¨çš„å¤§è‡´æµç¨‹ï¼Œç”±æ­¤å›¾å¯çŸ¥ï¼Œæ¯æ¬¡ç³»ç»Ÿè¿›è¡Œtrusted worldæœåŠ¡è°ƒç”¨æ—¶ï¼Œç³»ç»Ÿéƒ½éœ€è¦è¿›å…¥smcæ¥è¿›è¡Œè¿è¡Œç¯å¢ƒçš„åˆ‡æ¢ï¼ˆaarch64è¿›è¡Œsecure/non secureçš„åˆ‡æ¢å¿…é¡»é€šè¿‡EL3æ¥å®Œæˆï¼‰<br>
</p>
<p>
<img src="assets/optee-std-call-flow.png" alt="optee-std-call-flow.png"><br>
é€šè¿‡ä¸Šé¢ç¤ºæ„å›¾å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿè°ƒç”¨trusted worldçš„æœåŠ¡æ—¶ï¼Œç³»ç»Ÿä¼šç»è¿‡æ¯”è¾ƒé•¿çš„é“¾è·¯ï¼Œä» NSEL0 -&gt; NSEL2/NSEL1 -&gt; EL3 -&gt; SEL1 -&gt; SEL0 ä¸€å…±éœ€è¦åˆ‡æ¢å¤šæ¬¡çš„cpuæ‰§è¡Œç¯å¢ƒ<br>
</p>
</div>
</div>

<div id="outline-container-org68fb327" class="outline-2">
<h2 id="org68fb327">optee data struct</h2>
<div class="outline-text-2" id="text-org68fb327">
<p>
opteeæœåŠ¡è°ƒç”¨æ—¶æ¶‰åŠå¾ˆå¤šä¸ªæ•°æ®ç»“æ„çš„ä¼ é€’ï¼Œä¸‹é¢çš„å›¾å±•ç¤ºäº†ä¸€ä¸‹open_sessionæ“ä½œæ—¶å„ä¸ªæ•°æ®ç»“æ„ä¹‹é—´çš„å¤§è‡´å…³ç³»ï¼Œåˆ†æä»£ç æ—¶å¯ä»¥ä½œä¸ºå‚è€ƒ<br>
</p>

<p>
<img src="/assets/.optee_arg_pass-1.png"><br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<script src="https://utteranc.es/client.js"
    repo="schspa/schspa.github.io"
    issue-term="title"
    label="âœ¨ğŸ’¬âœ¨"
    theme="github-light"
    crossorigin="anonymous"
    async>
</script>
<div class="me">
  <span><b>Contact me via :)</b><span>
  <div class="contact">
    <a id="email" href="mailto:schspa@gmail.com" target="_blank"><i class="fab fa-mailchimp animated heartBeat delay-2s slower"></i></a>
    <a id="github" href="//github.com/schspa" target="_blank"><i class="fab fa-github animated heartBeat delay-2s slower"></i></a>
  </div>
</div>

<div id="jinrishici-sentence" style="font-weight: 700;">è™šæ€€ä¹ƒè‹¥è°·ï¼Œæ°´æ·±åˆ™æµç¼“ã€‚</div>
<script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</div>
</body>
</html>
